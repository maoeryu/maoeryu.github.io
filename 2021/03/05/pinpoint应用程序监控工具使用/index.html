<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"maoeryu.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.2.1","exturl":false,"sidebar":{"position":"left","width":200,"display":"post","padding":7,"offset":5},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="pinpoint是开源在github上的一款apm监控工具.它是用java编写的,用于大规模分布式系统监控.有性能影响小&#x2F;无侵入的特点. pinpoint包括4模块,    模块 描述    hbase 存储监控数据   pinpoint collector 负责收集汇总agent上传的信息并持久化到hbase,单台即可   pinpoint web 负责数据可视化展示,单台即可,可与collec">
<meta property="og:type" content="article">
<meta property="og:title" content="pinpoint应用程序监控工具使用">
<meta property="og:url" content="https://maoeryu.github.io/2021/03/05/pinpoint%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="FlyingPig">
<meta property="og:description" content="pinpoint是开源在github上的一款apm监控工具.它是用java编写的,用于大规模分布式系统监控.有性能影响小&#x2F;无侵入的特点. pinpoint包括4模块,    模块 描述    hbase 存储监控数据   pinpoint collector 负责收集汇总agent上传的信息并持久化到hbase,单台即可   pinpoint web 负责数据可视化展示,单台即可,可与collec">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_1.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_2.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_3.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_4.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_5.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_6.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_7.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_8.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_9.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_10.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_11.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_12.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_13.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_14.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_15.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_16.png">
<meta property="og:image" content="https://maoeryu.github.io/images/pp_17.png">
<meta property="article:published_time" content="2021-03-04T16:00:00.000Z">
<meta property="article:modified_time" content="2022-07-26T02:56:17.926Z">
<meta property="article:author" content="maoeryu">
<meta property="article:tag" content="pinpoint">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://maoeryu.github.io/images/pp_1.png">


<link rel="canonical" href="https://maoeryu.github.io/2021/03/05/pinpoint%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>pinpoint应用程序监控工具使用 | FlyingPig</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">FlyingPig</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.1.</span> <span class="nav-text">服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDpinpoint-tomcat"><span class="nav-number">1.2.</span> <span class="nav-text">下载pinpoint&#x2F;tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96hbase%E7%9A%84pinpoint%E5%BA%93"><span class="nav-number">1.3.</span> <span class="nav-text">初始化hbase的pinpoint库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96mysql%E7%9A%84pinpoint%E5%BA%93"><span class="nav-number">1.4.</span> <span class="nav-text">初始化mysql的pinpoint库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDnginx"><span class="nav-number">1.5.</span> <span class="nav-text">下载nginx</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85pinpoint-collector"><span class="nav-number">2.</span> <span class="nav-text">安装pinpoint-collector</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8Btomcat"><span class="nav-number">2.1.</span> <span class="nav-text">解压tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%AB%AF%E5%8F%A3"><span class="nav-number">2.2.</span> <span class="nav-text">修改端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9zk"><span class="nav-number">2.3.</span> <span class="nav-text">修改zk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2ip"><span class="nav-number">2.4.</span> <span class="nav-text">替换ip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8tomcat"><span class="nav-number">2.5.</span> <span class="nav-text">启动tomcat</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85pinpoint-web"><span class="nav-number">3.</span> <span class="nav-text">安装pinpoint-web</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8Btomcat-1"><span class="nav-number">3.1.</span> <span class="nav-text">解压tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%AB%AF%E5%8F%A3-1"><span class="nav-number">3.2.</span> <span class="nav-text">修改端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.3.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E7%94%A8web-alarm%E5%8A%9F%E8%83%BD"><span class="nav-number">3.4.</span> <span class="nav-text">启用web alarm功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8tomcat-1"><span class="nav-number">3.5.</span> <span class="nav-text">启动tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E9%A1%B5%E9%9D%A2"><span class="nav-number">3.6.</span> <span class="nav-text">查看页面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85nginx"><span class="nav-number">4.</span> <span class="nav-text">安装nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8B%E5%AE%89%E8%A3%85"><span class="nav-number">4.1.</span> <span class="nav-text">解压安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEnginx"><span class="nav-number">4.2.</span> <span class="nav-text">配置nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8nginx"><span class="nav-number">4.3.</span> <span class="nav-text">启动nginx</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2pinpoint-agent"><span class="nav-number">5.</span> <span class="nav-text">部署pinpoint-agent</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8Bpinpoint-agent"><span class="nav-number">5.1.</span> <span class="nav-text">解压pinpoint-agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-number">5.2.</span> <span class="nav-text">修改配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9Ftomcat%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="nav-number">6.</span> <span class="nav-text">模拟tomcat测试环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8Btomcat-2"><span class="nav-number">6.1.</span> <span class="nav-text">解压tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="nav-number">6.2.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8B%E6%B5%8B%E8%AF%95war%E5%8C%85"><span class="nav-number">6.3.</span> <span class="nav-text">解压测试war包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E6%8E%A2%E9%92%88"><span class="nav-number">6.4.</span> <span class="nav-text">增加探针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#springboot%E9%A1%B9%E7%9B%AE"><span class="nav-number">6.5.</span> <span class="nav-text">springboot项目</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pinpint%E9%87%87%E9%9B%86%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-number">7.</span> <span class="nav-text">pinpint采集原理分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84%E7%BB%84%E6%88%90"><span class="nav-number">7.1.</span> <span class="nav-text">架构组成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinpoint%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">7.2.</span> <span class="nav-text">pinpoint数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinpoint-agent"><span class="nav-number">7.3.</span> <span class="nav-text">pinpoint-agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ProfilerPlugin%E6%8F%92%E4%BB%B6%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">7.4.</span> <span class="nav-text">ProfilerPlugin插件工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinpoint-collector"><span class="nav-number">7.5.</span> <span class="nav-text">pinpoint-collector</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%AE%95%E6%9C%BA%E6%B5%8B%E8%AF%95"><span class="nav-number">8.</span> <span class="nav-text">集群宕机测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pinpoint-collector-1"><span class="nav-number">8.1.</span> <span class="nav-text">pinpoint-collector</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">maoeryu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">221</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://maoeryu.github.io/2021/03/05/pinpoint%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="maoeryu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlyingPig">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pinpoint应用程序监控工具使用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-03-05 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-05T00:00:00+08:00">2021-03-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-07-26 10:56:17" itemprop="dateModified" datetime="2022-07-26T10:56:17+08:00">2022-07-26</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>pinpoint是开源在github上的一款apm监控工具.<br>它是用java编写的,用于大规模分布式系统监控.<br>有性能影响小/无侵入的特点.</p>
<p>pinpoint包括4模块,</p>
<table>
<thead>
<tr>
<th align="left">模块</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">hbase</td>
<td align="left">存储监控数据</td>
</tr>
<tr>
<td align="left">pinpoint collector</td>
<td align="left">负责收集汇总agent上传的信息并持久化到hbase,单台即可</td>
</tr>
<tr>
<td align="left">pinpoint web</td>
<td align="left">负责数据可视化展示,单台即可,可与collector部署到1台服务器</td>
</tr>
<tr>
<td align="left">pinpoint agent</td>
<td align="left">数据采集端,部署项目的服务器均需部署</td>
</tr>
</tbody></table>
<span id="more"></span>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><p>web/nginx:172.18.250.96<br>collector:172.18.250.94-96,部署3台,使用nginx负载均衡<br>agent/tomcat:172.18.250.96<br>hbase/zk集群:172.18.250.100-102<br>mysql:172.18.250.108</p>
<h3 id="下载pinpoint-tomcat"><a href="#下载pinpoint-tomcat" class="headerlink" title="下载pinpoint/tomcat"></a>下载pinpoint/tomcat</h3><p><a target="_blank" rel="noopener" href="https://github.com/naver/pinpoint/releases/tag/v2.0.2">https://github.com/naver/pinpoint/releases/tag/v2.0.2</a></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.55/bin/apache-tomcat-8.5.55.tar.gz">https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.55/bin/apache-tomcat-8.5.55.tar.gz</a></p>
<p>将以下4个包上传至服务器,<br>pinpoint-web-2.0.2.war<br>pinpoint-collector-2.0.2.war<br>pinpoint-agent-2.0.2.tar.gz<br>apache-tomcat-8.5.55.tar.gz</p>
<h3 id="初始化hbase的pinpoint库"><a href="#初始化hbase的pinpoint库" class="headerlink" title="初始化hbase的pinpoint库"></a>初始化hbase的pinpoint库</h3><p>下载hbase脚本,<br><a target="_blank" rel="noopener" href="https://github.com/naver/pinpoint/tree/v2.0.2/hbase/scripts/hbase-create.hbase">https://github.com/naver/pinpoint/tree/v2.0.2/hbase/scripts/hbase-create.hbase</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbase shell .&#x2F;hbase-create.hbase</span><br></pre></td></tr></table></figure>

<h3 id="初始化mysql的pinpoint库"><a href="#初始化mysql的pinpoint库" class="headerlink" title="初始化mysql的pinpoint库"></a>初始化mysql的pinpoint库</h3><p>下载脚本,新建pinpoint数据库,执行建表语句.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/naver/pinpoint/blob/v2.0.2/web/src/main/resources/sql/CreateTableStatement-mysql.sql">https://github.com/naver/pinpoint/blob/v2.0.2/web/src/main/resources/sql/CreateTableStatement-mysql.sql</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/naver/pinpoint/blob/v2.0.2/web/src/main/resources/sql/SpringBatchJobRepositorySchema-mysql.sql">https://github.com/naver/pinpoint/blob/v2.0.2/web/src/main/resources/sql/SpringBatchJobRepositorySchema-mysql.sql</a></p>
<h3 id="下载nginx"><a href="#下载nginx" class="headerlink" title="下载nginx"></a>下载nginx</h3><p><a target="_blank" rel="noopener" href="http://nginx.org/en/download.html">http://nginx.org/en/download.html</a></p>
<h2 id="安装pinpoint-collector"><a href="#安装pinpoint-collector" class="headerlink" title="安装pinpoint-collector"></a>安装pinpoint-collector</h2><h3 id="解压tomcat"><a href="#解压tomcat" class="headerlink" title="解压tomcat"></a>解压tomcat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv apache-tomcat-8.5.55 pp-col</span><br><span class="line">rm -rf pp-col/webapps/*</span><br><span class="line">unzip /data/xxx/pinpoint-collector-2.0.2.war -d pp-col/webapps/ROOT</span><br></pre></td></tr></table></figure>

<h3 id="修改端口"><a href="#修改端口" class="headerlink" title="修改端口"></a>修改端口</h3><p>修改collect的tomcat端口,在原端口前加1,避免与pinpoint-web的冲突.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> pp-col/conf/</span><br><span class="line">sed -i <span class="string">&#x27;s/port=&quot;8005&quot;/port=&quot;18005&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&#x27;s/port=&quot;8080&quot;/port=&quot;18080&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&#x27;s/port=&quot;8443&quot;/port=&quot;18443&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&#x27;s/port=&quot;8009&quot;/port=&quot;18009&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&#x27;s/redirectPort=&quot;8443&quot;/redirectPort=&quot;18443&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&quot;s/localhost/`ifconfig eth0 | grep &#x27;inet addr&#x27; | awk &#x27;&#123;print <span class="variable">$2</span>&#125;&#x27; | awk -F: &#x27;&#123;print <span class="variable">$2</span>&#125;&#x27;`/g&quot;</span> server.xml</span><br></pre></td></tr></table></figure>

<h3 id="修改zk"><a href="#修改zk" class="headerlink" title="修改zk"></a>修改zk</h3><p>修改配置文件中zk地址,改为zk集群地址.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim webapps/ROOT/WEB-INF/classes/pinpoint-collector.properties</span><br><span class="line">pinpoint.zookeeper.address=xxx</span><br><span class="line"></span><br><span class="line">vim webapps/ROOT/WEB-INF/classes/profiles/release/pinpoint-collector-env.properties</span><br><span class="line">pinpoint.zookeeper.address=xxx</span><br></pre></td></tr></table></figure>

<h3 id="替换ip"><a href="#替换ip" class="headerlink" title="替换ip"></a>替换ip</h3><p>分别替换3台collector配置文件中的ip,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;classes&#x2F;pinpoint-collector.properties</span><br></pre></td></tr></table></figure>

<p>将0.0.0.0替换成{ip},同时修改以下内容,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cluster.listen.ip&#x3D;&#123;ip&#125;</span><br><span class="line">cluster.listen.port&#x3D;9090</span><br></pre></td></tr></table></figure>

<h3 id="启动tomcat"><a href="#启动tomcat" class="headerlink" title="启动tomcat"></a>启动tomcat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pp-col&#x2F;bin&#x2F;startup.sh</span><br></pre></td></tr></table></figure>

<p>查看启动日志pp-col/logs/catalina.out,出现<br>org.apache.catalina.startup.Catalina.start Server startup in xxx ms<br>说明启动成功.</p>
<h2 id="安装pinpoint-web"><a href="#安装pinpoint-web" class="headerlink" title="安装pinpoint-web"></a>安装pinpoint-web</h2><h3 id="解压tomcat-1"><a href="#解压tomcat-1" class="headerlink" title="解压tomcat"></a>解压tomcat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv apache-tomcat-8.5.55 pp-web</span><br><span class="line">rm -rf pp-web/webapps/*</span><br><span class="line">unzip /data/xxx/pinpoint-web-2.0.2.war -d pp-web/webapps/ROOT</span><br></pre></td></tr></table></figure>

<h3 id="修改端口-1"><a href="#修改端口-1" class="headerlink" title="修改端口"></a>修改端口</h3><p>修改web的tomcat端口,在原端口前加2,避免与pinpoint-collector的冲突.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> pp-web/conf/</span><br><span class="line">sed -i <span class="string">&#x27;s/port=&quot;8005&quot;/port=&quot;28005&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&#x27;s/port=&quot;8080&quot;/port=&quot;28080&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&#x27;s/port=&quot;8443&quot;/port=&quot;28443&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&#x27;s/port=&quot;8009&quot;/port=&quot;28009&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&#x27;s/redirectPort=&quot;8443&quot;/redirectPort=&quot;28443&quot;/g&#x27;</span> server.xml</span><br><span class="line">sed -i <span class="string">&quot;s/localhost/`ifconfig eth0 | grep &#x27;inet addr&#x27; | awk &#x27;&#123;print <span class="variable">$2</span>&#125;&#x27; | awk -F: &#x27;&#123;print <span class="variable">$2</span>&#125;&#x27;`/g&quot;</span> server.xml</span><br></pre></td></tr></table></figure>

<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>修改zk地址,改为zk集群地址,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;classes&#x2F;pinpoint-web.properties</span><br><span class="line">pinpoint.zookeeper.address&#x3D;master2</span><br><span class="line"></span><br><span class="line">vim webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;classes&#x2F;profiles&#x2F;release&#x2F;pinpoint-web-env.properties</span><br><span class="line">pinpoint.zookeeper.address&#x3D;master2</span><br></pre></td></tr></table></figure>

<p>修改pinpoint collector集群ip地址,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;classes&#x2F;pinpoint-web.properties</span><br><span class="line">cluster.connect.address&#x3D;172.18.250.94:9090,172.18.250.95:9090,172.18.250.96:9090</span><br></pre></td></tr></table></figure>

<h3 id="启用web-alarm功能"><a href="#启用web-alarm功能" class="headerlink" title="启用web alarm功能"></a>启用web alarm功能</h3><p>pinpoint自身监控/账户信息会写入mysql,需要修改配置文件中mysql ip/host/user/pw.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;classes&#x2F;jdbc.properties</span><br></pre></td></tr></table></figure>

<h3 id="启动tomcat-1"><a href="#启动tomcat-1" class="headerlink" title="启动tomcat"></a>启动tomcat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pp-web&#x2F;bin&#x2F;startup.sh</span><br></pre></td></tr></table></figure>

<p>查看启动日志pp-col/logs/catalina.out,出现<br>org.apache.catalina.startup.Catalina.start Server startup in xxx ms<br>说明启动成功.</p>
<h3 id="查看页面"><a href="#查看页面" class="headerlink" title="查看页面"></a>查看页面</h3><p>访问<a target="_blank" rel="noopener" href="http://hadoop-sh1-core4:28080/">http://hadoop-sh1-core4:28080/</a></p>
<h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><h3 id="解压安装"><a href="#解压安装" class="headerlink" title="解压安装"></a>解压安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar xzf nginx-1.12.2.tar.gz</span><br><span class="line">useradd nginx</span><br><span class="line">yum -y install gcc gcc-c++ automake pcre pcre-devel zlip zlib-devel openssl openssl-devel</span><br><span class="line">cd nginx-1.12.2</span><br><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx --conf-path&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;lock&#x2F;nginx.lock --user&#x3D;nginx --group&#x3D;nginx --with-http_ssl_module --with-http_stub_status_module --with-http_gzip_static_module --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;tmp&#x2F;nginx&#x2F;client&#x2F; --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;tmp&#x2F;nginx&#x2F;proxy&#x2F; --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;tmp&#x2F;nginx&#x2F;fcgi&#x2F; --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;tmp&#x2F;nginx&#x2F;uwsgi --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;tmp&#x2F;nginx&#x2F;scgi --with-pcre --with-stream --with-stream_ssl_module</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h3 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#配置TCP和UDP负载均衡</span><br><span class="line">stream &#123;</span><br><span class="line">proxy_protocol_timeout 120s;</span><br><span class="line">log_format  main  &#39;$remote_addr $remote_port - [$time_local] &#39;</span><br><span class="line">&#39;$status $bytes_sent $protocol $server_addr $server_port&#39;</span><br><span class="line">&#39;$proxy_protocol_addr $proxy_protocol_port&#39;;</span><br><span class="line">access_log &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log main;</span><br><span class="line"></span><br><span class="line">upstream 9994_tcp_upstreams &#123;</span><br><span class="line">server 172.18.250.94:9994;</span><br><span class="line">server 172.18.250.95:9994;</span><br><span class="line">server 172.18.250.96:9994;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream 9995_udp_upstreams &#123;</span><br><span class="line">server 172.18.250.94:9995;</span><br><span class="line">server 172.18.250.95:9995;</span><br><span class="line">server 172.18.250.96:9995;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream 9996_udp_upstreams &#123;</span><br><span class="line">server 172.18.250.94:9996;</span><br><span class="line">server 172.18.250.95:9996;</span><br><span class="line">server 172.18.250.96:9996;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">listen 19994;</span><br><span class="line">proxy_pass 9994_tcp_upstreams;</span><br><span class="line">proxy_connect_timeout 5s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">listen 19995 udp;</span><br><span class="line">proxy_pass 9995_udp_upstreams;</span><br><span class="line">proxy_timeout 1s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">listen 19996 udp;</span><br><span class="line">proxy_pass 9996_udp_upstreams;</span><br><span class="line">proxy_timeout 1s;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./sbin/nginx</span><br><span class="line">netstat –anp | grep 19994</span><br></pre></td></tr></table></figure>

<h2 id="部署pinpoint-agent"><a href="#部署pinpoint-agent" class="headerlink" title="部署pinpoint-agent"></a>部署pinpoint-agent</h2><h3 id="解压pinpoint-agent"><a href="#解压pinpoint-agent" class="headerlink" title="解压pinpoint-agent"></a>解压pinpoint-agent</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xzf pinpoint-agent-2.0.2.tar.gz</span><br><span class="line">mv pinpoint-agent-2.0.2 pp-agent</span><br></pre></td></tr></table></figure>

<h3 id="修改配置文件-1"><a href="#修改配置文件-1" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>修改pinpoint-collector的ip,改为ngix的ip和port,</p>
<p>vim pinpoint.config<br>profiler.collector.ip=172.18.250.96<br>profiler.collector.span.port=19996<br>profiler.collector.stat.port=19995<br>profiler.collector.tcp.port=19994</p>
<p>vim profiles/release/pinpoint-env.config</p>
<p>修改传输模块,<br>profiler.transport.module=THRIFT</p>
<h2 id="模拟tomcat测试环境"><a href="#模拟tomcat测试环境" class="headerlink" title="模拟tomcat测试环境"></a>模拟tomcat测试环境</h2><h3 id="解压tomcat-2"><a href="#解压tomcat-2" class="headerlink" title="解压tomcat"></a>解压tomcat</h3><p>tar xzf apache-tomcat-8.5.55.tar.gz<br>mv apache-tomcat-8.5.55 pp-test</p>
<h3 id="修改配置文件-2"><a href="#修改配置文件-2" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>配置localhost让外部访问,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd conf</span><br><span class="line">sed -i &quot;s&#x2F;localhost&#x2F;&#96;ifconfig eth0 | grep &#39;inet addr&#39; | awk &#39;&#123;print $2&#125;&#39; | awk -F: &#39;&#123;print $2&#125;&#39;&#96;&#x2F;g&quot; server.xml</span><br></pre></td></tr></table></figure>

<h3 id="解压测试war包"><a href="#解压测试war包" class="headerlink" title="解压测试war包"></a>解压测试war包</h3><p>将测试war包解压到pp-test/webapps/ROOT下<br>unzip xxx.war -d pp-test/webapps/ROOT</p>
<h3 id="增加探针"><a href="#增加探针" class="headerlink" title="增加探针"></a>增加探针</h3><p>vim pp-test/bin/catalina.sh<br>在开头添加以下三行,其中,并启动tomcat,</p>
<p>-javaagent:指向agent目录下的pinpoint-bootstrap-${version}.jar.<br>-Dpinpoint.agentId:设置全局唯一标识ID.<br>-Dpinpoint.applicationName:设置项目的名称,如果同一项目部署两台实例,这两台的参数应该一致.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CATALINA_OPTS&#x3D;&quot;$CATALINA_OPTS -javaagent:&#x2F;xxx&#x2F;pp-agent&#x2F;pinpoint-bootstrap-xxx.jar&quot;</span><br><span class="line">CATALINA_OPTS&#x3D;&quot;$CATALINA_OPTS -Dpinpoint.agentId&#x3D;xxx&quot;</span><br><span class="line">CATALINA_OPTS&#x3D;&quot;$CATALINA_OPTS -Dpinpoint.applicationName&#x3D;testapp&quot;</span><br></pre></td></tr></table></figure>

<h3 id="springboot项目"><a href="#springboot项目" class="headerlink" title="springboot项目"></a>springboot项目</h3><p>springboot项目与tomcat有不同的添加方式,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xms512m -Xmx1024m -javaagent:&#x2F;data&#x2F;xxx&#x2F;pp-agent&#x2F;pinpoint-bootstrap-2.0.2.jar -Dpinpoint.agentId&#x3D;flume-monitor-web-1 -Dpinpoint.applicationName&#x3D;flume-monitor -jar flumemonitor-1.0.0.jar</span><br></pre></td></tr></table></figure>

<p>打开web页面,检查数据,</p>
<img src="/images/pp_1.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<img src="/images/pp_2.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<img src="/images/pp_3.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">


<p>测试项目被访问后,</p>
<img src="/images/pp_4.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<img src="/images/pp_5.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<img src="/images/pp_6.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<img src="/images/pp_7.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<img src="/images/pp_8.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">


<h2 id="pinpint采集原理分析"><a href="#pinpint采集原理分析" class="headerlink" title="pinpint采集原理分析"></a>pinpint采集原理分析</h2><h3 id="架构组成"><a href="#架构组成" class="headerlink" title="架构组成"></a>架构组成</h3><img src="/images/pp_9.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<h3 id="pinpoint数据结构"><a href="#pinpoint数据结构" class="headerlink" title="pinpoint数据结构"></a>pinpoint数据结构</h3><p>pinpoint消息的数据结构主要包含3种类型,</p>
<ul>
<li>Span</li>
<li>Trace</li>
<li>TraceId</li>
</ul>
<p>Span是最基本的调用追踪单元,当远程调用到达的时候,Span指代处理该调用的作业,并且携带追踪数据.<br>为了实现代码级别的可见性,Span下面还包含一层SpanEvent的数据结构.<br>每个Span都包含一个SpanId.</p>
<p>Trace是一组相互关联的Span集合,同一个Trace下的Span共享一个TransactionId,而且会按照SpanId和ParentSpanId排列成一棵有层级关系的树形结构.</p>
<p>TraceId是TransactionId/SpanId和ParentSpanId的组合.<br>TransactionId(TxId)是一个交易下的横跨整个分布式系统收发消息的ID,其必须在整个服务器组中是全局唯一的.<br>也就是说TransactionId识别了整个调用链.<br>SpanId(SpanId)是处理远程调用作业的ID,当一个调用到达一个节点的时候随即产生.<br>ParentSpanId(pSpanId)顾名思义,就是产生当前Span的调用方Span的ID.<br>如果一个节点是交易的最初发起方,其ParentSpanId是-1,以标志其是整个交易的根Span.</p>
<img src="/images/pp_10.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<h3 id="pinpoint-agent"><a href="#pinpoint-agent" class="headerlink" title="pinpoint-agent"></a>pinpoint-agent</h3><p>pinpoint通过字节码增加技术(有的叫动态探针技术),来实现无侵入式的调用链采集,其核心实现还是基于JVM的javaagent机制来实现.</p>
<p>pinpoint在启动时通过设置<br><code>-javaagent:$AGENT_PATH/pinpoint-bootstrap-$VERSION.jar</code><br>来指定pinpoint agent加载路径,在启动的时候agent将在加载应用class文件之前做拦截并修改字节码,在class方法调用的前后加上链路采集逻辑,从而实现链路采集功能.</p>
<p>javaAgent的底层机制主要依赖JVMTI,JVMTI全称JVM Tool Interface,是JVM暴露出来的一些供用户扩展的接口集合.<br>JVMTI是基于事件驱动的,JVM每执行到一定的逻辑就会调用一些事件的回调接口(如果有的话),这些接口可以供开发者扩展自己的逻辑.<br>但JVMTI都是一些接口合集,需要有接口的实现,这就用到了java的instrument,可以理解instrument是JVMTI的一种实现,为JVM提供外挂支持.</p>
<p>instrument支持启动时加载和运行时加载两种方式,分别实现JVMTI的Agent_OnLoad和Agent_OnAttach方法,pinpoint目前采用的是启动时加载方式.</p>
<img src="/images/pp_11.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<p>启动类中实现instrument规定的premain方法(PinpointBootStrap.java),应用在启动前会优先调用这个方法.</p>
<p>agentArgs是premain函数得到的程序参数,随同&quot;-javaagent&quot;一起传入.<br>与main函数不同的是,这个参数是一个字符串而不是一个字符串数组,如果程序参数有多个,程序将自行解析这个字符串,pinpoint中的agentArgs就是pinpoint的jar包.</p>
<p>instrumentation是一个java.lang.instrument.Instrumentation的实例,由JVM自动传入.java.lang.instrument.Instrumentation是instrument包中定义的一个接口,也是这个包的核心部分,集中了其中几乎所有的功能方法,例如类定义的转换和操作等等.</p>
<img src="/images/pp_12.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">


<p>PinpointStarter.start()-&gt;DefaultAgent.start()-&gt;DefaultApplicationContext.start()</p>
<p>在DefaultApplicationContext构造函数中,addTransformer 方法并没有指明要转换哪个类,此时并未发生实际的字节码转换.<br>转换发生在 premain 函数执行之后,main 函数执行之前,这时每装载一个类,transform 方法就会执行一次,看看是否需要转换.</p>
<img src="/images/pp_13.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">


<blockquote>
<p>字节码转换过程</p>
</blockquote>
<p>1.JVM初始化并通过System ClassLoader加载Pinpoint Agent类.<br>2.创建Instrumentation接口实例并调用Pinpoint Agent的Premain方法,并自动传入Instrumentation实例.<br>3.Pinpoint Agent加载plugins插件,将其中的transformer类注册到Instrumentation实例中.<br>4.System ClassLoader加载其他的应用Java类,此时将调用注册的transformer方法对要加载的java类进行字节码转换.<br>5.JVM将转换后的class放入方法区.</p>
<h3 id="ProfilerPlugin插件工作原理"><a href="#ProfilerPlugin插件工作原理" class="headerlink" title="ProfilerPlugin插件工作原理"></a>ProfilerPlugin插件工作原理</h3><p>1.Pinpoint Agent随JVM一起启动;<br>2.Agent加载所有plugin目录下的插件;<br>3.Agent调用每个已经加载的插件的ProfilerPlugin.setup(ProfilerPluginSetupContext)方法;<br>4.在setup方法中,插件定义那些需要被转换的类,并注册TransformerCallback;<br>5.目标应用启动;<br>6.当类被加载的时候,PinpointAgent会寻找注册到该类的TransformerCallback;<br>7.如果TransformerCallback被注册,Agent就调用它的doInTransform方法;<br>8.TransformerCallback修改目标类的字节码(例如添加拦截器/添加字段等);<br>9.修改后的代码返回到JVM,类型加载的时候就使用修改后的字节码;<br>10.应用程序继续;<br>11.当调用到被修改的方法的时候,注入的拦截器的before和after方法被调用;<br>12.拦截器记录追踪数据;</p>
<h3 id="pinpoint-collector"><a href="#pinpoint-collector" class="headerlink" title="pinpoint-collector"></a>pinpoint-collector</h3><p>采用Spring MVC架构,其中主要的bean为serverAcceptor,作用是定义管理Thrift传输的服务端,由类PinpointServerAcceptor定义,构造函数如下图,</p>
<p>其中,createBootStrap中定义了boss和worker线程池.</p>
<p>addPipeline是将handle添加管道中,这个handler主要是由nettyChannelHandler定义的.</p>
<p>nettyChannelHandler是在以下代码中初始化的,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PinpointServerChannelHandler nettyChannelHandler = <span class="keyword">new</span> PinpointServerChannelHandler();</span><br></pre></td></tr></table></figure>

<p>在PinpointServerChannelHandler类中,<br>定义了channelConnected,channelDisconnected,channelClosed和messageReceived方法,<br>messageReceived方法根据packetType来处理包,<br>有的存入Hbase数据库,有的产生response返回Agent.</p>
<img src="/images/pp_14.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<img src="/images/pp_15.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<img src="/images/pp_16.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">


<h2 id="集群宕机测试"><a href="#集群宕机测试" class="headerlink" title="集群宕机测试"></a>集群宕机测试</h2><h3 id="pinpoint-collector-1"><a href="#pinpoint-collector-1" class="headerlink" title="pinpoint-collector"></a>pinpoint-collector</h3><p>依次手动kill掉3台collector节点进程,查看web节点日志,</p>
<img src="/images/pp_17.png" width="600" style="margin-left: 0px; padding-bottom: 10px;">

<p>日志出现节点9091端口连接不上警告,当所有collector全kill掉时,pp-web页面代理程序监控消失,app程序运行不受影响,再依次启动collector后,pp-web页面代理程序监控正常.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pinpoint/" rel="tag"># pinpoint</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/03/04/debezium%E5%AE%9E%E7%8E%B0sqlserver2kafka/" rel="prev" title="debezium实现sqlserver2kafka">
                  <i class="fa fa-chevron-left"></i> debezium实现sqlserver2kafka
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/03/05/metricbeat%E6%94%B6%E9%9B%86flume%20metrics/" rel="next" title="metricbeat收集flume metrics">
                  metricbeat收集flume metrics <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">maoeryu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  





</body>
</html>
