<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"maoeryu.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.2.1","exturl":false,"sidebar":{"position":"left","width":200,"display":"post","padding":7,"offset":5},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="概述SELECT语句和VALUES语句是sqlQuery()用TableEnvironment.该方法将 SELECT 语句(或 VALUES 语句)的结果作为Table.A Table可用于后续 SQL 和 Table API 查询,转换为 DataStream或写入 TableSink.SQL 和 Table API 查询可以无缝混合,并进行整体优化并转换为单个程序. 为了在 SQL 查询中访">
<meta property="og:type" content="article">
<meta property="og:title" content="flink sql-queries查询">
<meta property="og:url" content="https://maoeryu.github.io/2022/08/22/flink%20sql-queries%E6%9F%A5%E8%AF%A2/index.html">
<meta property="og:site_name" content="FlyingPig">
<meta property="og:description" content="概述SELECT语句和VALUES语句是sqlQuery()用TableEnvironment.该方法将 SELECT 语句(或 VALUES 语句)的结果作为Table.A Table可用于后续 SQL 和 Table API 查询,转换为 DataStream或写入 TableSink.SQL 和 Table API 查询可以无缝混合,并进行整体优化并转换为单个程序. 为了在 SQL 查询中访">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl58.svg">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl59.svg">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl60.png">
<meta property="article:published_time" content="2022-08-21T16:00:00.000Z">
<meta property="article:modified_time" content="2022-12-02T06:09:55.149Z">
<meta property="article:author" content="maoeryu">
<meta property="article:tag" content="flink">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://maoeryu.github.io/images/flgl58.svg">


<link rel="canonical" href="https://maoeryu.github.io/2022/08/22/flink%20sql-queries%E6%9F%A5%E8%AF%A2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>flink sql-queries查询 | FlyingPig</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">FlyingPig</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.1.</span> <span class="nav-text">指定查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.2.</span> <span class="nav-text">执行查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">1.3.</span> <span class="nav-text">语法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hints"><span class="nav-number">2.</span> <span class="nav-text">Hints</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E8%A1%A8-Dynamic-Table-%E9%80%89%E9%A1%B9"><span class="nav-number">2.1.</span> <span class="nav-text">动态表(Dynamic Table)选项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-1"><span class="nav-number">2.1.1.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.1.2.</span> <span class="nav-text">示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WITH-%E5%AD%90%E5%8F%A5"><span class="nav-number">3.</span> <span class="nav-text">WITH 子句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SELECT-%E4%B8%8E-WHERE-%E5%AD%90%E5%8F%A5"><span class="nav-number">4.</span> <span class="nav-text">SELECT 与 WHERE 子句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SELECT-DISTINCT"><span class="nav-number">5.</span> <span class="nav-text">SELECT DISTINCT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windowing-table-valued-functions-Windowing-TVFs-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="nav-number">6.</span> <span class="nav-text">Windowing table-valued functions(Windowing TVFs)(窗口函数)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-Functions-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="nav-number">6.1.</span> <span class="nav-text">Window Functions(窗口函数)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TUMBLE-%E7%BF%BB%E6%BB%9A"><span class="nav-number">6.1.1.</span> <span class="nav-text">TUMBLE(翻滚)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HOP"><span class="nav-number">6.1.2.</span> <span class="nav-text">HOP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CUMULATE-%E7%B4%AF%E7%A7%AF"><span class="nav-number">6.1.3.</span> <span class="nav-text">CUMULATE(累积)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-Offset-%E7%AA%97%E5%8F%A3%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="nav-number">6.2.</span> <span class="nav-text">Window Offset(窗口偏移量)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Window-Aggregation-%E7%AA%97%E5%8F%A3%E8%81%9A%E5%90%88"><span class="nav-number">7.</span> <span class="nav-text">Window Aggregation(窗口聚合)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-TVF-Aggregation"><span class="nav-number">7.1.</span> <span class="nav-text">Window TVF Aggregation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Windowing-TVFs"><span class="nav-number">7.1.1.</span> <span class="nav-text">Windowing TVFs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GROUPING-SETS"><span class="nav-number">7.1.2.</span> <span class="nav-text">GROUPING SETS</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ROLLUP-%E6%B1%87%E6%80%BB"><span class="nav-number">7.1.2.1.</span> <span class="nav-text">ROLLUP(汇总)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CUBE-%E7%AB%8B%E6%96%B9%E4%BD%93"><span class="nav-number">7.1.2.2.</span> <span class="nav-text">CUBE(立方体)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E7%BB%84%E7%AA%97%E5%8F%A3%E5%BC%80%E5%A7%8B%E5%92%8C%E7%BB%93%E6%9D%9F%E6%97%B6%E9%97%B4%E6%88%B3"><span class="nav-number">7.1.3.</span> <span class="nav-text">选择组窗口开始和结束时间戳</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cascading-Window-Aggregation-%E7%BA%A7%E8%81%94%E7%AA%97%E5%8F%A3%E8%81%9A%E5%90%88"><span class="nav-number">7.1.4.</span> <span class="nav-text">Cascading Window Aggregation(级联窗口聚合)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E7%AA%97%E5%8F%A3%E8%81%9A%E5%90%88"><span class="nav-number">7.2.</span> <span class="nav-text">组窗口聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="nav-number">7.2.1.</span> <span class="nav-text">组窗口函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#TUMBLE-time-attr-interval"><span class="nav-number">7.2.1.1.</span> <span class="nav-text">TUMBLE(time_attr, interval)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HOP-time-attr-interval-interval"><span class="nav-number">7.2.1.2.</span> <span class="nav-text">HOP(time_attr, interval, interval)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SESSION-time-attr-interval"><span class="nav-number">7.2.1.3.</span> <span class="nav-text">SESSION(time_attr, interval)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%B1%9E%E6%80%A7"><span class="nav-number">7.2.2.</span> <span class="nav-text">时间属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E7%BB%84%E7%AA%97%E5%8F%A3%E5%BC%80%E5%A7%8B%E5%92%8C%E7%BB%93%E6%9D%9F%E6%97%B6%E9%97%B4%E6%88%B3-1"><span class="nav-number">7.2.3.</span> <span class="nav-text">选择组窗口开始和结束时间戳</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Group-Aggregation-%E5%88%86%E7%BB%84%E8%81%9A%E5%90%88"><span class="nav-number">8.</span> <span class="nav-text">Group Aggregation(分组聚合)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DISTINCT-%E8%81%9A%E5%90%88"><span class="nav-number">8.1.</span> <span class="nav-text">DISTINCT 聚合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GROUPING-SETS-%E5%88%86%E7%BB%84%E9%9B%86"><span class="nav-number">8.2.</span> <span class="nav-text">GROUPING SETS(分组集)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ROLLUP-%E6%B1%87%E6%80%BB-1"><span class="nav-number">8.2.1.</span> <span class="nav-text">ROLLUP(汇总)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CUBE-%E7%AB%8B%E6%96%B9%E4%BD%93-1"><span class="nav-number">8.2.2.</span> <span class="nav-text">CUBE(立方体)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HAVING-%E6%8B%A5%E6%9C%89"><span class="nav-number">8.3.</span> <span class="nav-text">HAVING(拥有)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Over-Aggregation"><span class="nav-number">9.</span> <span class="nav-text">Over Aggregation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ORDER-BY"><span class="nav-number">9.1.</span> <span class="nav-text">ORDER BY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PARTITION-BY"><span class="nav-number">9.2.</span> <span class="nav-text">PARTITION BY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Range-Definitions-%E8%8C%83%E5%9B%B4%E5%AE%9A%E4%B9%89"><span class="nav-number">9.3.</span> <span class="nav-text">Range Definitions(范围定义)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RANGE-intervals-%E8%8C%83%E5%9B%B4%E9%97%B4%E9%9A%94"><span class="nav-number">9.3.1.</span> <span class="nav-text">RANGE intervals(范围间隔)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ROW-intervals-%E8%A1%8C%E9%97%B4%E9%9A%94"><span class="nav-number">9.3.2.</span> <span class="nav-text">ROW intervals(行间隔)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Joins"><span class="nav-number">10.</span> <span class="nav-text">Joins</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Regular-Joins-%E5%B8%B8%E8%A7%84%E8%BF%9E%E6%8E%A5"><span class="nav-number">10.1.</span> <span class="nav-text">Regular Joins(常规连接)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#INNER-Equi-JOIN"><span class="nav-number">10.1.1.</span> <span class="nav-text">INNER Equi-JOIN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OUTER-Equi-JOIN"><span class="nav-number">10.1.2.</span> <span class="nav-text">OUTER Equi-JOIN</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Interval-Joins-%E9%97%B4%E9%9A%94%E8%BF%9E%E6%8E%A5"><span class="nav-number">10.2.</span> <span class="nav-text">Interval Joins(间隔连接)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Temporal-Joins-%E6%97%B6%E9%97%B4%E8%BF%9E%E6%8E%A5"><span class="nav-number">10.3.</span> <span class="nav-text">Temporal Joins(时间连接)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Event-Time-Temporal-Join-%E4%BA%8B%E4%BB%B6%E6%97%B6%E9%97%B4%E4%B8%B4%E6%97%B6%E5%8A%A0%E5%85%A5"><span class="nav-number">10.3.1.</span> <span class="nav-text">Event Time Temporal Join(事件时间临时加入)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Processing-Time-Temporal-Join-%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4%E4%B8%B4%E6%97%B6%E5%8A%A0%E5%85%A5"><span class="nav-number">10.3.2.</span> <span class="nav-text">Processing Time Temporal Join(处理时间临时加入)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Temporal-Table-Function-Join-%E6%97%B6%E6%80%81%E8%A1%A8%E5%87%BD%E6%95%B0%E8%BF%9E%E6%8E%A5"><span class="nav-number">10.3.3.</span> <span class="nav-text">Temporal Table Function Join(时态表函数连接)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lookup-Join-%E6%9F%A5%E6%89%BE%E5%8A%A0%E5%85%A5"><span class="nav-number">10.4.</span> <span class="nav-text">Lookup Join(查找加入)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Array-Expansion-%E6%95%B0%E7%BB%84%E6%89%A9%E5%B1%95"><span class="nav-number">10.5.</span> <span class="nav-text">Array Expansion(数组扩展)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Table-Function-%E8%A1%A8%E5%87%BD%E6%95%B0"><span class="nav-number">10.6.</span> <span class="nav-text">Table Function(表函数)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#INNER-JOIN-%E5%86%85%E8%BF%9E%E6%8E%A5"><span class="nav-number">10.6.1.</span> <span class="nav-text">INNER JOIN(内连接)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LEFT-OUTER-JOIN-%E5%B7%A6%E5%A4%96%E8%BF%9E%E6%8E%A5"><span class="nav-number">10.6.2.</span> <span class="nav-text">LEFT OUTER JOIN(左外连接)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Window-Join-%E7%AA%97%E5%8F%A3%E5%85%B3%E8%81%94"><span class="nav-number">11.</span> <span class="nav-text">Window Join(窗口关联)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#INNER-LEFT-RIGHT-FULL-OUTER-%E5%86%85-%E5%B7%A6-%E5%8F%B3-%E5%85%A8%E5%A4%96"><span class="nav-number">11.1.</span> <span class="nav-text">INNER&#x2F;LEFT&#x2F;RIGHT&#x2F;FULL OUTER(内&#x2F;左&#x2F;右&#x2F;全外)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SEMI"><span class="nav-number">11.2.</span> <span class="nav-text">SEMI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ANTI"><span class="nav-number">11.3.</span> <span class="nav-text">ANTI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Limitation"><span class="nav-number">11.4.</span> <span class="nav-text">Limitation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Join-%E5%AD%90%E5%8F%A5%E7%9A%84%E9%99%90%E5%88%B6"><span class="nav-number">11.4.1.</span> <span class="nav-text">Join 子句的限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BE%93%E5%85%A5%E7%AA%97%E5%8F%A3-TVF-%E7%9A%84%E9%99%90%E5%88%B6"><span class="nav-number">11.4.2.</span> <span class="nav-text">输入窗口 TVF 的限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E7%9B%B4%E6%8E%A5%E5%AF%B9-TVF-%E8%BF%9B%E8%A1%8C%E7%AA%97%E5%8F%A3%E5%8C%96%E4%B9%8B%E5%90%8E-%E5%AF%B9-Window-Join-%E7%9A%84%E9%99%90%E5%88%B6"><span class="nav-number">11.4.3.</span> <span class="nav-text">在直接对 TVF 进行窗口化之后,对 Window Join 的限制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Set-Operations-%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C"><span class="nav-number">12.</span> <span class="nav-text">Set Operations(集合操作)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UNION-%E8%81%94%E5%90%88"><span class="nav-number">12.1.</span> <span class="nav-text">UNION(联合)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#INTERSECT-%E7%9B%B8%E4%BA%A4"><span class="nav-number">12.2.</span> <span class="nav-text">INTERSECT(相交)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EXCEPT"><span class="nav-number">12.3.</span> <span class="nav-text">EXCEPT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IN"><span class="nav-number">12.4.</span> <span class="nav-text">IN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EXISTS"><span class="nav-number">12.5.</span> <span class="nav-text">EXISTS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ORDER-BY-%E8%AF%AD%E5%8F%A5"><span class="nav-number">13.</span> <span class="nav-text">ORDER BY 语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LIMIT-%E8%AF%AD%E5%8F%A5"><span class="nav-number">14.</span> <span class="nav-text">LIMIT 语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Top-N"><span class="nav-number">15.</span> <span class="nav-text">Top-N</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%A7%84%E6%A0%BC"><span class="nav-number">15.1.</span> <span class="nav-text">参数规格</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ROW-NUMBER"><span class="nav-number">15.1.1.</span> <span class="nav-text">ROW_NUMBER()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PARTITION-BY-col1-col2"><span class="nav-number">15.1.2.</span> <span class="nav-text">PARTITION BY col1[, col2...]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ORDER-BY-col1-asc-desc-col2-asc-desc"><span class="nav-number">15.1.3.</span> <span class="nav-text">ORDER BY col1 [asc|desc][, col2 [asc|desc]...]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WHERE-rownum-lt-N"><span class="nav-number">15.1.4.</span> <span class="nav-text">WHERE rownum &lt;&#x3D; N</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AND-conditions"><span class="nav-number">15.1.5.</span> <span class="nav-text">[AND conditions]</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E6%8E%92%E5%90%8D%E8%BE%93%E5%87%BA%E4%BC%98%E5%8C%96"><span class="nav-number">15.2.</span> <span class="nav-text">无排名输出优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Window-Top-N"><span class="nav-number">16.</span> <span class="nav-text">Window Top-N</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">16.1.</span> <span class="nav-text">示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Window-Aggregation-%E4%B9%8B%E5%90%8E%E6%98%AF-Window-Top-N"><span class="nav-number">16.1.1.</span> <span class="nav-text">Window Aggregation 之后是 Window Top-N</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Window-Top-N-%E8%B7%9F%E9%9A%8F%E5%9C%A8-Windowing-TVF"><span class="nav-number">16.1.2.</span> <span class="nav-text">Window Top-N 跟随在 Windowing TVF</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Limitation-%E9%99%90%E5%88%B6"><span class="nav-number">16.2.</span> <span class="nav-text">Limitation(限制)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deduplication-%E5%8E%BB%E9%87%8D"><span class="nav-number">17.</span> <span class="nav-text">Deduplication(去重)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%A7%84%E6%A0%BC-1"><span class="nav-number">17.1.</span> <span class="nav-text">参数规格</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ROW-NUMBER-1"><span class="nav-number">17.1.1.</span> <span class="nav-text">ROW_NUMBER()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PARTITION-BY-col1-col2-1"><span class="nav-number">17.1.2.</span> <span class="nav-text">PARTITION BY col1[, col2...]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ORDER-BY-time-attr-asc-desc"><span class="nav-number">17.1.3.</span> <span class="nav-text">ORDER BY time_attr [asc|desc]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WHERE-rownum-1"><span class="nav-number">17.1.4.</span> <span class="nav-text">WHERE rownum &#x3D; 1</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Window-Deduplication-%E7%AA%97%E5%8F%A3%E5%8E%BB%E9%87%8D"><span class="nav-number">18.</span> <span class="nav-text">Window Deduplication(窗口去重)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%A7%84%E6%A0%BC-2"><span class="nav-number">18.1.</span> <span class="nav-text">参数规格</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ROW-NUMBER-2"><span class="nav-number">18.1.1.</span> <span class="nav-text">ROW_NUMBER()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PARTITION-BY-window-start-window-end-col-key1"><span class="nav-number">18.1.2.</span> <span class="nav-text">PARTITION BY window_start, window_end [, col_key1...]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ORDER-BY-time-attr-asc-desc-1"><span class="nav-number">18.1.3.</span> <span class="nav-text">ORDER BY time_attr [asc|desc]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WHERE-rownum-1-rownum-lt-1-rownum-lt-2"><span class="nav-number">18.1.4.</span> <span class="nav-text">WHERE (rownum &#x3D; 1 | rownum &lt;&#x3D;1 | rownum &lt; 2)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="nav-number">18.2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E5%88%B6"><span class="nav-number">18.3.</span> <span class="nav-text">限制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E5%AF%B9-TVF-%E8%BF%9B%E8%A1%8C%E7%AA%97%E5%8F%A3%E5%8C%96%E5%90%8E%E5%AF%B9%E7%AA%97%E5%8F%A3%E9%87%8D%E5%A4%8D%E6%95%B0%E6%8D%AE%E5%88%A0%E9%99%A4%E7%9A%84%E9%99%90%E5%88%B6"><span class="nav-number">18.3.1.</span> <span class="nav-text">直接对 TVF 进行窗口化后对窗口重复数据删除的限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E9%94%AE%E7%9A%84%E6%97%B6%E9%97%B4%E5%B1%9E%E6%80%A7%E9%99%90%E5%88%B6"><span class="nav-number">18.3.2.</span> <span class="nav-text">订单键的时间属性限制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%BC%8F%E6%A3%80%E6%B5%8B"><span class="nav-number">19.</span> <span class="nav-text">模式检测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D%E5%92%8C%E7%A4%BA%E4%BE%8B"><span class="nav-number">19.1.</span> <span class="nav-text">介绍和示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97"><span class="nav-number">19.1.1.</span> <span class="nav-text">安装指南</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL-%E8%AF%AD%E4%B9%89"><span class="nav-number">19.1.2.</span> <span class="nav-text">SQL 语义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-3"><span class="nav-number">19.1.3.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8C%BA"><span class="nav-number">19.2.</span> <span class="nav-text">分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E9%A1%BA%E5%BA%8F"><span class="nav-number">19.3.</span> <span class="nav-text">事件顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Define-amp-Measures"><span class="nav-number">19.4.</span> <span class="nav-text">Define &amp; Measures</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Aggregations"><span class="nav-number">19.4.1.</span> <span class="nav-text">Aggregations</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%BC%8F"><span class="nav-number">19.5.</span> <span class="nav-text">定义模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B4%AA%E5%A9%AA%E9%87%8F%E8%AF%8D%E5%92%8C%E5%8B%89%E5%BC%BA%E9%87%8F%E8%AF%8D"><span class="nav-number">19.5.1.</span> <span class="nav-text">贪婪量词和勉强量词</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E7%BA%A6%E6%9D%9F"><span class="nav-number">19.5.2.</span> <span class="nav-text">时间约束</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BE%93%E5%87%BA%E6%96%B9%E5%BC%8F"><span class="nav-number">19.6.</span> <span class="nav-text">输出方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%BC%8F%E5%AF%BC%E8%88%AA"><span class="nav-number">19.7.</span> <span class="nav-text">模式导航</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E6%A8%A1%E5%BC%8F%E5%8F%98%E9%87%8F"><span class="nav-number">19.7.1.</span> <span class="nav-text">引用模式变量</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-4"><span class="nav-number">19.7.1.1.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Logical-Offsets"><span class="nav-number">19.7.2.</span> <span class="nav-text">Logical Offsets</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-5"><span class="nav-number">19.7.2.1.</span> <span class="nav-text">示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%B9%E9%85%8D%E5%90%8E%E7%9A%84%E7%AD%96%E7%95%A5"><span class="nav-number">19.8.</span> <span class="nav-text">匹配后的策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-6"><span class="nav-number">19.8.1.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%B1%9E%E6%80%A7-1"><span class="nav-number">19.9.</span> <span class="nav-text">时间属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MATCH-ROWTIME-rowtime-field"><span class="nav-number">19.9.1.</span> <span class="nav-text">MATCH_ROWTIME([rowtime_field])</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MATCH-PROCTIME"><span class="nav-number">19.9.2.</span> <span class="nav-text">MATCH_PROCTIME()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97"><span class="nav-number">19.10.</span> <span class="nav-text">控制内存消耗</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%B2%E7%9F%A5%E7%9A%84%E5%B1%80%E9%99%90"><span class="nav-number">19.11.</span> <span class="nav-text">已知的局限</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E5%BC%8F%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">19.11.1.</span> <span class="nav-text">模式表达式</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">maoeryu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">222</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://maoeryu.github.io/2022/08/22/flink%20sql-queries%E6%9F%A5%E8%AF%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="maoeryu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlyingPig">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          flink sql-queries查询
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-22 00:00:00" itemprop="dateCreated datePublished" datetime="2022-08-22T00:00:00+08:00">2022-08-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-12-02 14:09:55" itemprop="dateModified" datetime="2022-12-02T14:09:55+08:00">2022-12-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8D%8F%E5%90%8C%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">协同框架</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>SELECT语句和VALUES语句是sqlQuery()用TableEnvironment.<br>该方法将 SELECT 语句(或 VALUES 语句)的结果作为Table.<br>A Table可用于后续 SQL 和 Table API 查询,转换为 DataStream或写入 TableSink.<br>SQL 和 Table API 查询可以无缝混合,并进行整体优化并转换为单个程序.</p>
<p>为了在 SQL 查询中访问表,它必须在 TableEnvironment 中注册.<br>可以从TableSource/Table/CREATE TABLE 语句/DataStream注册表.<br>或者,用户也可以在 TableEnvironment 中注册目录以指定数据源的位置.</p>
<p>为方便起见,Table.toString()自动在其唯一名称下注册表TableEnvironment并返回该名称.<br>因此,Table可以将对象直接内联到 SQL 查询中,如下面的示例所示.</p>
<p>注意:包含不受支持的 SQL 功能的查询会导致TableException. 以下部分列出了批处理表和流表上支持的 SQL 功能.</p>
<span id="more"></span>
<h3 id="指定查询"><a href="#指定查询" class="headerlink" title="指定查询"></a>指定查询</h3><p>以下示例显示如何在已注册表和内联表上指定 SQL 查询.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ingest a DataStream from an external source</span></span><br><span class="line">DataStream&lt;Tuple3&lt;Long, String, Integer&gt;&gt; ds = env.addSource(...);</span><br><span class="line"></span><br><span class="line"><span class="comment">// SQL query with an inlined (unregistered) table</span></span><br><span class="line">Table table = tableEnv.fromDataStream(ds, $(<span class="string">&quot;user&quot;</span>), $(<span class="string">&quot;product&quot;</span>), $(<span class="string">&quot;amount&quot;</span>));</span><br><span class="line">Table result = tableEnv.sqlQuery(</span><br><span class="line"> <span class="string">&quot;SELECT SUM(amount) FROM &quot;</span> + table + <span class="string">&quot; WHERE product LIKE &#x27;%Rubber%&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// SQL query with a registered table</span></span><br><span class="line"><span class="comment">// register the DataStream as view &quot;Orders&quot;</span></span><br><span class="line">tableEnv.createTemporaryView(<span class="string">&quot;Orders&quot;</span>, ds, $(<span class="string">&quot;user&quot;</span>), $(<span class="string">&quot;product&quot;</span>), $(<span class="string">&quot;amount&quot;</span>));</span><br><span class="line"><span class="comment">// run a SQL query on the Table and retrieve the result as a new Table</span></span><br><span class="line">Table result2 = tableEnv.sqlQuery(</span><br><span class="line"> <span class="string">&quot;SELECT product, amount FROM Orders WHERE product LIKE &#x27;%Rubber%&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// create and register a TableSink</span></span><br><span class="line"><span class="keyword">final</span> Schema schema = Schema.newBuilder()</span><br><span class="line">  .column(<span class="string">&quot;product&quot;</span>, DataTypes.STRING())</span><br><span class="line">  .column(<span class="string">&quot;amount&quot;</span>, DataTypes.INT())</span><br><span class="line">  .build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> TableDescriptor sinkDescriptor = TableDescriptor.forConnector(<span class="string">&quot;filesystem&quot;</span>)</span><br><span class="line">  .schema(schema)</span><br><span class="line">  .format(FormatDescriptor.forFormat(<span class="string">&quot;csv&quot;</span>)</span><br><span class="line">      .option(<span class="string">&quot;field-delimiter&quot;</span>, <span class="string">&quot;,&quot;</span>)</span><br><span class="line">      .build())</span><br><span class="line">  .build();</span><br><span class="line"></span><br><span class="line">tableEnv.createTemporaryTable(<span class="string">&quot;RubberOrders&quot;</span>, sinkDescriptor);</span><br><span class="line"></span><br><span class="line"><span class="comment">// run an INSERT SQL on the Table and emit the result to the TableSink</span></span><br><span class="line">tableEnv.executeSql(</span><br><span class="line"> <span class="string">&quot;INSERT INTO RubberOrders SELECT product, amount FROM Orders WHERE product LIKE &#x27;%Rubber%&#x27;&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h3><p>可以通过该TableEnvironment.executeSql()方法执行SELECT语句或VALUES语句将内容收集到本地.<br>该方法将 SELECT 语句(或 VALUES 语句)的结果作为TableResult.<br>类似于 SELECT 语句,Table可以使用该Table.execute()方法执行对象,将查询的内容收集到本地客户端.<br>TableResult.collect()方法返回一个可关闭的行迭代器.<br>除非已收集所有结果数据,否则选择作业不会完成.<br>我们应该主动关闭作业,以避免通过该CloseableIterator#close()方法泄漏资源.<br>TableResult.print()我们也可以通过该方法将选择结果打印到客户端控制台.<br>中的结果数据TableResult只能访问一次.<br>因此,collect()不得print()互相调用.</p>
<p>TableResult.collect()并且TableResult.print()在不同的检查点设置下具有略微不同的行为(要为流式作业启用检查点,请参阅检查点配置).</p>
<p>对于没有检查点的批处理作业或流式作业,TableResult.collect()既TableResult.print()没有完全一次也没有至少一次保证.<br>查询结果一旦生成,客户端就可以立即访问,但是当作业失败并重新启动时会抛出异常.</p>
<p>用于具有一次性检查点的流式作业,TableResult.collect()并TableResult.print()保证端到端的一次性记录交付.<br>只有在相应的检查点完成后,客户端才能访问结果.</p>
<p>用于具有至少一次检查点的流式作业,TableResult.collect()并TableResult.print()保证端到端的至少一次记录交付.<br>查询结果一旦生成,客户端就可以立即访问,但可能会多次传递相同的结果.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env, settings);</span><br><span class="line"></span><br><span class="line">tableEnv.executeSql(<span class="string">&quot;CREATE TABLE Orders (`user` BIGINT, product STRING, amount INT) WITH (...)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// execute SELECT statement</span></span><br><span class="line">TableResult tableResult1 = tableEnv.executeSql(<span class="string">&quot;SELECT * FROM Orders&quot;</span>);</span><br><span class="line"><span class="comment">// use try-with-resources statement to make sure the iterator will be closed automatically</span></span><br><span class="line"><span class="keyword">try</span> (CloseableIterator&lt;Row&gt; it = tableResult1.collect()) &#123;</span><br><span class="line">  <span class="keyword">while</span>(it.hasNext()) &#123;</span><br><span class="line">      Row row = it.next();</span><br><span class="line">      <span class="comment">// handle row</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// execute Table</span></span><br><span class="line">TableResult tableResult2 = tableEnv.sqlQuery(<span class="string">&quot;SELECT * FROM Orders&quot;</span>).execute();</span><br><span class="line">tableResult2.print();</span><br></pre></td></tr></table></figure>

<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>Flink 使用支持标准 ANSI SQL 的Apache Calcite解析 SQL.</p>
<p>以下 BNF 语法描述了批处理和流式查询中支持的 SQL 功能的超集.<br>操作部分显示了受支持功能的示例,并指出了哪些功能仅支持批处理或流式查询.<br>Flink SQL 使用类似于 Java 的标识符(表/属性/函数名)的词法策略:</p>
<ol>
<li>无论是否引用标识符,都会保留标识符的大小写.</li>
<li>之后,标识符会区分大小写.</li>
<li>与 Java 不同,反引号允许标识符包含非字母数字字符(例如&quot;SELECT a AS my field FROM t&quot;).</li>
</ol>
<p>字符串文字必须用单引号括起来(例如,SELECT &#39;Hello World&#39;).<br>复制单引号以进行转义(例如,SELECT &#39;It&#39;&#39;s me&#39;).</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;Hello World&#x27;</span>, <span class="string">&#x27;It&#x27;&#x27;s me&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------+</span></span><br><span class="line"><span class="operator">|</span>      EXPR$<span class="number">0</span> <span class="operator">|</span>  EXPR$<span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------+</span></span><br><span class="line"><span class="operator">|</span> Hello World <span class="operator">|</span> It<span class="string">&#x27;s me |</span></span><br><span class="line"><span class="string">+-------------+---------+</span></span><br><span class="line"><span class="string">1 row in set</span></span><br></pre></td></tr></table></figure>

<p>字符串文字中支持 Unicode 字符.<br>如果需要显式 unicode 代码点,请使用以下语法:</p>
<ol>
<li>使用反斜杠 ( \) 作为转义字符(默认):SELECT U&amp;&#39;\263A&#39;</li>
<li>使用自定义转义字符:SELECT U&amp;&#39;#263A&#39; UESCAPE &#39;#&#39;</li>
</ol>
<h2 id="Hints"><a href="#Hints" class="headerlink" title="Hints"></a>Hints</h2><p>Batch Streaming</p>
<p>SQL hints 是和 SQL 语句一起使用来改变执行计划的.<br>本章介绍如何使用 SQL hints 增强各种方法.</p>
<p>SQL hints 一般可以用于以下:</p>
<ol>
<li>增强 planner:没有完美的 planner,所以实现 SQL hints 让用户更好地控制执行是非常有意义的.</li>
<li>增加元数据(或者统计信息):如&quot;已扫描的表索引&quot;和&quot;一些混洗键(shuffle keys)的倾斜信息&quot;的一些统计数据对于查询来说是动态的,用 hints 来配置它们会非常方便,因为我们从 planner 获得的计划元数据通常不那么准确.</li>
<li>算子(Operator)资源约束:在许多情况下,我们会为执行算子提供默认的资源配置,即最小并行度或托管内存(UDF 资源消耗)或特殊资源需求(GPU 或 SSD 磁盘)等,可以使用 SQL hints 非常灵活地为每个查询(非作业)配置资源.</li>
</ol>
<h3 id="动态表-Dynamic-Table-选项"><a href="#动态表-Dynamic-Table-选项" class="headerlink" title="动态表(Dynamic Table)选项"></a>动态表(Dynamic Table)选项</h3><p>动态表选项允许动态地指定或覆盖表选项,不同于用 SQL DDL 或 连接 API 定义的静态表选项,这些选项可以在每个查询的每个表范围内灵活地指定.</p>
<p>因此,它非常适合用于交互式终端中的特定查询,例如,在 SQL-CLI 中,你可以通过添加动态选项<code>/*+ OPTIONS(&#39;csv.ignore-parse-errors&#39;=&#39;true&#39;) */</code>来指定忽略 CSV 源的解析错误.</p>
<h4 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h4><p>为了不破坏 SQL 兼容性,我们使用 Oracle 风格的 SQL hints 语法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">table_path &#x2F;*+ OPTIONS(key&#x3D;val [, key&#x3D;val]*) *&#x2F;</span><br><span class="line"></span><br><span class="line">key:</span><br><span class="line">  stringLiteral</span><br><span class="line">val:</span><br><span class="line">  stringLiteral</span><br></pre></td></tr></table></figure>

<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> kafka_table1 (id <span class="type">BIGINT</span>, name STRING, age <span class="type">INT</span>) <span class="keyword">WITH</span> (...);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> kafka_table2 (id <span class="type">BIGINT</span>, name STRING, age <span class="type">INT</span>) <span class="keyword">WITH</span> (...);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 覆盖查询语句中源表的选项</span></span><br><span class="line"><span class="keyword">select</span> id, name <span class="keyword">from</span> kafka_table1 <span class="comment">/*+ OPTIONS(&#x27;scan.startup.mode&#x27;=&#x27;earliest-offset&#x27;) */</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 覆盖 join 中源表的选项</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span></span><br><span class="line">  kafka_table1 <span class="comment">/*+ OPTIONS(&#x27;scan.startup.mode&#x27;=&#x27;earliest-offset&#x27;) */</span> t1</span><br><span class="line">  <span class="keyword">join</span></span><br><span class="line">  kafka_table2 <span class="comment">/*+ OPTIONS(&#x27;scan.startup.mode&#x27;=&#x27;earliest-offset&#x27;) */</span> t2</span><br><span class="line">  <span class="keyword">on</span> t1.id <span class="operator">=</span> t2.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 覆盖插入语句中结果表的选项</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> kafka_table1 <span class="comment">/*+ OPTIONS(&#x27;sink.partitioner&#x27;=&#x27;round-robin&#x27;) */</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> kafka_table2;</span><br></pre></td></tr></table></figure>

<h2 id="WITH-子句"><a href="#WITH-子句" class="headerlink" title="WITH 子句"></a>WITH 子句</h2><p>Batch Streaming</p>
<p>WITH 子句提供了一种用于更大查询而编写辅助语句的方法.<br>这些编写的语句通常被称为公用表表达式,表达式可以理解为仅针对某个查询而存在的临时视图.</p>
<p>WITH 子句的语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="operator">&lt;</span>with_item_definition<span class="operator">&gt;</span> [ , ... ]</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ...;</span><br><span class="line"></span><br><span class="line"><span class="operator">&lt;</span>with_item_defintion<span class="operator">&gt;</span>:</span><br><span class="line">  with_item_name (column_name[, ...n]) <span class="keyword">AS</span> ( <span class="operator">&lt;</span>select_query<span class="operator">&gt;</span> )</span><br></pre></td></tr></table></figure>

<p>下面的示例中定义了一个公用表表达式 orders_with_total ,并在一个 GROUP BY 查询中使用它.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> orders_with_total <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> order_id, price <span class="operator">+</span> tax <span class="keyword">AS</span> total</span><br><span class="line">  <span class="keyword">FROM</span> Orders</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> order_id, <span class="built_in">SUM</span>(total)</span><br><span class="line"><span class="keyword">FROM</span> orders_with_total</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> order_id;</span><br></pre></td></tr></table></figure>

<h2 id="SELECT-与-WHERE-子句"><a href="#SELECT-与-WHERE-子句" class="headerlink" title="SELECT 与 WHERE 子句"></a>SELECT 与 WHERE 子句</h2><p>Batch Streaming</p>
<p>SELECT 语句的常见语法格式如下所示:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> select_list <span class="keyword">FROM</span> table_expression [ <span class="keyword">WHERE</span> boolean_expression ]</span><br></pre></td></tr></table></figure>

<p>这里的 table_expression 可以是任意的数据源.<br>它可以是一张已经存在的表/视图或者 VALUES 子句,也可以是多个现有表的关联结果/或一个子查询.<br>这里我们假设 Orders 表在 Catalog 中处于可用状态,那么下面的语句会从 Orders 表中读出所有的行.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Orders</span><br></pre></td></tr></table></figure>

<p>在 select_list 处的 * 表示查询操作将会解析所有列.<br>但是,我们不鼓励在生产中使用 *,因为它会使查询操作在应对 Catalog 变化的时候鲁棒性降低.<br>相反,可以在 select_list 处指定可用列的子集,或者使用声明的列进行计算.<br>例如,假设 Orders 表中有名为 order_id/price 和 tax 的列,那么你可以编写如下查询:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id, price <span class="operator">+</span> tax <span class="keyword">FROM</span> Orders</span><br></pre></td></tr></table></figure>

<p>查询操作还可以在 VALUES 子句中使用内联数据.<br>每一个元组对应一行,另外可以通过设置别名来为每一列指定名称.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id, price <span class="keyword">FROM</span> (<span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">2.0</span>), (<span class="number">2</span>, <span class="number">3.1</span>))  <span class="keyword">AS</span> t (order_id, price)</span><br></pre></td></tr></table></figure>

<p>可以根据 WHERE 子句对行数据进行过滤.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> price <span class="operator">+</span> tax <span class="keyword">FROM</span> Orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>此外,在任意一行的列上你可以调用内置函数和用户自定义标量函数(user-defined scalar functions).<br>当然,在使用前用户自定义函数( user-defined functions)必须已经注册到 Catalog 中.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> PRETTY_PRINT(order_id) <span class="keyword">FROM</span> Orders</span><br></pre></td></tr></table></figure>

<h2 id="SELECT-DISTINCT"><a href="#SELECT-DISTINCT" class="headerlink" title="SELECT DISTINCT"></a>SELECT DISTINCT</h2><p>Batch Streaming</p>
<p>如果SELECT DISTINCT指定,则从结果集中删除所有重复行(从每组重复项中保留一行).</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> id <span class="keyword">FROM</span> Orders</span><br></pre></td></tr></table></figure>
<p>对于流式查询,计算查询结果所需的状态可能会无限增长.<br>状态大小取决于不同行的数量.<br>您可以提供具有适当状态生存时间 (TTL) 的查询配置,以防止状态大小过大.<br>请注意,这可能会影响查询结果的正确性.<br>详情见查询配置</p>
<h2 id="Windowing-table-valued-functions-Windowing-TVFs-窗口函数"><a href="#Windowing-table-valued-functions-Windowing-TVFs-窗口函数" class="headerlink" title="Windowing table-valued functions(Windowing TVFs)(窗口函数)"></a>Windowing table-valued functions(Windowing TVFs)(窗口函数)</h2><p>Batch Streaming</p>
<p>Windows 是处理无限流的核心.<br>Windows 将流分成有限大小的&quot;桶&quot;,我们可以在这些桶上应用计算.<br>本文档重点介绍如何在 Flink SQL 中执行窗口化,以及程序员如何从其提供的功能中获得最大收益.</p>
<p>Apache Flink 提供了几个窗口表值函数 (TVF) 来将表的元素划分为窗口,包括:<br>Tumble Windows<br>Hop Windows<br>Cumulate Windows<br>Session Windows (will be supported soon)</p>
<p>请注意,每个元素在逻辑上可以属于多个窗口,具体取决于您使用的窗口表值函数.<br>例如,HOP 窗口创建重叠窗口,其中单个元素可以分配给多个窗口.</p>
<p>Windowing TVF 是 Flink 定义的多态表函数(简称 PTF).<br>PTF 是 SQL 2016 标准的一部分,是一种特殊的表函数,但可以将表作为参数.<br>PTF 是改变表格形状的强大功能.<br>因为 PTF 在语义上类似于表,所以它们的调用发生在语句的FROM子句中SELECT.</p>
<p>开窗 TVF 是对传统的Grouped Window Functions的替代.<br>窗口化 TVF 更符合 SQL 标准并且更强大,可以支持复杂的基于窗口的计算,例如 Window TopN/Window Join.<br>但是,分组窗口函数只能支持窗口聚合.</p>
<p>了解更多如何应用基于窗口 TVF 的进一步计算:<br>Window Aggregation<br>Window TopN<br>Window Join<br>Window Deduplication</p>
<h3 id="Window-Functions-窗口函数"><a href="#Window-Functions-窗口函数" class="headerlink" title="Window Functions(窗口函数)"></a>Window Functions(窗口函数)</h3><p>Apache Flink 提供了 3 个内置的窗口 TVF TUMBLE:HOP和CUMULATE. 窗口化 TVF 的返回值是一个新的关系,包括原始关系的所有列以及额外的 3 列,名为&quot;window_start&quot;/&quot;window_end&quot;/&quot;window_time&quot;,以指示分配的窗口.<br>在流模式下,&quot;window_time&quot;字段是窗口的时间属性.<br>在批处理模式下,&quot;window_time&quot;字段是类型属性TIMESTAMP或TIMESTAMP_LTZ基于输入时间字段类型的属性.<br>&quot;window_time&quot;字段可用于随后的基于时间的操作,例如另一个窗口 TVF 或间隔连接,超过聚合.<br>的值window_time总是等于window_end - 1ms.</p>
<h4 id="TUMBLE-翻滚"><a href="#TUMBLE-翻滚" class="headerlink" title="TUMBLE(翻滚)"></a>TUMBLE(翻滚)</h4><p>该TUMBLE函数将每个元素分配给指定窗口大小的窗口.<br>翻滚窗口具有固定大小并且不重叠.<br>例如,假设您指定一个大小为 5 分钟的滚动窗口.<br>在这种情况下,Flink 将评估当前窗口,并每五分钟启动一个新窗口,如下图所示.</p>
<img src="/images/flgl58.svg" style="margin-left: 0px; padding-bottom: 10px;">

<p>该TUMBLE函数根据时间属性字段为关系的每一行分配一个窗口.<br>在流模式下,时间属性字段必须是事件或处理时间属性.<br>在批处理模式下,窗口表函数的时间属性字段必须是类型TIMESTAMP或属性TIMESTAMP_LTZ.<br>的返回值TUMBLE是一个新的关系,包括原始关系的所有列以及额外的 3 列,名为&quot;window_start&quot;/&quot;window_end&quot;/&quot;window_time&quot;,以指示分配的窗口.<br>原始时间属性&quot;timecol&quot;将是窗口 TVF 之后的常规时间戳列.</p>
<p>TUMBLE函数接受三个必需参数,一个可选参数:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TUMBLE(<span class="keyword">TABLE</span> data, DESCRIPTOR(timecol), size [, <span class="keyword">offset</span> ])</span><br></pre></td></tr></table></figure>

<p>data: 是一个表参数,可以是与时间属性列的任何关系.<br>timecol: 是一个列描述符,指示数据的哪些时间属性列应映射到翻转窗口.<br>size: 是指定滚动窗口宽度的持续时间.<br>offset: 是一个可选参数,用于指定窗口起始位置的偏移量.</p>
<p>这是对表的调用示例Bid:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- tables must have time attribute, e.g. `bidtime` in this table</span></span><br><span class="line"><span class="keyword">desc</span> Bid;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span>        name <span class="operator">|</span>                   type <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span> key <span class="operator">|</span> extras <span class="operator">|</span>                       watermark <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span>     bidtime <span class="operator">|</span> <span class="type">TIMESTAMP</span>(<span class="number">3</span>) <span class="operator">*</span>ROWTIME<span class="operator">*</span> <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span> `bidtime` <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">SECOND</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       price <span class="operator">|</span>         <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        item <span class="operator">|</span>                 STRING <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Bid;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span> C    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span> A    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span> D    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span> F    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES));</span><br><span class="line"><span class="comment">-- or with the named params</span></span><br><span class="line"><span class="comment">-- <span class="doctag">note:</span> the DATA param must be the first</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(</span><br><span class="line">   DATA <span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">TABLE</span> Bid,</span><br><span class="line">   TIMECOL <span class="operator">=</span><span class="operator">&gt;</span> DESCRIPTOR(bidtime),</span><br><span class="line">   SIZE <span class="operator">=</span><span class="operator">&gt;</span> <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES));</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span>            window_time  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span> C    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span> A    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span> D    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">19</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">19</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span> F    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">19</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- apply aggregation on the tumbling windowed table</span></span><br><span class="line"><span class="keyword">SELECT</span> window_start, window_end, <span class="built_in">SUM</span>(price)</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">11.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p>注意:为了更好地理解窗口化的行为,我们简化了时间戳值的显示以不显示尾随零,例如如果类型为 ,2020-04-15 08:05则应显示为2020-04-15 08:05:00.000在 Flink SQL Client 中TIMESTAMP(3).</p>
<h4 id="HOP"><a href="#HOP" class="headerlink" title="HOP"></a>HOP</h4><p>该HOP函数将元素分配给固定长度的窗口.<br>与TUMBLE窗口函数一样,窗口的大小由窗口大小参数配置.<br>一个附加的窗口滑动参数控制一个跳跃窗口的启动频率.<br>因此,如果幻灯片小于窗口大小,则跳跃窗口可能会重叠.<br>在这种情况下,元素被分配给多个窗口.<br>跳窗也称为&quot;滑动窗&quot;.</p>
<p>例如,您可以有大小为 10 分钟的窗口滑动 5 分钟.<br>这样,您将每 5 分钟获得一个包含过去 10 分钟内到达的事件的窗口,如下图所示.</p>
<img src="/images/flgl59.svg" style="margin-left: 0px; padding-bottom: 10px;">

<p>该HOP函数分配覆盖大小区间内的行的窗口,并根据时间属性字段移动每张幻灯片.<br>在流模式下,时间属性字段必须是事件或处理时间属性.<br>在批处理模式下,窗口表函数的时间属性字段必须是类型TIMESTAMP或属性TIMESTAMP_LTZ.<br>的返回值HOP是一个新的关系,包括原始关系的所有列以及额外的 3 列,名为&quot;window_start&quot;/&quot;window_end&quot;/&quot;window_time&quot;,以指示分配的窗口.<br>原始时间属性&quot;timecol&quot;将是窗口化 TVF 后的常规时间戳列.</p>
<p>HOP接受四个必需参数,一个可选参数:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HOP(<span class="keyword">TABLE</span> data, DESCRIPTOR(timecol), slide, size [, <span class="keyword">offset</span> ])</span><br></pre></td></tr></table></figure>

<p>data: 是一个表参数,可以是与时间属性列的任何关系.<br>timecol:是一个列描述符,指示数据的哪些时间属性列应映射到跳跃窗口.<br>slide: 是一个持续时间,指定顺序跳跃窗口开始之间的持续时间<br>size: 是指定跳跃窗口宽度的持续时间.<br>offset: 是一个可选参数,用于指定窗口起始位置的偏移量.</p>
<p>这是对表的调用示例Bid:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  HOP(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES, <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES));</span><br><span class="line"><span class="comment">-- or with the named params</span></span><br><span class="line"><span class="comment">-- <span class="doctag">note:</span> the DATA param must be the first</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  HOP(</span><br><span class="line">    DATA <span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">TABLE</span> Bid,</span><br><span class="line">    TIMECOL <span class="operator">=</span><span class="operator">&gt;</span> DESCRIPTOR(bidtime),</span><br><span class="line">    SLIDE <span class="operator">=</span><span class="operator">&gt;</span> <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES,</span><br><span class="line">    SIZE <span class="operator">=</span><span class="operator">&gt;</span> <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES));</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span>           window_time   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span> C    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span> C    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">14</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span> A    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span> A    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">14</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span> D    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span> D    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">14</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">14</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">19</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">14</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">19</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span> F    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">19</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span> F    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">25</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">24</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- apply aggregation on the hopping windowed table</span></span><br><span class="line"><span class="keyword">SELECT</span> window_start, window_end, <span class="built_in">SUM</span>(price)</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  HOP(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES, <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">11.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">15.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">25</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br></pre></td></tr></table></figure>

<h4 id="CUMULATE-累积"><a href="#CUMULATE-累积" class="headerlink" title="CUMULATE(累积)"></a>CUMULATE(累积)</h4><p>累积窗口在某些场景中非常有用,例如在固定窗口间隔内提前触发的翻滚窗口.<br>例如,每日仪表盘从 00:00 到每分钟绘制累积 UV,10:00 的 UV 表示从 00:00 到 10:00 的 UV 总数.<br>这可以通过 CUMULATE 窗口轻松有效地实现.</p>
<p>该CUMULATE函数将元素分配给在初始步长间隔内覆盖行的窗口,并在每一步扩展一个步长(保持窗口开始固定)直到最大窗口大小.<br>您可以将CUMULATE功能视为TUMBLE首先应用最大窗口大小的窗口,然后将每个滚动窗口拆分为具有相同窗口开始和窗口结束步长差异的几个窗口.<br>所以累积窗口确实重叠并且没有固定的大小.</p>
<p>例如,您可以有一个 1 小时步长和 1 天最大尺寸的累积窗口,您将获得每天的窗口:/[00:00, 01:00)/[00:00, 02:00)/[00:00, 03:00)....<br>[00:00, 24:00)</p>
<img src="/images/flgl60.png" style="margin-left: 0px; padding-bottom: 10px;">

<p>这些CUMULATE函数根据时间属性列分配窗口.<br>在流模式下,时间属性字段必须是事件或处理时间属性.<br>在批处理模式下,窗口表函数的时间属性字段必须是类型TIMESTAMP或属性TIMESTAMP_LTZ.<br>的返回值CUMULATE是一个新的关系,包括原始关系的所有列以及额外的 3 列,名为&quot;window_start&quot;/&quot;window_end&quot;/&quot;window_time&quot;,以指示分配的窗口.<br>原始时间属性&quot;timecol&quot;将是窗口 TVF 之后的常规时间戳列.</p>
<p>CUMULATE接受四个必需参数,一个可选参数:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CUMULATE(<span class="keyword">TABLE</span> data, DESCRIPTOR(timecol), step, size)</span><br></pre></td></tr></table></figure>

<p>data: 是一个表参数,可以是与时间属性列的任何关系.<br>timecol:是一个列描述符,指示数据的哪些时间属性列应映射到累积窗口.<br>step: 是指定连续累积窗口结束之间增加的窗口大小的持续时间.<br>size: 是指定累积窗口的最大宽度的持续时间.<br>size必须是 的整数倍step.<br>offset: 是一个可选参数,用于指定窗口起始位置的偏移量.</p>
<p>以下是对 Bid 表的调用示例:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  CUMULATE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;2&#x27;</span> MINUTES, <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES));</span><br><span class="line"><span class="comment">-- or with the named params</span></span><br><span class="line"><span class="comment">-- <span class="doctag">note:</span> the DATA param must be the first</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  CUMULATE(</span><br><span class="line">    DATA <span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">TABLE</span> Bid,</span><br><span class="line">    TIMECOL <span class="operator">=</span><span class="operator">&gt;</span> DESCRIPTOR(bidtime),</span><br><span class="line">    STEP <span class="operator">=</span><span class="operator">&gt;</span> <span class="type">INTERVAL</span> <span class="string">&#x27;2&#x27;</span> MINUTES,</span><br><span class="line">    SIZE <span class="operator">=</span><span class="operator">&gt;</span> <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES));</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span>            window_time  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span> C    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">06</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span> C    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">08</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span> C    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span> A    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">08</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span> A    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span> D    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">12</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">14</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">16</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">18</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">19</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">14</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">16</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">18</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">19</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span> F    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">18</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span> F    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">19</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- apply aggregation on the cumulating windowed table</span></span><br><span class="line"><span class="keyword">SELECT</span> window_start, window_end, <span class="built_in">SUM</span>(price)</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  CUMULATE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;2&#x27;</span> MINUTES, <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">06</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">08</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">11.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">12</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">14</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">16</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">18</span> <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br></pre></td></tr></table></figure>

<h3 id="Window-Offset-窗口偏移量"><a href="#Window-Offset-窗口偏移量" class="headerlink" title="Window Offset(窗口偏移量)"></a>Window Offset(窗口偏移量)</h3><p>Offset是一个可选参数,可用于更改窗口分配.<br>它可以是正持续时间和负持续时间.<br>窗口偏移的默认值为 0.<br>如果设置不同的偏移值,相同的记录可能分配给不同的窗口.</p>
<p>例如,对于2021-06-30 00:00:04大小为 10 分钟的 Tumble 窗口的时间戳记录,将分配给哪个窗口?<br>如果offset值为-16 MINUTE,则记录分配给窗口 [ 2021-06-29 23:54:00, 2021-06-30 00:04:00).<br>如果offset值为-6 MINUTE,则记录分配给窗口 [ 2021-06-29 23:54:00, 2021-06-30 00:04:00).<br>如果offset是-4 MINUTE,则记录分配给窗口 [ 2021-06-29 23:56:00, 2021-06-30 00:06:00).<br>如果offset是0,则记录分配给窗口 [ 2021-06-30 00:00:00, 2021-06-30 00:10:00).<br>如果offset是4 MINUTE,则记录分配给窗口 [ 2021-06-29 23:54:00, 2021-06-30 00:04:00).<br>如果offset是6 MINUTE,则记录分配给窗口 [ 2021-06-29 23:56:00, 2021-06-30 00:06:00).<br>如果offset是16 MINUTE,则记录分配给窗口 [ 2021-06-29 23:56:00, 2021-06-30 00:06:00).</p>
<p>我们可以发现,一些窗口偏移参数可能对窗口的分配有相同的影响.<br>在上述情况下-16 MINUTE,-6 MINUTE和4 MINUTE对大小为 10 分钟的 Tumble 窗口具有相同的效果.</p>
<p>注意:窗口偏移的影响只是为了更新窗口分配,它对水印没有影响.</p>
<p>我们通过一个示例来描述如何在以下 SQL 中使用 Tumble 窗口中的偏移量.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- <span class="doctag">NOTE:</span> Currently Flink doesn&#x27;t support evaluating individual window table-valued function,</span></span><br><span class="line"><span class="comment">--  window table-valued function should be used with aggregate operation,</span></span><br><span class="line"><span class="comment">--  this example is just used for explaining the syntax and the data produced by table-valued function.</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES, <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> MINUTES));</span><br><span class="line"><span class="comment">-- or with the named params</span></span><br><span class="line"><span class="comment">-- <span class="doctag">note:</span> the DATA param must be the first</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(</span><br><span class="line">   DATA <span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">TABLE</span> Bid,</span><br><span class="line">   TIMECOL <span class="operator">=</span><span class="operator">&gt;</span> DESCRIPTOR(bidtime),</span><br><span class="line">   SIZE <span class="operator">=</span><span class="operator">&gt;</span> <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES,</span><br><span class="line">   <span class="keyword">OFFSET</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> MINUTES));</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span>            window_time  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span> C    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">01</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span> A    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">01</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span> D    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">01</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">21</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">21</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span> F    <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">21</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+------------------+------------------+-------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- apply aggregation on the tumbling windowed table</span></span><br><span class="line"><span class="keyword">SELECT</span> window_start, window_end, <span class="built_in">SUM</span>(price)</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES, <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">01</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span> <span class="number">11.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">21</span> <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p>注意:为了更好地理解窗口化的行为,我们简化了时间戳值的显示以不显示尾随零,例如如果类型为 ,2020-04-15 08:05则应显示为2020-04-15 08:05:00.000在 Flink SQL Client 中TIMESTAMP(3).</p>
<h2 id="Window-Aggregation-窗口聚合"><a href="#Window-Aggregation-窗口聚合" class="headerlink" title="Window Aggregation(窗口聚合)"></a>Window Aggregation(窗口聚合)</h2><h3 id="Window-TVF-Aggregation"><a href="#Window-TVF-Aggregation" class="headerlink" title="Window TVF Aggregation"></a>Window TVF Aggregation</h3><p>Batch Streaming</p>
<p>窗口聚合在包含应用窗口 TVFGROUP BY关系的&quot;window_start&quot;和&quot;window_end&quot;列的子句中定义.<br>就像使用常规子句的查询一样,通过窗口聚合进行分组的查询将计算每个组的单个结果行.<br>GROUP BY</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...</span><br><span class="line"><span class="keyword">FROM</span> <span class="operator">&lt;</span>windowed_table<span class="operator">&gt;</span> <span class="comment">-- relation applied windowing TVF</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end, ...</span><br></pre></td></tr></table></figure>

<p>与连续表上的其他聚合不同,窗口聚合不会发出中间结果,而只会发出最终结果,即窗口末尾的总聚合.<br>此外,窗口聚合会在不再需要时清除所有中间状态.</p>
<h4 id="Windowing-TVFs"><a href="#Windowing-TVFs" class="headerlink" title="Windowing TVFs"></a>Windowing TVFs</h4><p>Flink 支持TUMBLE,HOP和CUMULATE类型的窗口聚合.<br>在流模式下,窗口表值函数的时间属性字段必须在事件或处理时间属性上.<br>有关更多窗口函数信息,请参阅窗口 TVF.<br>在批处理模式下,窗口表值函数的时间属性字段必须是TIMESTAMP或类型的属性TIMESTAMP_LTZ.</p>
<p>以下是TUMBLE,HOP和CUMULATE窗口聚合的一些示例.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- tables must have time attribute, e.g. `bidtime` in this table</span></span><br><span class="line"><span class="keyword">desc</span> Bid;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span>        name <span class="operator">|</span>                   type <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span> key <span class="operator">|</span> extras <span class="operator">|</span>                       watermark <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span>     bidtime <span class="operator">|</span> <span class="type">TIMESTAMP</span>(<span class="number">3</span>) <span class="operator">*</span>ROWTIME<span class="operator">*</span> <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span> `bidtime` <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">SECOND</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       price <span class="operator">|</span>         <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        item <span class="operator">|</span>                 STRING <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> supplier_id <span class="operator">|</span>                 STRING <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Bid;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span> supplier_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">4.00</span>  <span class="operator">|</span> C    <span class="operator">|</span> supplier1   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span> <span class="number">2.00</span>  <span class="operator">|</span> A    <span class="operator">|</span> supplier1   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span> <span class="number">5.00</span>  <span class="operator">|</span> D    <span class="operator">|</span> supplier2   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span> <span class="number">3.00</span>  <span class="operator">|</span> B    <span class="operator">|</span> supplier2   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span> <span class="number">1.00</span>  <span class="operator">|</span> E    <span class="operator">|</span> supplier1   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span> <span class="number">6.00</span>  <span class="operator">|</span> F    <span class="operator">|</span> supplier2   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- tumbling window aggregation</span></span><br><span class="line"><span class="keyword">SELECT</span> window_start, window_end, <span class="built_in">SUM</span>(price)</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">11.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- hopping window aggregation</span></span><br><span class="line"><span class="keyword">SELECT</span> window_start, window_end, <span class="built_in">SUM</span>(price)</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  HOP(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES, <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">11.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">15.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">25</span> <span class="operator">|</span> <span class="number">6.00</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- cumulative window aggregation</span></span><br><span class="line"><span class="keyword">SELECT</span> window_start, window_end, <span class="built_in">SUM</span>(price)</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  CUMULATE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;2&#x27;</span> MINUTES, <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">06</span> <span class="operator">|</span> <span class="number">4.00</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">08</span> <span class="operator">|</span> <span class="number">6.00</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">11.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">12</span> <span class="operator">|</span> <span class="number">3.00</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">14</span> <span class="operator">|</span> <span class="number">4.00</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">16</span> <span class="operator">|</span> <span class="number">4.00</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">18</span> <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p>注意:为了更好地理解窗口化的行为,我们简化了时间戳值的显示以不显示尾随零,例如如果类型为 ,2020-04-15 08:05则应显示为2020-04-15 08:05:00.000在 Flink SQL Client 中TIMESTAMP(3).</p>
<h4 id="GROUPING-SETS"><a href="#GROUPING-SETS" class="headerlink" title="GROUPING SETS"></a>GROUPING SETS</h4><p>窗口聚合也支持GROUPING SETS语法.<br>分组集允许比标准描述的更复杂的分组操作GROUP BY.<br>行由每个指定的分组集单独分组,并且为每个组计算聚合,就像简单GROUP BY子句一样.</p>
<p>GROUPING SETS需要window_start和window_end列的窗口聚合必须在GROUP BY子句中,但不在GROUPING SETS子句中.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> window_start, window_end, supplier_id, <span class="built_in">SUM</span>(price) <span class="keyword">as</span> price</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end, <span class="keyword">GROUPING</span> SETS ((supplier_id), ());</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------------+-------+</span></span><br><span class="line"><span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> supplier_id <span class="operator">|</span> price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>      (<span class="keyword">NULL</span>) <span class="operator">|</span> <span class="number">11.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>   supplier2 <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>   supplier1 <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>      (<span class="keyword">NULL</span>) <span class="operator">|</span> <span class="number">10.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>   supplier2 <span class="operator">|</span>  <span class="number">9.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>   supplier1 <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------------+-------+</span></span><br></pre></td></tr></table></figure>

<p>的每个子列表GROUPING SETS可以指定零个或多个列或表达式,其解释方式与直接在GROUP BY子句中使用的方式相同.<br>空分组集意味着所有行都聚合到一个组中,即使不存在输入行也会输出.</p>
<p>对分组列或表达式的引用被替换为结果行中的空值,用于分组集合中没有出现这些列.</p>
<h5 id="ROLLUP-汇总"><a href="#ROLLUP-汇总" class="headerlink" title="ROLLUP(汇总)"></a>ROLLUP(汇总)</h5><p>ROLLUP是用于指定常见类型的分组集的简写符号.<br>它表示给定的表达式列表和列表的所有前缀,包括空列表.</p>
<p>窗口聚合ROLLUP要求 thewindow_start和window_end列必须在GROUP BY子句中,但不在ROLLUP子句中.</p>
<p>例如,下面的查询等同于上面的查询.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> window_start, window_end, supplier_id, <span class="built_in">SUM</span>(price) <span class="keyword">as</span> price</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end, <span class="keyword">ROLLUP</span> (supplier_id);</span><br></pre></td></tr></table></figure>

<h5 id="CUBE-立方体"><a href="#CUBE-立方体" class="headerlink" title="CUBE(立方体)"></a>CUBE(立方体)</h5><p>CUBE是用于指定常见类型的分组集的简写符号.<br>它表示给定列表及其所有可能的子集 - 幂集.</p>
<p>窗口聚合CUBE要求 thewindow_start和window_end列必须在GROUP BY子句中,但不在CUBE子句中.</p>
<p>例如,以下两个查询是等效的.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> window_start, window_end, item, supplier_id, <span class="built_in">SUM</span>(price) <span class="keyword">as</span> price</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end, <span class="keyword">CUBE</span> (supplier_id, item);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> window_start, window_end, item, supplier_id, <span class="built_in">SUM</span>(price) <span class="keyword">as</span> price</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end, <span class="keyword">GROUPING</span> SETS (</span><br><span class="line">    (supplier_id, item),</span><br><span class="line">    (supplier_id      ),</span><br><span class="line">    (             item),</span><br><span class="line">    (                 )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="选择组窗口开始和结束时间戳"><a href="#选择组窗口开始和结束时间戳" class="headerlink" title="选择组窗口开始和结束时间戳"></a>选择组窗口开始和结束时间戳</h4><p>组窗口的开始和结束时间戳可以通过分组window_start和window_end列来选择.</p>
<h4 id="Cascading-Window-Aggregation-级联窗口聚合"><a href="#Cascading-Window-Aggregation-级联窗口聚合" class="headerlink" title="Cascading Window Aggregation(级联窗口聚合)"></a>Cascading Window Aggregation(级联窗口聚合)</h4><p>和列是常规时间戳列,而不是时间属性window_start.<br>window_end因此,它们不能用作后续基于时间的操作中的时间属性.<br>为了传播时间属性,您需要在子句中另外添加window_time列.<br>GROUP BY这window_time是由窗口化 TVF生成的第三列,它是分配窗口的时间属性.<br>添加window_time到GROUP BY子句window_time也可以成为可以选择的组键.<br>然后后续查询可以使用此列进行后续基于时间的操作,例如级联窗口聚合和Window TopN.</p>
<p>下面显示了级联窗口聚合,其中第一个窗口聚合传播第二个窗口聚合的时间属性.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- tumbling 5 minutes for each supplier_id</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> window1 <span class="keyword">AS</span></span><br><span class="line"><span class="comment">-- <span class="doctag">Note:</span> The window start and window end fields of inner Window TVF are optional in the select clause. However, if they appear in the clause, they need to be aliased to prevent name conflicting with the window start and window end of the outer Window TVF.</span></span><br><span class="line"><span class="keyword">SELECT</span> window_start <span class="keyword">as</span> window_5mintumble_start, window_end <span class="keyword">as</span> window_5mintumble_end, window_time <span class="keyword">as</span> rowtime, <span class="built_in">SUM</span>(price) <span class="keyword">as</span> partial_price</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">  TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> supplier_id, window_start, window_end, window_time;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- tumbling 10 minutes on the first window</span></span><br><span class="line"><span class="keyword">SELECT</span> window_start, window_end, <span class="built_in">SUM</span>(partial_price) <span class="keyword">as</span> total_price</span><br><span class="line"> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">    TUMBLE(<span class="keyword">TABLE</span> window1, DESCRIPTOR(rowtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end;</span><br></pre></td></tr></table></figure>

<h3 id="组窗口聚合"><a href="#组窗口聚合" class="headerlink" title="组窗口聚合"></a>组窗口聚合</h3><p>Batch Streaming</p>
<p>警告:不推荐使用组窗口聚合.<br>鼓励使用更强大和更有效的Window TVF Aggregation.</p>
<p>与Group Window Aggregation相比,Window TVF Aggregation有很多优势,包括:<br>具有性能调优中提到的所有性能优化.<br>支持标准GROUPING SETS语法.<br>可以在窗口聚合结果后应用Window TopN等.</p>
<p>组窗口聚合在GROUP BYSQL 查询的子句中定义.<br>就像带有常规GROUP BY子句的查询一样,带有GROUP BY包含组窗口函数的子句的查询会计算每个组的单个结果行.<br>批处理表和流表上的 SQL 支持以下组窗口函数.</p>
<h4 id="组窗口函数"><a href="#组窗口函数" class="headerlink" title="组窗口函数"></a>组窗口函数</h4><h5 id="TUMBLE-time-attr-interval"><a href="#TUMBLE-time-attr-interval" class="headerlink" title="TUMBLE(time_attr, interval)"></a>TUMBLE(time_attr, interval)</h5><p>定义翻滚时间窗口.<br>interval翻滚时间窗口将行分配给具有固定持续时间 ( )的非重叠/连续窗口.<br>例如,5 分钟的滚动窗口以 5 分钟的间隔对行进行分组.<br>翻转窗口可以在事件时间(流 + 批处理)或处理时间(流)上定义.</p>
<h5 id="HOP-time-attr-interval-interval"><a href="#HOP-time-attr-interval-interval" class="headerlink" title="HOP(time_attr, interval, interval)"></a>HOP(time_attr, interval, interval)</h5><p>定义一个跳跃时间窗口(在 Table API 中称为滑动窗口).<br>跳跃时间窗口具有固定的持续时间(第二个interval参数)并按指定的跳跃间隔(第一个interval参数)跳跃.<br>如果跳跃间隔小于窗口大小,则跳跃窗口是重叠的.<br>因此,可以将行分配给多个窗口.<br>例如,15 分钟大小和 5 分钟跳跃间隔的跳跃窗口将每一行分配给 3 个 15 分钟大小的不同窗口,这些窗口以 5 分钟的间隔进行评估.<br>可以在事件时间(流 + 批处理)或处理时间(流)上定义跳跃窗口.</p>
<h5 id="SESSION-time-attr-interval"><a href="#SESSION-time-attr-interval" class="headerlink" title="SESSION(time_attr, interval)"></a>SESSION(time_attr, interval)</h5><p>定义会话时间窗口.<br>会话时间窗口没有固定的持续时间,但它们的界限由interval不活动时间定义,即,如果在定义的间隔期内没有事件出现,则会话窗口关闭.<br>例如,一个间隔 30 分钟的会话窗口在 30 分钟不活动后观察到一行时开始(否则该行将添加到现有窗口中),如果在 30 分钟内没有添加任何行,则关闭该会话窗口.<br>会话窗口可以在事件时间(流 + 批处理)或处理时间(流)上工作.</p>
<h4 id="时间属性"><a href="#时间属性" class="headerlink" title="时间属性"></a>时间属性</h4><p>在流模式下,time_attr组窗口函数的参数必须引用指定行的处理时间或事件时间的有效时间属性.<br>请参阅时间属性的文档以了解如何定义时间属性.</p>
<p>在批处理模式下,time_attr组窗口函数的参数必须是类型的属性TIMESTAMP.</p>
<h4 id="选择组窗口开始和结束时间戳-1"><a href="#选择组窗口开始和结束时间戳-1" class="headerlink" title="选择组窗口开始和结束时间戳"></a>选择组窗口开始和结束时间戳</h4><p>可以通过以下辅助功能选择组窗口的开始和结束时间戳以及时间属性.</p>
<p>TUMBLE_START(time_attr, interval)<br>HOP_START(time_attr, interval, interval)<br>SESSION_START(time_attr, interval)<br>返回相应翻滚/跳跃或会话窗口的包含下限的时间戳.</p>
<p>TUMBLE_END(time_attr, interval)<br>HOP_END(time_attr, interval, interval)<br>SESSION_END(time_attr, interval)<br>返回相应翻滚/跳跃或会话窗口的独占上限的时间戳.<br>注意:排他上界时间戳不能用作后续基于时间的操作中的行时间属性,例如间隔连接和组窗口或窗口聚合.</p>
<p>TUMBLE_ROWTIME(time_attr, interval)<br>HOP_ROWTIME(time_attr, interval, interval)<br>SESSION_ROWTIME(time_attr, interval)<br>返回相应翻滚/跳跃或会话窗口的包含上限的时间戳.<br>结果属性是一个行时间属性,可用于后续基于时间的操作,例如间隔连接和组窗口或窗口聚合.</p>
<p>TUMBLE_PROCTIME(time_attr, interval)<br>HOP_PROCTIME(time_attr, interval, interval)<br>SESSION_PROCTIME(time_attr, interval)<br>返回一个proctime 属性,该属性可用于后续基于时间的操作,例如间隔连接和组窗口或窗口聚合.<br>注意:GROUP BY必须使用与子句中的组窗口函数完全相同的参数来调用辅助函数.</p>
<p>以下示例显示如何在流表上使用组窗口指定 SQL 查询.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders (</span><br><span class="line"> <span class="keyword">user</span>       <span class="type">BIGINT</span>,</span><br><span class="line"> product    STRING,</span><br><span class="line"> amount     <span class="type">INT</span>,</span><br><span class="line"> order_time <span class="type">TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line"> WATERMARK <span class="keyword">FOR</span> order_time <span class="keyword">AS</span> order_time <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">MINUTE</span></span><br><span class="line">) <span class="keyword">WITH</span> (...);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"> <span class="keyword">user</span>,</span><br><span class="line"> TUMBLE_START(order_time, <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">DAY</span>) <span class="keyword">AS</span> wStart,</span><br><span class="line"> <span class="built_in">SUM</span>(amount) <span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line"> TUMBLE(order_time, <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">DAY</span>),</span><br><span class="line"> <span class="keyword">user</span></span><br></pre></td></tr></table></figure>

<h2 id="Group-Aggregation-分组聚合"><a href="#Group-Aggregation-分组聚合" class="headerlink" title="Group Aggregation(分组聚合)"></a>Group Aggregation(分组聚合)</h2><p>Batch Streaming</p>
<p>与大多数数据系统一样,Apache Flink 支持聚合函数.内置和用户定义.<br>用户自定义函数在使用前必须在目录中注册.</p>
<p>聚合函数从多个输入行计算单个结果.<br>例如,有聚合来计算一组行的COUNT/SUM/AVG(平均值)/MAX(最大值)和MIN(最小值).</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(\<span class="operator">*</span>) <span class="keyword">FROM</span> Orders</span><br></pre></td></tr></table></figure>

<p>对于流式查询,重要的是要了解 Flink 运行永不终止的连续查询.<br>相反,它们会根据输入表上的更新来更新结果表.<br>Orders对于上述查询,每次向表中插入新行时,Flink 都会输出一个更新的计数.</p>
<p>Apache Flink 支持GROUP BY聚合数据的标准子句.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> order_id</span><br></pre></td></tr></table></figure>

<p>对于流式查询,计算查询结果所需的状态可能会无限增长.<br>状态大小取决于组的数量以及聚合函数的数量和类型.<br>例如MIN/MAX在状态大小上很重,而COUNT很便宜.<br>您可以提供具有适当状态生存时间 (TTL) 的查询配置,以防止状态大小过大.<br>请注意,这可能会影响查询结果的正确性.<br>有关详细信息,请参阅查询配置.</p>
<p>Apache Flink 为 Group Aggregation 提供了一套性能调优方式,请参阅更多性能调优.</p>
<h3 id="DISTINCT-聚合"><a href="#DISTINCT-聚合" class="headerlink" title="DISTINCT 聚合"></a>DISTINCT 聚合</h3><p>不同的聚合在应用聚合函数之前会删除重复值.<br>以下示例计算不同 order_id 的数量,而不是 Orders 表中的总行数.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> order_id) <span class="keyword">FROM</span> Orders</span><br></pre></td></tr></table></figure>

<p>对于流式查询,计算查询结果所需的状态可能会无限增长.<br>状态大小主要取决于不同行的数量和维护组的时间,短期的按窗口分组不是问题.<br>您可以提供具有适当状态生存时间 (TTL) 的查询配置,以防止状态大小过大.<br>请注意,这可能会影响查询结果的正确性.<br>有关详细信息,请参阅查询配置.</p>
<h3 id="GROUPING-SETS-分组集"><a href="#GROUPING-SETS-分组集" class="headerlink" title="GROUPING SETS(分组集)"></a>GROUPING SETS(分组集)</h3><p>分组集允许比标准描述的更复杂的分组操作GROUP BY.<br>行由每个指定的分组集单独分组,并且为每个组计算聚合,就像简单GROUP BY子句一样.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> supplier_id, rating, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> total</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">VALUES</span></span><br><span class="line">  (<span class="string">&#x27;supplier1&#x27;</span>, <span class="string">&#x27;product1&#x27;</span>, <span class="number">4</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier1&#x27;</span>, <span class="string">&#x27;product2&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier2&#x27;</span>, <span class="string">&#x27;product3&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier2&#x27;</span>, <span class="string">&#x27;product4&#x27;</span>, <span class="number">4</span>))</span><br><span class="line"><span class="keyword">AS</span> Products(supplier_id, product_id, rating)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">GROUPING</span> SETS ((supplier_id, rating), (supplier_id), ())</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------+-------+</span></span><br><span class="line"><span class="operator">|</span> supplier_id <span class="operator">|</span> rating <span class="operator">|</span> total <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------+-------+</span></span><br><span class="line"><span class="operator">|</span>   supplier1 <span class="operator">|</span>      <span class="number">4</span> <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   supplier1 <span class="operator">|</span> (<span class="keyword">NULL</span>) <span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      (<span class="keyword">NULL</span>) <span class="operator">|</span> (<span class="keyword">NULL</span>) <span class="operator">|</span>     <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   supplier1 <span class="operator">|</span>      <span class="number">3</span> <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   supplier2 <span class="operator">|</span>      <span class="number">3</span> <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   supplier2 <span class="operator">|</span> (<span class="keyword">NULL</span>) <span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   supplier2 <span class="operator">|</span>      <span class="number">4</span> <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------+-------+</span></span><br></pre></td></tr></table></figure>

<p>的每个子列表GROUPING SETS可以指定零个或多个列或表达式,其解释方式与直接在GROUP BY子句中使用的方式相同.<br>空分组集意味着所有行都聚合到一个组中,即使不存在输入行也会输出.</p>
<p>对分组列或表达式的引用被替换为结果行中的空值,用于分组集合中没有出现这些列.</p>
<p>对于流式查询,计算查询结果所需的状态可能会无限增长.<br>状态大小取决于组集的数量和聚合函数的类型.<br>您可以提供具有适当状态生存时间 (TTL) 的查询配置,以防止状态大小过大.<br>请注意,这可能会影响查询结果的正确性.<br>有关详细信息,请参阅查询配置.</p>
<h4 id="ROLLUP-汇总-1"><a href="#ROLLUP-汇总-1" class="headerlink" title="ROLLUP(汇总)"></a>ROLLUP(汇总)</h4><p>ROLLUP是用于指定常见类型的分组集的简写符号.<br>它表示给定的表达式列表和列表的所有前缀,包括空列表.</p>
<p>例如,下面的查询等同于上面的查询.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> supplier_id, rating, <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">VALUES</span></span><br><span class="line">  (<span class="string">&#x27;supplier1&#x27;</span>, <span class="string">&#x27;product1&#x27;</span>, <span class="number">4</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier1&#x27;</span>, <span class="string">&#x27;product2&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier2&#x27;</span>, <span class="string">&#x27;product3&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier2&#x27;</span>, <span class="string">&#x27;product4&#x27;</span>, <span class="number">4</span>))</span><br><span class="line"><span class="keyword">AS</span> Products(supplier_id, product_id, rating)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">ROLLUP</span> (supplier_id, rating)</span><br></pre></td></tr></table></figure>

<h4 id="CUBE-立方体-1"><a href="#CUBE-立方体-1" class="headerlink" title="CUBE(立方体)"></a>CUBE(立方体)</h4><p>CUBE是用于指定常见类型的分组集的简写符号.<br>它表示给定列表及其所有可能的子集 - 幂集.</p>
<p>例如,以下两个查询是等效的.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> supplier_id, rating, product_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">VALUES</span></span><br><span class="line">  (<span class="string">&#x27;supplier1&#x27;</span>, <span class="string">&#x27;product1&#x27;</span>, <span class="number">4</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier1&#x27;</span>, <span class="string">&#x27;product2&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier2&#x27;</span>, <span class="string">&#x27;product3&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier2&#x27;</span>, <span class="string">&#x27;product4&#x27;</span>, <span class="number">4</span>))</span><br><span class="line"><span class="keyword">AS</span> Products(supplier_id, product_id, rating)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">CUBE</span> (supplier_id, rating, product_id)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> supplier_id, rating, product_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">VALUES</span></span><br><span class="line">  (<span class="string">&#x27;supplier1&#x27;</span>, <span class="string">&#x27;product1&#x27;</span>, <span class="number">4</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier1&#x27;</span>, <span class="string">&#x27;product2&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier2&#x27;</span>, <span class="string">&#x27;product3&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">  (<span class="string">&#x27;supplier2&#x27;</span>, <span class="string">&#x27;product4&#x27;</span>, <span class="number">4</span>))</span><br><span class="line"><span class="keyword">AS</span> Products(supplier_id, product_id, rating)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">GROUPING</span> <span class="keyword">SET</span> (</span><br><span class="line">  ( supplier_id, product_id, rating ),</span><br><span class="line">  ( supplier_id, product_id         ),</span><br><span class="line">  ( supplier_id,             rating ),</span><br><span class="line">  ( supplier_id                     ),</span><br><span class="line">  (              product_id, rating ),</span><br><span class="line">  (              product_id         ),</span><br><span class="line">  (                          rating ),</span><br><span class="line">  (                                 )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="HAVING-拥有"><a href="#HAVING-拥有" class="headerlink" title="HAVING(拥有)"></a>HAVING(拥有)</h3><p>HAVING消除不满足条件的组行.<br>HAVING不同于WHERE:在while过滤器组创建的WHERE行之前过滤单个行.<br>条件中引用的每一列都必须明确引用一个分组列,除非它出现在聚合函数中.<br>GROUP BYHAVINGGROUP BY</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount)</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> users</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">SUM</span>(amount) <span class="operator">&gt;</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>

<p>HAVING即使没有GROUP BY子句,存在也会将查询变成分组查询.<br>GROUP BY这与查询包含聚合函数但没有子句时发生的情况相同.<br>该查询将所有选定的行视为一个组,并且SELECT列表和HAVING子句只能从聚合函数中引用表列.<br>如果条件为真,这样的查询将发出单行,如果HAVING条件不真,则发出零行.</p>
<h2 id="Over-Aggregation"><a href="#Over-Aggregation" class="headerlink" title="Over Aggregation"></a>Over Aggregation</h2><p>Batch Streaming</p>
<p>OVER聚合为一系列有序行上的每个输入行计算一个聚合值.<br>与GROUP BY聚合相比,OVER聚合不会将每个组的结果行数减少到一行.<br>相反OVER,聚合为每个输入行生成一个聚合值.</p>
<p>以下查询为每个订单计算在当前订单前一小时内收到的同一产品的所有订单金额的总和.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id, order_time, amount,</span><br><span class="line"> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span> (</span><br><span class="line">  <span class="keyword">PARTITION</span> <span class="keyword">BY</span> product</span><br><span class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_time</span><br><span class="line">  <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">HOUR</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line"> ) <span class="keyword">AS</span> one_hour_prod_amount_sum</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br></pre></td></tr></table></figure>

<p>窗口的语法OVER总结如下.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"> agg_func(agg_col) <span class="keyword">OVER</span> (</span><br><span class="line">  [<span class="keyword">PARTITION</span> <span class="keyword">BY</span> col1[, col2, ...]]</span><br><span class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> time_col</span><br><span class="line">  range_definition),</span><br><span class="line"> ...</span><br><span class="line"><span class="keyword">FROM</span> ...</span><br></pre></td></tr></table></figure>

<p>您可以在一个子句中定义多个OVER窗口聚合.<br>SELECT但是,对于流式查询,OVER由于当前的限制,所有聚合的窗口必须相同.</p>
<h3 id="ORDER-BY"><a href="#ORDER-BY" class="headerlink" title="ORDER BY"></a>ORDER BY</h3><p>OVER窗口是在有序的行序列上定义的.<br>由于表没有内在顺序,因此该ORDER BY子句是强制性的.<br>对于流式查询,Flink 目前只支持按时间属性OVER升序定义的窗口.<br>不支持额外订购.</p>
<h3 id="PARTITION-BY"><a href="#PARTITION-BY" class="headerlink" title="PARTITION BY"></a>PARTITION BY</h3><p>OVER可以在分区表上定义窗口.<br>在存在PARTITION BY子句的情况下,仅在其分区的行上为每个输入行计算聚合.</p>
<h3 id="Range-Definitions-范围定义"><a href="#Range-Definitions-范围定义" class="headerlink" title="Range Definitions(范围定义)"></a>Range Definitions(范围定义)</h3><p>范围定义指定聚合中包含多少行.<br>范围由定义BETWEEN下限和上限的子句定义.<br>这些边界之间的所有行都包含在聚合中.<br>Flink 只支持CURRENT ROW作为上边界.</p>
<p>有两个选项来定义范围,ROWS间隔和RANGE间隔.</p>
<h4 id="RANGE-intervals-范围间隔"><a href="#RANGE-intervals-范围间隔" class="headerlink" title="RANGE intervals(范围间隔)"></a>RANGE intervals(范围间隔)</h4><p>RANGE间隔是在 ORDER BY 列的值上定义的,在 Flink 的情况下总是一个时间属性.<br>以下 RANGE 间隔定义时间属性最多比当前行少 30 分钟的所有行都包含在聚合中.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="type">INTERVAL</span> <span class="string">&#x27;30&#x27;</span> <span class="keyword">MINUTE</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br></pre></td></tr></table></figure>

<h4 id="ROW-intervals-行间隔"><a href="#ROW-intervals-行间隔" class="headerlink" title="ROW intervals(行间隔)"></a>ROW intervals(行间隔)</h4><p>ROWS间隔是基于计数的间隔.<br>它准确定义了聚合中包含的行数.<br>以下ROWS间隔定义当前行和当前行之前的 10 行(因此总共 11 行)包含在聚合中.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">10</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">WINDOW</span></span><br></pre></td></tr></table></figure>

<p>该WINDOW子句可用于在OVER该子句之外定义一个窗口SELECT.<br>它可以使查询更具可读性,还允许我们为多个聚合重用窗口定义.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id, order_time, amount,</span><br><span class="line"> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span> w <span class="keyword">AS</span> sum_amount,</span><br><span class="line"> <span class="built_in">AVG</span>(amount) <span class="keyword">OVER</span> w <span class="keyword">AS</span> avg_amount</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">WINDOW</span> w <span class="keyword">AS</span> (</span><br><span class="line"> <span class="keyword">PARTITION</span> <span class="keyword">BY</span> product</span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_time</span><br><span class="line"> <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">HOUR</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Joins"><a href="#Joins" class="headerlink" title="Joins"></a>Joins</h2><p>Batch Streaming</p>
<p>Flink SQL 支持对动态表进行复杂灵活的连接操作.<br>有几种不同类型的连接来解决可能需要的各种语义查询.</p>
<p>默认情况下,连接顺序未优化.<br>FROM表按照在子句中指定的顺序连接.<br>您可以调整连接查询的性能,首先列出更新频率最低的表,最后列出更新频率最高的表.<br>确保以不产生交叉连接(笛卡尔积)的顺序指定表,交叉连接不受支持,会导致查询失败.</p>
<h3 id="Regular-Joins-常规连接"><a href="#Regular-Joins-常规连接" class="headerlink" title="Regular Joins(常规连接)"></a>Regular Joins(常规连接)</h3><p>常规联接是最通用的联接类型,其中任何新记录或对联接任一侧的更改都是可见的,并且会影响整个联接结果.<br>例如,如果左侧有一条新记录,则当产品 id 相等时,它将与右侧的所有先前和将来的记录连接.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Product</span><br><span class="line"><span class="keyword">ON</span> Orders.productId <span class="operator">=</span> Product.id</span><br></pre></td></tr></table></figure>

<p>对于流式查询,常规连接的语法是最灵活的,并且允许任何类型的更新(插入/更新/删除)输入表.<br>但是,此操作具有重要的操作含义:它需要将连接输入的双方永远保持在 Flink 状态.<br>因此,计算查询结果所需的状态可能会无限增长,具体取决于所有输入表的不同输入行数和中间连接结果.<br>您可以提供具有适当状态生存时间 (TTL) 的查询配置,以防止状态大小过大.<br>请注意,这可能会影响查询结果的正确性.<br>有关详细信息,请参阅查询配置.</p>
<p>对于流式查询,计算查询结果所需的状态可能会无限增长,具体取决于聚合类型和不同分组键的数量.<br>请提供空闲状态保留时间以防止状态大小过大.<br>有关详细信息,请参阅空闲状态保留时间.</p>
<h4 id="INNER-Equi-JOIN"><a href="#INNER-Equi-JOIN" class="headerlink" title="INNER Equi-JOIN"></a>INNER Equi-JOIN</h4><p>返回受连接条件限制的简单笛卡尔积.<br>目前,仅支持等值连接,即具有至少一个具有等式谓词的合取条件的连接.<br>不支持任意交叉或 theta 连接.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Product</span><br><span class="line"><span class="keyword">ON</span> Orders.product_id <span class="operator">=</span> Product.id</span><br></pre></td></tr></table></figure>

<h4 id="OUTER-Equi-JOIN"><a href="#OUTER-Equi-JOIN" class="headerlink" title="OUTER Equi-JOIN"></a>OUTER Equi-JOIN</h4><p>返回合格笛卡尔积中的所有行(即所有通过其连接条件的组合行),加上外部表中连接条件与其他表的任何行都不匹配的每一行的一个副本.<br>Flink 支持 LEFT/RIGHT 和 FULL 外连接.<br>目前,仅支持等值连接,即与至少一个具有等式谓词的连接条件连接.<br>不支持任意交叉或 theta 连接.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> Product</span><br><span class="line"><span class="keyword">ON</span> Orders.product_id <span class="operator">=</span> Product.id</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> Product</span><br><span class="line"><span class="keyword">ON</span> Orders.product_id <span class="operator">=</span> Product.id</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">FULL</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> Product</span><br><span class="line"><span class="keyword">ON</span> Orders.product_id <span class="operator">=</span> Product.id</span><br></pre></td></tr></table></figure>

<h3 id="Interval-Joins-间隔连接"><a href="#Interval-Joins-间隔连接" class="headerlink" title="Interval Joins(间隔连接)"></a>Interval Joins(间隔连接)</h3><p>返回受连接条件和时间约束限制的简单笛卡尔积.<br>间隔连接至少需要一个等连接谓词和一个限制双方时间的连接条件.<br>两个适当的范围谓词可以定义这样的条件(&lt;/&lt;=/&gt;=/&gt;)/BETWEEN 谓词或比较两个输入的相同类型的时间属性(即处理时间或事件时间)的单个等式谓词表.</p>
<p>例如,如果订单在收到订单四小时后发货,则此查询将连接所有订单及其相应的发货.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Orders o, Shipments s</span><br><span class="line"><span class="keyword">WHERE</span> o.id <span class="operator">=</span> s.order_id</span><br><span class="line"><span class="keyword">AND</span> o.order_time <span class="keyword">BETWEEN</span> s.ship_time <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;4&#x27;</span> <span class="keyword">HOUR</span> <span class="keyword">AND</span> s.ship_time</span><br></pre></td></tr></table></figure>

<p>以下谓词是有效区间连接条件的示例:<br>ltime = rtime<br>ltime &gt;= rtime AND ltime &lt; rtime + INTERVAL &#39;10&#39; MINUTE<br>ltime BETWEEN rtime - INTERVAL &#39;10&#39; SECOND AND rtime + INTERVAL &#39;5&#39; SECOND</p>
<p>对于流式查询,与常规联接相比,间隔联接仅支持具有时间属性的仅追加表.<br>由于时间属性是准单调递增的,因此 Flink 可以从其状态中移除旧值而不影响结果的正确性.</p>
<h3 id="Temporal-Joins-时间连接"><a href="#Temporal-Joins-时间连接" class="headerlink" title="Temporal Joins(时间连接)"></a>Temporal Joins(时间连接)</h3><p>Temporal table 是随时间演变的表——在 Flink 中也称为动态表.<br>时态表中的行与一个或多个时态周期相关联,并且所有 Flink 表都是时态的(动态的).<br>时态表包含一个或多个版本化的表快照,它可以是跟踪更改的更改历史表(例如数据库更改日志,包含所有快照)或实现更改的更改维度表(例如包含最新快照的数据库表) .</p>
<h4 id="Event-Time-Temporal-Join-事件时间临时加入"><a href="#Event-Time-Temporal-Join-事件时间临时加入" class="headerlink" title="Event Time Temporal Join(事件时间临时加入)"></a>Event Time Temporal Join(事件时间临时加入)</h4><p>事件时间时态连接允许对一个版本化的表进行连接.<br>这意味着可以通过更改元数据来丰富表,并在某个时间点检索其值.</p>
<p>时间连接采用任意表(左侧输入/探测站点)并将每一行与版本化表(右侧输入/构建侧)中相应行的相关版本相关联.<br>Flink 使用FOR SYSTEM_TIME AS OFSQL:2011 标准中的 SQL 语法来执行此操作.<br>时间连接的语法如下.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [column_list]</span><br><span class="line"><span class="keyword">FROM</span> table1 [<span class="keyword">AS</span> <span class="operator">&lt;</span>alias1<span class="operator">&gt;</span>]</span><br><span class="line">[LEFT] JOIN table2 FOR SYSTEM_TIME AS OF table1.&#123; proctime | rowtime &#125; [AS &lt;alias2&gt;]</span><br><span class="line"><span class="keyword">ON</span> table1.column<span class="operator">-</span>name1 <span class="operator">=</span> table2.column<span class="operator">-</span>name1</span><br></pre></td></tr></table></figure>

<p>使用事件时间属性(即行时间属性),可以检索过去某个时间点的键值.<br>这允许在一个共同的时间点连接两个表.<br>版本化表将存储自上次水印以来的所有版本(按时间标识).</p>
<p>例如,假设我们有一个订单表,每个订单都有不同货币的价格.<br>为了将该表正确规范化为单一货币,例如美元,每个订单都需要与下订单时的正确货币兑换率相连接.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Create a table of orders. This is a standard</span></span><br><span class="line"><span class="comment">-- append-only dynamic table.</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders (</span><br><span class="line">  order_id    STRING,</span><br><span class="line">  price       <span class="type">DECIMAL</span>(<span class="number">32</span>,<span class="number">2</span>),</span><br><span class="line">  currency    STRING,</span><br><span class="line">  order_time  <span class="type">TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">  WATERMARK <span class="keyword">FOR</span> order_time <span class="keyword">AS</span> order_time</span><br><span class="line">) <span class="keyword">WITH</span> (<span class="comment">/* ... */</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Define a versioned table of currency rates. </span></span><br><span class="line"><span class="comment">-- This could be from a change-data-capture</span></span><br><span class="line"><span class="comment">-- such as Debezium, a compacted Kafka topic, or any other</span></span><br><span class="line"><span class="comment">-- way of defining a versioned table. </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> currency_rates (</span><br><span class="line">  currency STRING,</span><br><span class="line">  conversion_rate <span class="type">DECIMAL</span>(<span class="number">32</span>, <span class="number">2</span>),</span><br><span class="line">  update_time <span class="type">TIMESTAMP</span>(<span class="number">3</span>) METADATA <span class="keyword">FROM</span> `values.source.timestamp` VIRTUAL,</span><br><span class="line">  WATERMARK <span class="keyword">FOR</span> update_time <span class="keyword">AS</span> update_time,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY(currency) <span class="keyword">NOT</span> ENFORCED</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">  <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;kafka&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;value.format&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;debezium-json&#x27;</span>,</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">   order_id,</span><br><span class="line">   price,</span><br><span class="line">   currency,</span><br><span class="line">   conversion_rate,</span><br><span class="line">   order_time</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> currency_rates <span class="keyword">FOR</span> <span class="built_in">SYSTEM_TIME</span> <span class="keyword">AS</span> <span class="keyword">OF</span> orders.order_time</span><br><span class="line"><span class="keyword">ON</span> orders.currency <span class="operator">=</span> currency_rates.currency;</span><br><span class="line"></span><br><span class="line">order_id  price  currency  conversion_rate  order_time</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>  <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>  <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>  <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>  <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">o_001     <span class="number">11.11</span>  EUR       <span class="number">1.14</span>             <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">o_002     <span class="number">12.51</span>  EUR       <span class="number">1.10</span>             <span class="number">12</span>:<span class="number">06</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>注意: event-time temporal join 是由左右两侧的 watermark 触发的.请确保连接的两边都正确设置了水印.<br>注意: event-time temporal join需要temporal join条件的等价条件中包含的主键,例如,要在条件中约束currency_rates.currency表的主键.<br>currency_ratesorders.currency = currency_rates.currency</p>
<p>与常规连接相比,尽管构建端发生了变化,但之前的时态表结果不会受到影响.<br>与间隔连接相比,时态表连接不定义记录将在其中连接的时间窗口.<br>来自探测端的记录总是在时间属性指定的时间与构建端的版本连接.<br>因此,构建端的行可能是任意旧的.<br>随着时间的推移,不再需要的记录版本(对于给定的主键)将从状态中删除.</p>
<h4 id="Processing-Time-Temporal-Join-处理时间临时加入"><a href="#Processing-Time-Temporal-Join-处理时间临时加入" class="headerlink" title="Processing Time Temporal Join(处理时间临时加入)"></a>Processing Time Temporal Join(处理时间临时加入)</h4><p>处理时间时态表连接使用处理时间属性将行与外部版本化表中键的最新版本相关联.</p>
<p>根据定义,使用处理时间属性,连接将始终返回给定键的最新值.<br>可以将查找表视为一个简单的 <code>HashMap&lt;K, V&gt;</code> ,它存储来自构建端的所有记录.<br>这种连接的强大之处在于,当无法将表具体化为 Flink 中的动态表时,它允许 Flink 直接针对外部系统工作.</p>
<p>以下处理时时态表联接示例显示了orders应与表联接的仅追加表LatestRates.<br>LatestRates是以最新速率具体化的维度表(例如 HBase 表).<br>在时间10:15, 10:30, 10:52, 看起来的内容LatestRates如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">15</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> LatestRates;</span><br><span class="line"></span><br><span class="line">currency   rate</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span> <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">US Dollar   <span class="number">102</span></span><br><span class="line">Euro        <span class="number">114</span></span><br><span class="line">Yen           <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">10</span>:<span class="number">30</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> LatestRates;</span><br><span class="line"></span><br><span class="line">currency   rate</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span> <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">US Dollar   <span class="number">102</span></span><br><span class="line">Euro        <span class="number">114</span></span><br><span class="line">Yen           <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">10</span>:<span class="number">52</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> LatestRates;</span><br><span class="line"></span><br><span class="line">currency   rate</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span> <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">US Dollar   <span class="number">102</span></span><br><span class="line">Euro        <span class="number">116</span>     <span class="operator">&lt;=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span> changed <span class="keyword">from</span> <span class="number">114</span> <span class="keyword">to</span> <span class="number">116</span></span><br><span class="line">Yen           <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>LastestRates有时10:15和的内容10:30是相等的.<br>欧元汇率从 114 变为 116 在10:52.</p>
<p>Ordersamount是一个仅附加表,表示给定和给定的付款currency.<br>例如,在10:15有一个金额为 的订单2 Euro.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Orders;</span><br><span class="line"></span><br><span class="line">amount currency</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span> <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">   <span class="number">2</span> Euro             <span class="operator">&lt;=</span><span class="operator">=</span> arrived <span class="keyword">at</span> <span class="type">time</span> <span class="number">10</span>:<span class="number">15</span></span><br><span class="line">   <span class="number">1</span> US Dollar        <span class="operator">&lt;=</span><span class="operator">=</span> arrived <span class="keyword">at</span> <span class="type">time</span> <span class="number">10</span>:<span class="number">30</span></span><br><span class="line">   <span class="number">2</span> Euro             <span class="operator">&lt;=</span><span class="operator">=</span> arrived <span class="keyword">at</span> <span class="type">time</span> <span class="number">10</span>:<span class="number">52</span></span><br></pre></td></tr></table></figure>

<p>鉴于这些表格,我们想计算所有Orders转换为共同货币的.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">amount currency     rate   amount*rate</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">   2 Euro          114          228    &lt;&#x3D;&#x3D; arrived at time 10:15</span><br><span class="line">   1 US Dollar     102          102    &lt;&#x3D;&#x3D; arrived at time 10:30</span><br><span class="line">   2 Euro          116          232    &lt;&#x3D;&#x3D; arrived at time 10:52</span><br></pre></td></tr></table></figure>

<p>目前,FOR SYSTEM_TIME AS OF暂时不支持与任何视图/表的最新版本进行时态连接的语法,您可以使用时态表函数语法,如下所示:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"> o_amount, r_rate</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line"> Orders,</span><br><span class="line"> <span class="keyword">LATERAL</span> <span class="keyword">TABLE</span> (Rates(o_proctime))</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line"> r_currency <span class="operator">=</span> o_currency</span><br></pre></td></tr></table></figure>

<p>注意:不支持与任何表/视图的最新版本进行时间连接的语法的原因FOR SYSTEM_TIME AS OF只是语义考虑,因为左流的连接处理不会等待时间表的完整快照,这可能会误导用户在生产环境中.<br>时态表函数的处理时时态连接也存在同样的语义问题,但它已经存在了很长时间,因此我们从兼容性的角度来支持它.</p>
<p>结果对于处理时间是不确定的.<br>处理时时间连接最常用于通过外部表(即维度表)丰富流.</p>
<p>与常规连接相比,尽管构建端发生了变化,但之前的时态表结果不会受到影响.<br>与间隔连接相比,时态表连接没有定义记录连接的时间窗口,即旧行不存储在状态中.</p>
<h4 id="Temporal-Table-Function-Join-时态表函数连接"><a href="#Temporal-Table-Function-Join-时态表函数连接" class="headerlink" title="Temporal Table Function Join(时态表函数连接)"></a>Temporal Table Function Join(时态表函数连接)</h4><p>使用时态表函数连接表的语法与使用表函数连接的语法相同.</p>
<p>注意:目前仅支持带有时态表的内连接和左外连接.</p>
<p>假设 Rates 是一个时态表函数,则连接可以用 SQL 表示如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"> o_amount, r_rate</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line"> Orders,</span><br><span class="line"> <span class="keyword">LATERAL</span> <span class="keyword">TABLE</span> (Rates(o_proctime))</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line"> r_currency <span class="operator">=</span> o_currency</span><br></pre></td></tr></table></figure>

<p>上述 Temporal Table DDL 和 Temporal Table Function 的主要区别是:<br>时态表 DDL 可以在 SQL 中定义,但时态表函数不能.<br>temporal table DDL 和 temporal table function 都支持 temporal join versioned table,但只有 temporal table function 可以 temporal join 任何 table/view 的最新版本.</p>
<h3 id="Lookup-Join-查找加入"><a href="#Lookup-Join-查找加入" class="headerlink" title="Lookup Join(查找加入)"></a>Lookup Join(查找加入)</h3><p>查找连接通常用于使用从外部系统查询的数据来丰富表.<br>联接要求一个表具有处理时间属性,而另一个表由查找源连接器支持.</p>
<p>查找连接使用上面的处理时间临时连接语法和由查找源连接器支持的正确表.</p>
<p>以下示例显示了指定查找连接的语法.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Customers is backed by the JDBC connector and can be used for lookup joins</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> Customers (</span><br><span class="line"> id <span class="type">INT</span>,</span><br><span class="line"> name STRING,</span><br><span class="line"> country STRING,</span><br><span class="line"> zip STRING</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line"> <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;url&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc:mysql://mysqlhost:3306/customerdb&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;table-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;customers&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- enrich each order with customer information</span></span><br><span class="line"><span class="keyword">SELECT</span> o.order_id, o.total, c.country, c.zip</span><br><span class="line"><span class="keyword">FROM</span> Orders <span class="keyword">AS</span> o</span><br><span class="line"> <span class="keyword">JOIN</span> Customers <span class="keyword">FOR</span> <span class="built_in">SYSTEM_TIME</span> <span class="keyword">AS</span> <span class="keyword">OF</span> o.proc_time <span class="keyword">AS</span> c</span><br><span class="line">  <span class="keyword">ON</span> o.customer_id <span class="operator">=</span> c.id;</span><br></pre></td></tr></table></figure>

<p>在上面的示例中,Orders 表中包含来自 MySQL 数据库中的 Customers 表的数据.<br>具有后续处理时间属性的FOR SYSTEM_TIME AS OF子句确保表的每一行在连接运算符处理行Orders的时间点与那些匹配连接谓词的客户行连接.<br>Orders它还可以防止Customer在将来更新连接行时更新连接结果.<br>在上面的示例中,查找连接还需要一个强制相等连接谓词o.customer_id = c.id.</p>
<h3 id="Array-Expansion-数组扩展"><a href="#Array-Expansion-数组扩展" class="headerlink" title="Array Expansion(数组扩展)"></a>Array Expansion(数组扩展)</h3><p>为给定数组中的每个元素返回一个新行.<br>尚不WITH ORDINALITY支持取消嵌套.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id, tag</span><br><span class="line"><span class="keyword">FROM</span> Orders <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> <span class="built_in">UNNEST</span>(tags) <span class="keyword">AS</span> t (tag)</span><br></pre></td></tr></table></figure>

<h3 id="Table-Function-表函数"><a href="#Table-Function-表函数" class="headerlink" title="Table Function(表函数)"></a>Table Function(表函数)</h3><p>将表与表函数的结果连接起来.<br>左(外)表的每一行都与表函数的相应调用产生的所有行连接.<br>用户定义的表函数必须在使用前注册.</p>
<h4 id="INNER-JOIN-内连接"><a href="#INNER-JOIN-内连接" class="headerlink" title="INNER JOIN(内连接)"></a>INNER JOIN(内连接)</h4><p>如果其表函数调用返回空结果,则删除左(外)表的行.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id, res</span><br><span class="line"><span class="keyword">FROM</span> Orders,</span><br><span class="line"><span class="keyword">LATERAL</span> <span class="keyword">TABLE</span>(table_func(order_id)) t(res)</span><br></pre></td></tr></table></figure>

<h4 id="LEFT-OUTER-JOIN-左外连接"><a href="#LEFT-OUTER-JOIN-左外连接" class="headerlink" title="LEFT OUTER JOIN(左外连接)"></a>LEFT OUTER JOIN(左外连接)</h4><p>如果表函数调用返回空结果,则保留相应的外部行,并用空值填充结果.<br>目前,针对横向表的左外连接需要 ON 子句中的 TRUE 文字.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id, res</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> <span class="keyword">LATERAL</span> <span class="keyword">TABLE</span>(table_func(order_id)) t(res)</span><br><span class="line"> <span class="keyword">ON</span> <span class="literal">TRUE</span></span><br></pre></td></tr></table></figure>

<h2 id="Window-Join-窗口关联"><a href="#Window-Join-窗口关联" class="headerlink" title="Window Join(窗口关联)"></a>Window Join(窗口关联)</h2><p>Batch Streaming</p>
<p>窗口连接将时间维度添加到连接标准本身.<br>这样做时,窗口连接将两个流的元素连接起来,这两个流共享一个公共键并且在同一个窗口中.<br>窗口连接的语义与DataStream 窗口连接的语义相同</p>
<p>对于流式查询,与连续表上的其他连接不同,窗口连接不会发出中间结果,而只会在窗口结束时发出最终结果.<br>此外,窗口连接会在不再需要时清除所有中间状态.</p>
<p>通常,Window Join 与Windowing TVF一起使用.<br>此外,Window Join 可以在其他基于Windowing TVF的操作之后进行,例如Window Aggregation/Window TopN和Window Join.</p>
<p>目前,Window Join 要求 join on 条件包含输入表的窗口开始相等和输入表的窗口结束相等.</p>
<p>Window Join 支持 INNER/LEFT/RIGHT/FULL OUTER/ANTI/SEMI JOIN.</p>
<h3 id="INNER-LEFT-RIGHT-FULL-OUTER-内-左-右-全外"><a href="#INNER-LEFT-RIGHT-FULL-OUTER-内-左-右-全外" class="headerlink" title="INNER/LEFT/RIGHT/FULL OUTER(内/左/右/全外)"></a>INNER/LEFT/RIGHT/FULL OUTER(内/左/右/全外)</h3><p>下面显示了 INNER/LEFT/RIGHT/FULL OUTER Window Join 语句的语法.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...</span><br><span class="line"><span class="keyword">FROM</span> L [<span class="keyword">LEFT</span><span class="operator">|</span><span class="keyword">RIGHT</span><span class="operator">|</span><span class="keyword">FULL</span> <span class="keyword">OUTER</span>] <span class="keyword">JOIN</span> R <span class="comment">-- L and R are relations applied windowing TVF</span></span><br><span class="line"><span class="keyword">ON</span> L.window_start <span class="operator">=</span> R.window_start <span class="keyword">AND</span> L.window_end <span class="operator">=</span> R.window_end <span class="keyword">AND</span> ...</span><br></pre></td></tr></table></figure>

<p>INNER/LEFT/RIGHT/FULL OUTER WINDOW JOIN 的语法非常相似,这里我们只举一个FULL OUTER JOIN 的例子.<br>执行窗口连接时,所有具有公共键和公共翻转窗口的元素都会连接在一起.<br>我们仅给出一个适用于 Tumble Window TVF 的 Window Join 示例.<br>通过将连接的时间区域限定为固定的五分钟间隔,我们将数据集切分为两个不同的时间窗口:[12:00, 12:05) 和 [12:05, 12:10).<br>L2 和 R2 行无法连接在一起,因为它们落入单独的窗口中.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> LeftTable;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------------------+------+-----+--------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span>     name <span class="operator">|</span>                   type <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span> key <span class="operator">|</span> extras <span class="operator">|</span>                        watermark <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------------------+------+-----+--------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> row_time <span class="operator">|</span> <span class="type">TIMESTAMP</span>(<span class="number">3</span>) <span class="operator">*</span>ROWTIME<span class="operator">*</span> <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span> `row_time` <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">SECOND</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      num <span class="operator">|</span>                    <span class="type">INT</span> <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       id <span class="operator">|</span>                 STRING <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------------------+------+-----+--------+----------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> LeftTable;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+</span></span><br><span class="line"><span class="operator">|</span>         row_time <span class="operator">|</span> num <span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">02</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> L1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">06</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> L2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">03</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> L3 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">desc</span> RightTable;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------------------+------+-----+--------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span>     name <span class="operator">|</span>                   type <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span> key <span class="operator">|</span> extras <span class="operator">|</span>                        watermark <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------------------+------+-----+--------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> row_time <span class="operator">|</span> <span class="type">TIMESTAMP</span>(<span class="number">3</span>) <span class="operator">*</span>ROWTIME<span class="operator">*</span> <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span> `row_time` <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">SECOND</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      num <span class="operator">|</span>                    <span class="type">INT</span> <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       id <span class="operator">|</span>                 STRING <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------------------+------+-----+--------+----------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> RightTable;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+</span></span><br><span class="line"><span class="operator">|</span>         row_time <span class="operator">|</span> num <span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">01</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> R2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">04</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> R3 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> R4 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> L.num <span class="keyword">as</span> L_Num, L.id <span class="keyword">as</span> L_Id, R.num <span class="keyword">as</span> R_Num, R.id <span class="keyword">as</span> R_Id, L.window_start, L.window_end</span><br><span class="line">         <span class="keyword">FROM</span> (</span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> LeftTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">         ) L</span><br><span class="line">         <span class="keyword">FULL</span> <span class="keyword">JOIN</span> (</span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> RightTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">         ) R</span><br><span class="line">         <span class="keyword">ON</span> L.num <span class="operator">=</span> R.num <span class="keyword">AND</span> L.window_start <span class="operator">=</span> R.window_start <span class="keyword">AND</span> L.window_end <span class="operator">=</span> R.window_end;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+-------+------+------------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> L_Num <span class="operator">|</span> L_Id <span class="operator">|</span> R_Num <span class="operator">|</span> R_Id <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+-------+------+------------------+------------------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>   L1 <span class="operator">|</span>  <span class="keyword">null</span> <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="keyword">null</span> <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span>   R2 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">3</span> <span class="operator">|</span>   L3 <span class="operator">|</span>     <span class="number">3</span> <span class="operator">|</span>   R3 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span>   L2 <span class="operator">|</span>  <span class="keyword">null</span> <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="keyword">null</span> <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span>     <span class="number">4</span> <span class="operator">|</span>   R4 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+-------+------+------------------+------------------+</span></span><br></pre></td></tr></table></figure>

<p>注意:为了更好地理解窗口化的行为,我们简化了时间戳值的显示以不显示尾随零,例如如果类型为 ,2020-04-15 08:05则应显示为2020-04-15 08:05:00.000在 Flink SQL Client 中TIMESTAMP(3).</p>
<h3 id="SEMI"><a href="#SEMI" class="headerlink" title="SEMI"></a>SEMI</h3><p>如果公共窗口的右侧至少有一个匹配行,则半窗口连接从一个左侧记录返回一行.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">         <span class="keyword">FROM</span> (</span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> LeftTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">         ) L <span class="keyword">WHERE</span> L.num <span class="keyword">IN</span> (</span><br><span class="line">           <span class="keyword">SELECT</span> num <span class="keyword">FROM</span> (   </span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> RightTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">           ) R <span class="keyword">WHERE</span> L.window_start <span class="operator">=</span> R.window_start <span class="keyword">AND</span> L.window_end <span class="operator">=</span> R.window_end);</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span>         row_time <span class="operator">|</span> num <span class="operator">|</span> id <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span>            window_time  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">03</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> L3 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">         <span class="keyword">FROM</span> (</span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> LeftTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">         ) L <span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">           <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> RightTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">           ) R <span class="keyword">WHERE</span> L.num <span class="operator">=</span> R.num <span class="keyword">AND</span> L.window_start <span class="operator">=</span> R.window_start <span class="keyword">AND</span> L.window_end <span class="operator">=</span> R.window_end);</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span>         row_time <span class="operator">|</span> num <span class="operator">|</span> id <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span>            window_time  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">03</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> L3 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br></pre></td></tr></table></figure>

<p>注意:为了更好地理解窗口化的行为,我们简化了时间戳值的显示以不显示尾随零,例如如果类型为 ,2020-04-15 08:05则应显示为2020-04-15 08:05:00.000在 Flink SQL Client 中TIMESTAMP(3).</p>
<h3 id="ANTI"><a href="#ANTI" class="headerlink" title="ANTI"></a>ANTI</h3><p>Anti Window Joins 是 Inner Window Join 的反面:它们包含每个公共窗口中的所有未连接行.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">         <span class="keyword">FROM</span> (</span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> LeftTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">         ) L <span class="keyword">WHERE</span> L.num <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">           <span class="keyword">SELECT</span> num <span class="keyword">FROM</span> (   </span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> RightTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">           ) R <span class="keyword">WHERE</span> L.window_start <span class="operator">=</span> R.window_start <span class="keyword">AND</span> L.window_end <span class="operator">=</span> R.window_end);</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span>         row_time <span class="operator">|</span> num <span class="operator">|</span> id <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span>            window_time  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">02</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> L1 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">06</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> L2 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">         <span class="keyword">FROM</span> (</span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> LeftTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">         ) L <span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">           <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">             <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(TUMBLE(<span class="keyword">TABLE</span> RightTable, DESCRIPTOR(row_time), <span class="type">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> MINUTES))</span><br><span class="line">           ) R <span class="keyword">WHERE</span> L.num <span class="operator">=</span> R.num <span class="keyword">AND</span> L.window_start <span class="operator">=</span> R.window_start <span class="keyword">AND</span> L.window_end <span class="operator">=</span> R.window_end);</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span>         row_time <span class="operator">|</span> num <span class="operator">|</span> id <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span>            window_time  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">02</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> L1 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">06</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> L2 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">05</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">59.999</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----+------------------+------------------+-------------------------+</span></span><br></pre></td></tr></table></figure>

<p>注意:为了更好地理解窗口化的行为,我们简化了时间戳值的显示以不显示尾随零,例如如果类型为 ,2020-04-15 08:05则应显示为2020-04-15 08:05:00.000在 Flink SQL Client 中TIMESTAMP(3).</p>
<h3 id="Limitation"><a href="#Limitation" class="headerlink" title="Limitation"></a>Limitation</h3><h4 id="Join-子句的限制"><a href="#Join-子句的限制" class="headerlink" title="Join 子句的限制"></a>Join 子句的限制</h4><p>目前,窗口连接要求连接条件包含输入表的窗口开始相等和输入表的窗口结束相等.<br>将来,如果开窗 TVF 是 TUMBLE 或 HOP,我们还可以简化 join on 子句以仅包含窗口开始相等性.</p>
<h4 id="输入窗口-TVF-的限制"><a href="#输入窗口-TVF-的限制" class="headerlink" title="输入窗口 TVF 的限制"></a>输入窗口 TVF 的限制</h4><p>目前,左右输入的窗口 TVF 必须相同.<br>这可以在将来扩展,例如,翻滚窗口加入具有相同窗口大小的滑动窗口.</p>
<h4 id="在直接对-TVF-进行窗口化之后-对-Window-Join-的限制"><a href="#在直接对-TVF-进行窗口化之后-对-Window-Join-的限制" class="headerlink" title="在直接对 TVF 进行窗口化之后,对 Window Join 的限制"></a>在直接对 TVF 进行窗口化之后,对 Window Join 的限制</h4><p>目前,如果在Windowing TVF之后跟随 Window Join ,则Windowing TVF必须使用 Tumble Windows/Hop Windows 或 Cumulate Windows 而不是 Session 窗口.</p>
<h2 id="Set-Operations-集合操作"><a href="#Set-Operations-集合操作" class="headerlink" title="Set Operations(集合操作)"></a>Set Operations(集合操作)</h2><p>Batch Streaming</p>
<h3 id="UNION-联合"><a href="#UNION-联合" class="headerlink" title="UNION(联合)"></a>UNION(联合)</h3><p>UNION并UNION ALL返回在任一表中找到的行.<br>UNION只取不同的行,而UNION ALL不会从结果行中删除重复项.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> t1(s) <span class="keyword">as</span> <span class="keyword">values</span> (<span class="string">&#x27;c&#x27;</span>), (<span class="string">&#x27;a&#x27;</span>), (<span class="string">&#x27;b&#x27;</span>), (<span class="string">&#x27;b&#x27;</span>), (<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> t2(s) <span class="keyword">as</span> <span class="keyword">values</span> (<span class="string">&#x27;d&#x27;</span>), (<span class="string">&#x27;e&#x27;</span>), (<span class="string">&#x27;a&#x27;</span>), (<span class="string">&#x27;b&#x27;</span>), (<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t1) <span class="keyword">UNION</span> (<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t2);</span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span>  s<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span>  c<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  a<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  b<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  d<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  e<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t1) <span class="keyword">UNION</span> <span class="keyword">ALL</span> (<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t2);</span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span>  c<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span>  c<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  a<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  b<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  b<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  c<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  d<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  e<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  a<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  b<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  b<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br></pre></td></tr></table></figure>

<h3 id="INTERSECT-相交"><a href="#INTERSECT-相交" class="headerlink" title="INTERSECT(相交)"></a>INTERSECT(相交)</h3><p>INTERSECT并INTERSECT ALL返回在两个表中找到的行.<br>INTERSECT只取不同的行,而INTERSECT ALL不会从结果行中删除重复项.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t1) <span class="keyword">INTERSECT</span> (<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t2);</span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span>  s<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span>  a<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  b<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t1) <span class="keyword">INTERSECT</span> <span class="keyword">ALL</span> (<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t2);</span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span>  s<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span>  a<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  b<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  b<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br></pre></td></tr></table></figure>

<h3 id="EXCEPT"><a href="#EXCEPT" class="headerlink" title="EXCEPT"></a>EXCEPT</h3><p>EXCEPT并EXCEPT ALL返回在一个表中找到但在另一个表中没有找到的行.<br>EXCEPT只取不同的行,而EXCEPT ALL不会从结果行中删除重复项.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t1) <span class="keyword">EXCEPT</span> (<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t2);</span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> s <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> c <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t1) <span class="keyword">EXCEPT</span> <span class="keyword">ALL</span> (<span class="keyword">SELECT</span> s <span class="keyword">FROM</span> t2);</span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> s <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> c <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br></pre></td></tr></table></figure>

<h3 id="IN"><a href="#IN" class="headerlink" title="IN"></a>IN</h3><p>如果表达式存在于给定的表子查询中,则返回 true.<br>子查询表必须由一列组成.<br>此列必须与表达式具有相同的数据类型.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span>, amount</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">WHERE</span> product <span class="keyword">IN</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> product <span class="keyword">FROM</span> NewProducts</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>优化器将 IN 条件重写为连接和组操作.<br>对于流式查询,计算查询结果所需的状态可能会根据不同输入行的数量无限增长.<br>您可以提供具有适当状态生存时间 (TTL) 的查询配置,以防止状态大小过大.<br>请注意,这可能会影响查询结果的正确性.<br>有关详细信息,请参阅查询配置.</p>
<h3 id="EXISTS"><a href="#EXISTS" class="headerlink" title="EXISTS"></a>EXISTS</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span>, amount</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">WHERE</span> product <span class="keyword">EXISTS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> product <span class="keyword">FROM</span> NewProducts</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如果子查询至少返回一行,则返回 true.<br>仅当操作可以在加入和组操作中重写时才支持.</p>
<p>优化器将操作重写EXISTS为连接和分组操作.<br>对于流式查询,计算查询结果所需的状态可能会根据不同输入行的数量无限增长.<br>您可以提供具有适当状态生存时间 (TTL) 的查询配置,以防止状态大小过大.<br>请注意,这可能会影响查询结果的正确性.<br>有关详细信息,请参阅查询配置.</p>
<h2 id="ORDER-BY-语句"><a href="#ORDER-BY-语句" class="headerlink" title="ORDER BY 语句"></a>ORDER BY 语句</h2><p>Batch Streaming</p>
<p>该ORDER BY子句使结果行根据指定的表达式进行排序.<br>如果根据最左边的表达式,两行相等,则根据下一个表达式进行比较,依此类推.<br>如果根据所有指定的表达式它们相等,则它们以与实现相关的顺序返回.</p>
<p>在流模式下运行时,表的主要排序顺序必须在时间属性上按升序排列.<br>所有后续订单都可以自由选择.<br>但是批处理模式没有这个限制.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_time, order_id</span><br></pre></td></tr></table></figure>

<h2 id="LIMIT-语句"><a href="#LIMIT-语句" class="headerlink" title="LIMIT 语句"></a>LIMIT 语句</h2><p>Batch</p>
<p>LIMIT子句限制语句返回的行数SELECT.<br>通常,此子句与 ORDER BY 结合使用,以确保结果是确定性的.</p>
<p>以下示例选择Orders表中的前 3 行.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> orderTime</span><br><span class="line">LIMIT <span class="number">3</span></span><br></pre></td></tr></table></figure>

<h2 id="Top-N"><a href="#Top-N" class="headerlink" title="Top-N"></a>Top-N</h2><p>Batch Streaming</p>
<p>Top-N 查询要求按列排序的 N 个最小值或最大值.<br>最小值和最大值集都被视为 Top-N 查询.<br>Top-N 查询在需要仅显示条件下批处理/流表中的 N 个最底部或 N 个最顶部记录的情况下很有用.<br>该结果集可用于进一步分析.</p>
<p>Flink 使用 OVER 窗口子句和过滤条件的组合来表达 Top-N 查询.<br>借助 OVER 窗口PARTITION BY子句的强大功能,Flink 还支持 per group Top-N.<br>例如,每个类别的实时销售额最高的前五个产品.<br>批处理表和流表上的 SQL 支持 Top-N 查询.</p>
<p>下面显示了 Top-N 语句的语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [column_list]</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> [column_list],</span><br><span class="line">   <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> ([<span class="keyword">PARTITION</span> <span class="keyword">BY</span> col1[, col2...]]</span><br><span class="line">     <span class="keyword">ORDER</span> <span class="keyword">BY</span> col1 [<span class="keyword">asc</span><span class="operator">|</span><span class="keyword">desc</span>][, col2 [<span class="keyword">asc</span><span class="operator">|</span><span class="keyword">desc</span>]...]) <span class="keyword">AS</span> rownum</span><br><span class="line">  <span class="keyword">FROM</span> table_name)</span><br><span class="line"><span class="keyword">WHERE</span> rownum <span class="operator">&lt;=</span> N [<span class="keyword">AND</span> conditions]</span><br></pre></td></tr></table></figure>

<h3 id="参数规格"><a href="#参数规格" class="headerlink" title="参数规格"></a>参数规格</h3><h4 id="ROW-NUMBER"><a href="#ROW-NUMBER" class="headerlink" title="ROW_NUMBER()"></a>ROW_NUMBER()</h4><p>根据分区内行的顺序,为每一行分配一个唯一的序号,从一个开始.<br>目前,我们仅支持ROW_NUMBER作为过窗功能.<br>未来,我们将支持RANK()和DENSE_RANK().</p>
<h4 id="PARTITION-BY-col1-col2"><a href="#PARTITION-BY-col1-col2" class="headerlink" title="PARTITION BY col1[, col2...]"></a>PARTITION BY <code>col1[, col2...]</code></h4><p>指定分区列.<br>每个分区都会有一个 Top-N 结果.</p>
<h4 id="ORDER-BY-col1-asc-desc-col2-asc-desc"><a href="#ORDER-BY-col1-asc-desc-col2-asc-desc" class="headerlink" title="ORDER BY col1 [asc|desc][, col2 [asc|desc]...]"></a>ORDER BY col1 <code>[asc|desc][, col2 [asc|desc]...]</code></h4><p>指定排序列.<br>不同列的排序方向可能不同.</p>
<h4 id="WHERE-rownum-lt-N"><a href="#WHERE-rownum-lt-N" class="headerlink" title="WHERE rownum &lt;= N"></a>WHERE rownum &lt;= N</h4><p>rownum &lt;= NFlink 需要识别这个查询是 Top-N 查询.<br>N表示将保留N个最小或最大的记录.</p>
<h4 id="AND-conditions"><a href="#AND-conditions" class="headerlink" title="[AND conditions]"></a><code>[AND conditions]</code></h4><p>where 子句中可以随意添加其他条件,但其他条件只能与rownum &lt;= NusingAND连词结合使用.</p>
<p>注意:必须严格遵循上述模式,否则优化器将无法翻译查询.</p>
<p>TopN 查询是Result Updating.<br>Flink SQL 会根据 order key 对输入数据流进行排序,所以如果 top N 记录发生了变化,那么变化的记录会作为retraction/update 记录发送到下游.<br>推荐使用支持更新的存储作为Top-N查询的sink.<br>此外,如果需要将前 N 条记录存储在外部存储中,则结果表应与前 N 条查询具有相同的唯一键.</p>
<p>Top-N 查询的唯一键是分区列和 rownum 列的组合.<br>Top-N 查询也可以推导出上游的唯一键.<br>以下面的作业为例,假设product_id是 的唯一键ShopSales,那么 Top-N 查询的唯一键是 [ category, rownum] 和 [ product_id].</p>
<p>以下示例显示如何在流表上指定具有 Top-N 的 SQL 查询.<br>这是一个获取我们上面提到的&quot;每个类别实时销售额最高的前五种产品&quot;的示例.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ShopSales (</span><br><span class="line"> product_id   STRING,</span><br><span class="line"> category     STRING,</span><br><span class="line"> product_name STRING,</span><br><span class="line"> sales        <span class="type">BIGINT</span></span><br><span class="line">) <span class="keyword">WITH</span> (...);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line"> <span class="keyword">SELECT</span> <span class="operator">*</span>,</span><br><span class="line">  <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> category <span class="keyword">ORDER</span> <span class="keyword">BY</span> sales <span class="keyword">DESC</span>) <span class="keyword">AS</span> row_num</span><br><span class="line"> <span class="keyword">FROM</span> ShopSales)</span><br><span class="line"><span class="keyword">WHERE</span> row_num <span class="operator">&lt;=</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h3 id="无排名输出优化"><a href="#无排名输出优化" class="headerlink" title="无排名输出优化"></a>无排名输出优化</h3><p>如上所述,该rownum字段将作为唯一键的一个字段写入结果表,这可能导致将大量记录写入结果表.<br>例如,当product-1001排名第 9 的记录(比如 )被更新并且它的排名被提升到 1 时,排名 1~9 的所有记录都将作为更新消息输出到结果表中.<br>如果结果表接收到的数据过多,就会成为 SQL 作业的瓶颈.</p>
<p>优化方式是在 Top-N 查询的外部 SELECT 子句中省略 rownum 字段.<br>这是合理的,因为前 N 条记录的数量通常不大,消费者可以自己快速对记录进行排序.<br>没有rownum字段,上例中只需product-1001要将改变的记录( )发送到下游,这样可以减少对结果表的大量IO.</p>
<p>以下示例展示了如何以这种方式优化上述 Top-N 示例:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ShopSales (</span><br><span class="line"> product_id   STRING,</span><br><span class="line"> category     STRING,</span><br><span class="line"> product_name STRING,</span><br><span class="line"> sales        <span class="type">BIGINT</span></span><br><span class="line">) <span class="keyword">WITH</span> (...);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- omit row_num field from the output</span></span><br><span class="line"><span class="keyword">SELECT</span> product_id, category, product_name, sales</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line"> <span class="keyword">SELECT</span> <span class="operator">*</span>,</span><br><span class="line">  <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> category <span class="keyword">ORDER</span> <span class="keyword">BY</span> sales <span class="keyword">DESC</span>) <span class="keyword">AS</span> row_num</span><br><span class="line"> <span class="keyword">FROM</span> ShopSales)</span><br><span class="line"><span class="keyword">WHERE</span> row_num <span class="operator">&lt;=</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>Streaming 模式下的注意事项为了将上述查询输出到外部存储并获得正确的结果,外部存储必须与 Top-N 查询具有相同的唯一键.<br>在上面的示例查询中,如果product_id是查询的唯一键,那么外部表也应该具有product_id作为唯一键.</p>
<h2 id="Window-Top-N"><a href="#Window-Top-N" class="headerlink" title="Window Top-N"></a>Window Top-N</h2><p>Batch Streaming</p>
<p>Window Top-N 是一个特殊的Top-N,它返回每个窗口和其他分区键的 N 个最小值或最大值.</p>
<p>对于流式查询,与连续表上的常规 Top-N 不同,窗口 Top-N 不会发出中间结果,而只会发出最终结果,即窗口末尾的总前 N 条记录.<br>此外,窗口 Top-N 会在不再需要时清除所有中间状态.<br>因此,如果用户不需要为每条记录更新结果,则窗口 Top-N 查询具有更好的性能.<br>通常,Window Top-N 直接与Windowing TVF一起使用.<br>此外,Window Top-N 可以与其他基于Windowing TVF的操作一起使用,例如Window Aggregation/Window TopN和Window Join.</p>
<p>Window Top-N 可以用与常规 Top-N 相同的语法定义,有关更多信息,请参阅Top-N 文档.<br>除此之外,Window Top-N 要求PARTITION BY子句 containswindow_start和window_end列的关系应用Windowing TVF或Window Aggregation.<br>否则,优化器将无法翻译查询.</p>
<p>下面显示了 Window Top-N 语句的语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [column_list]</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> [column_list],</span><br><span class="line">   <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> window_start, window_end [, col_key1...]</span><br><span class="line">     <span class="keyword">ORDER</span> <span class="keyword">BY</span> col1 [<span class="keyword">asc</span><span class="operator">|</span><span class="keyword">desc</span>][, col2 [<span class="keyword">asc</span><span class="operator">|</span><span class="keyword">desc</span>]...]) <span class="keyword">AS</span> rownum</span><br><span class="line">  <span class="keyword">FROM</span> table_name) <span class="comment">-- relation applied windowing TVF</span></span><br><span class="line"><span class="keyword">WHERE</span> rownum <span class="operator">&lt;=</span> N [<span class="keyword">AND</span> conditions]</span><br></pre></td></tr></table></figure>

<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><h4 id="Window-Aggregation-之后是-Window-Top-N"><a href="#Window-Aggregation-之后是-Window-Top-N" class="headerlink" title="Window Aggregation 之后是 Window Top-N"></a>Window Aggregation 之后是 Window Top-N</h4><p>以下示例显示了如何计算在每个翻滚 10 分钟窗口内销售额最高的前 3 名供应商.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- tables must have time attribute, e.g. `bidtime` in this table</span></span><br><span class="line"><span class="keyword">desc</span> Bid;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span>        name <span class="operator">|</span>                   type <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span> key <span class="operator">|</span> extras <span class="operator">|</span>                       watermark <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span>     bidtime <span class="operator">|</span> <span class="type">TIMESTAMP</span>(<span class="number">3</span>) <span class="operator">*</span>ROWTIME<span class="operator">*</span> <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span> `bidtime` <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">SECOND</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       price <span class="operator">|</span>         <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        item <span class="operator">|</span>                 STRING <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> supplier_id <span class="operator">|</span>                 STRING <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Bid;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span> supplier_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span>    A <span class="operator">|</span>   supplier1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">06</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span>    C <span class="operator">|</span>   supplier2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span>    G <span class="operator">|</span>   supplier1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">08</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span>    B <span class="operator">|</span>   supplier3 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span>    D <span class="operator">|</span>   supplier4 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span>    B <span class="operator">|</span>   supplier3 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span>    E <span class="operator">|</span>   supplier1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span>    H <span class="operator">|</span>   supplier2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span>    F <span class="operator">|</span>   supplier5 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> window_start, window_end <span class="keyword">ORDER</span> <span class="keyword">BY</span> price <span class="keyword">DESC</span>) <span class="keyword">as</span> rownum</span><br><span class="line">  <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> window_start, window_end, supplier_id, <span class="built_in">SUM</span>(price) <span class="keyword">as</span> price, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">      TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> window_start, window_end, supplier_id</span><br><span class="line">  )</span><br><span class="line"> ) <span class="keyword">WHERE</span> rownum <span class="operator">&lt;=</span> <span class="number">3</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------------+-------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> supplier_id <span class="operator">|</span> price <span class="operator">|</span> cnt <span class="operator">|</span> rownum <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------------+-------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>   supplier1 <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>   supplier4 <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>      <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>   supplier2 <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>      <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>   supplier5 <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>   supplier2 <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>      <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>   supplier3 <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>      <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------+-------------+-------+-----+--------+</span></span><br></pre></td></tr></table></figure>

<p>注意:为了更好地理解窗口化的行为,我们简化了时间戳值的显示以不显示尾随零,例如如果类型为 ,2020-04-15 08:05则应显示为2020-04-15 08:05:00.000在 Flink SQL Client 中TIMESTAMP(3).</p>
<h4 id="Window-Top-N-跟随在-Windowing-TVF"><a href="#Window-Top-N-跟随在-Windowing-TVF" class="headerlink" title="Window Top-N 跟随在 Windowing TVF"></a>Window Top-N 跟随在 Windowing TVF</h4><p>以下示例显示如何计算每个翻滚 10 分钟窗口中价格最高的前 3 个项目.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> window_start, window_end <span class="keyword">ORDER</span> <span class="keyword">BY</span> price <span class="keyword">DESC</span>) <span class="keyword">as</span> rownum</span><br><span class="line">  <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">             TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> ) <span class="keyword">WHERE</span> rownum <span class="operator">&lt;=</span> <span class="number">3</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+------------------+------------------+--------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span> supplier_id <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> rownum <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+------------------+------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span>    A <span class="operator">|</span>   supplier1 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>      <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">06</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span>    C <span class="operator">|</span>   supplier2 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>      <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span>    D <span class="operator">|</span>   supplier4 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span>    B <span class="operator">|</span>   supplier3 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>      <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">15</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span>    H <span class="operator">|</span>   supplier2 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>      <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span>    F <span class="operator">|</span>   supplier5 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+------------------+------------------+--------+</span></span><br></pre></td></tr></table></figure>

<p>注意:为了更好地理解窗口化的行为,我们简化了时间戳值的显示以不显示尾随零,例如如果类型为 ,2020-04-15 08:05则应显示为2020-04-15 08:05:00.000在 Flink SQL Client 中TIMESTAMP(3).</p>
<h3 id="Limitation-限制"><a href="#Limitation-限制" class="headerlink" title="Limitation(限制)"></a>Limitation(限制)</h3><p>目前,Flink 仅支持在Windowing TVF with Tumble Windows/Hop Windows 和 Cumulate Windows 之后的 Window Top-N follow.<br>Window Top-N 紧随其后,在不久的将来将支持Windowing TVF with Session windows.</p>
<h2 id="Deduplication-去重"><a href="#Deduplication-去重" class="headerlink" title="Deduplication(去重)"></a>Deduplication(去重)</h2><p>Batch Streaming</p>
<p>重复数据删除删除在一组列上重复的行,只保留第一个或最后一个.<br>在某些情况下,上游 ETL 作业并不是端到端的.<br>如果发生故障转移,这可能会导致接收器中的重复记录.<br>但是,重复记录会影响下游分析作业的正确性——例如SUM,COUNT——因此在进一步分析之前需要进行重复数据删除.</p>
<p>Flink 用于ROW_NUMBER()去除重复,就像 Top-N 查询的方式一样.<br>理论上,重复数据删除是 Top-N 的一种特殊情况,其中 N 为 1,按处理时间或事件时间排序.</p>
<p>以下显示了重复数据删除语句的语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [column_list]</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> [column_list],</span><br><span class="line">   <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> ([<span class="keyword">PARTITION</span> <span class="keyword">BY</span> col1[, col2...]]</span><br><span class="line">     <span class="keyword">ORDER</span> <span class="keyword">BY</span> time_attr [<span class="keyword">asc</span><span class="operator">|</span><span class="keyword">desc</span>]) <span class="keyword">AS</span> rownum</span><br><span class="line">  <span class="keyword">FROM</span> table_name)</span><br><span class="line"><span class="keyword">WHERE</span> rownum <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="参数规格-1"><a href="#参数规格-1" class="headerlink" title="参数规格"></a>参数规格</h3><h4 id="ROW-NUMBER-1"><a href="#ROW-NUMBER-1" class="headerlink" title="ROW_NUMBER()"></a>ROW_NUMBER()</h4><p>为每一行分配一个唯一的序列号,从一个开始.</p>
<h4 id="PARTITION-BY-col1-col2-1"><a href="#PARTITION-BY-col1-col2-1" class="headerlink" title="PARTITION BY col1[, col2...]"></a>PARTITION BY <code>col1[, col2...]</code></h4><p>指定分区列,即去重键.</p>
<h4 id="ORDER-BY-time-attr-asc-desc"><a href="#ORDER-BY-time-attr-asc-desc" class="headerlink" title="ORDER BY time_attr [asc|desc]"></a>ORDER BY time_attr <code>[asc|desc]</code></h4><p>指定排序列,必须是时间属性.<br>目前 Flink 支持处理时间属性和事件时间属性.<br>按 ASC 排序表示保留第一行,按 DESC 排序表示保留最后一行.</p>
<h4 id="WHERE-rownum-1"><a href="#WHERE-rownum-1" class="headerlink" title="WHERE rownum = 1"></a>WHERE rownum = 1</h4><p>rownum = 1Flink 需要识别这个查询是重复数据删除.</p>
<p>注意:必须严格遵循上述模式,否则优化器将无法翻译查询.</p>
<p>以下示例显示如何在流表上使用重复数据删除指定 SQL 查询.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders (</span><br><span class="line"> order_time  STRING,</span><br><span class="line"> <span class="keyword">user</span>        STRING,</span><br><span class="line"> product     STRING,</span><br><span class="line"> num         <span class="type">BIGINT</span>,</span><br><span class="line"> proctime <span class="keyword">AS</span> PROCTIME()</span><br><span class="line">) <span class="keyword">WITH</span> (...);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- remove duplicate rows on order_id and keep the first occurrence row,</span></span><br><span class="line"><span class="comment">-- because there shouldn&#x27;t be two orders with the same order_id.</span></span><br><span class="line"><span class="keyword">SELECT</span> order_id, <span class="keyword">user</span>, product, num</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line"> <span class="keyword">SELECT</span> <span class="operator">*</span>,</span><br><span class="line">  <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> order_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> proctime <span class="keyword">ASC</span>) <span class="keyword">AS</span> row_num</span><br><span class="line"> <span class="keyword">FROM</span> Orders)</span><br><span class="line"><span class="keyword">WHERE</span> row_num <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="Window-Deduplication-窗口去重"><a href="#Window-Deduplication-窗口去重" class="headerlink" title="Window Deduplication(窗口去重)"></a>Window Deduplication(窗口去重)</h2><p>Streaming</p>
<p>窗口重复数据删除是一种特殊的重复数据删除,它删除在一组列上重复的行,为每个窗口和分区键保留第一个或最后一个.</p>
<p>对于流式查询,与连续表上的常规重复数据删除不同,窗口重复数据删除不会发出中间结果,而只会在窗口结束时发出最终结果.<br>此外,窗口重复数据删除会在不再需要时清除所有中间状态.<br>因此,如果用户不需要为每条记录更新结果,则窗口重复数据删除查询具有更好的性能.<br>通常,Window Deduplication 直接与Windowing TVF一起使用.<br>此外,Window Deduplication 可以与其他基于Windowing TVF的操作一起使用,例如Window Aggregation/Window TopN和Window Join.</p>
<p>可以使用与常规重复数据删除相同的语法定义窗口重复数据删除,有关详细信息,请参阅重复数据删除文档.<br>除此之外,Window Deduplication 要求PARTITION BY子句包含关系window_start的window_end列.<br>否则,优化器将无法翻译查询.</p>
<p>Flink 用于ROW_NUMBER()去除重复,就像Window Top-N query的方式一样.<br>理论上,Window Deduplication 是 Window Top-N 的一种特殊情况,其中 N 为 1,按处理时间或事件时间排序.</p>
<p>下面显示了 Window Deduplication 语句的语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [column_list]</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> [column_list],</span><br><span class="line">   <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> window_start, window_end [, col_key1...]</span><br><span class="line">     <span class="keyword">ORDER</span> <span class="keyword">BY</span> time_attr [<span class="keyword">asc</span><span class="operator">|</span><span class="keyword">desc</span>]) <span class="keyword">AS</span> rownum</span><br><span class="line">  <span class="keyword">FROM</span> table_name) <span class="comment">-- relation applied windowing TVF</span></span><br><span class="line"><span class="keyword">WHERE</span> (rownum <span class="operator">=</span> <span class="number">1</span> <span class="operator">|</span> rownum <span class="operator">&lt;=</span><span class="number">1</span> <span class="operator">|</span> rownum <span class="operator">&lt;</span> <span class="number">2</span>) [<span class="keyword">AND</span> conditions]</span><br></pre></td></tr></table></figure>

<h3 id="参数规格-2"><a href="#参数规格-2" class="headerlink" title="参数规格"></a>参数规格</h3><h4 id="ROW-NUMBER-2"><a href="#ROW-NUMBER-2" class="headerlink" title="ROW_NUMBER()"></a>ROW_NUMBER()</h4><p>为每一行分配一个唯一的序列号,从一个开始.</p>
<h4 id="PARTITION-BY-window-start-window-end-col-key1"><a href="#PARTITION-BY-window-start-window-end-col-key1" class="headerlink" title="PARTITION BY window_start, window_end [, col_key1...]"></a>PARTITION BY window_start, window_end <code>[, col_key1...]</code></h4><p> 指定包含window_start,window_end和其他分区键的分区列.</p>
<h4 id="ORDER-BY-time-attr-asc-desc-1"><a href="#ORDER-BY-time-attr-asc-desc-1" class="headerlink" title="ORDER BY time_attr [asc|desc]"></a>ORDER BY time_attr <code>[asc|desc]</code></h4><p>指定排序列,必须是时间属性.<br>目前 Flink 支持处理时间属性和事件时间属性.<br>按 ASC 排序表示保留第一行,按 DESC 排序表示保留最后一行.</p>
<h4 id="WHERE-rownum-1-rownum-lt-1-rownum-lt-2"><a href="#WHERE-rownum-1-rownum-lt-1-rownum-lt-2" class="headerlink" title="WHERE (rownum = 1 | rownum &lt;=1 | rownum &lt; 2)"></a><code>WHERE (rownum = 1 | rownum &lt;=1 | rownum &lt; 2)</code></h4><p>rownum = 1 | rownum &lt;=1 | rownum &lt; 2优化器需要识别查询才能转换为窗口重复数据删除.</p>
<p>注意:必须严格遵循上述模式,否则优化器不会将查询转换为 Window Deduplication.</p>
<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><p>以下示例显示如何为每 10 分钟滚动窗口保留最后一条记录.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- tables must have time attribute, e.g. `bidtime` in this table</span></span><br><span class="line"><span class="keyword">DESC</span> Bid;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span>        name <span class="operator">|</span>                   type <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span> key <span class="operator">|</span> extras <span class="operator">|</span>                       watermark <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span>     bidtime <span class="operator">|</span> <span class="type">TIMESTAMP</span>(<span class="number">3</span>) <span class="operator">*</span>ROWTIME<span class="operator">*</span> <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span> `bidtime` <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">SECOND</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       price <span class="operator">|</span>         <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        item <span class="operator">|</span>                 STRING <span class="operator">|</span> <span class="literal">true</span> <span class="operator">|</span>     <span class="operator">|</span>        <span class="operator">|</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+--------+---------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Bid;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">05</span> <span class="operator">|</span>  <span class="number">4.00</span> <span class="operator">|</span> C    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">07</span> <span class="operator">|</span>  <span class="number">2.00</span> <span class="operator">|</span> A    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span> D    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">11</span> <span class="operator">|</span>  <span class="number">3.00</span> <span class="operator">|</span> B    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">13</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> E    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span> F    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> bidtime, price, item, supplier_id, window_start, window_end, </span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> window_start, window_end <span class="keyword">ORDER</span> <span class="keyword">BY</span> bidtime <span class="keyword">DESC</span>) <span class="keyword">AS</span> rownum</span><br><span class="line">  <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(</span><br><span class="line">             TUMBLE(<span class="keyword">TABLE</span> Bid, DESCRIPTOR(bidtime), <span class="type">INTERVAL</span> <span class="string">&#x27;10&#x27;</span> MINUTES))</span><br><span class="line"> ) <span class="keyword">WHERE</span> rownum <span class="operator">&lt;=</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+------------------+------------------+--------+</span></span><br><span class="line"><span class="operator">|</span>          bidtime <span class="operator">|</span> price <span class="operator">|</span> item <span class="operator">|</span> supplier_id <span class="operator">|</span>     window_start <span class="operator">|</span>       window_end <span class="operator">|</span> rownum <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+------------------+------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">09</span> <span class="operator">|</span>  <span class="number">5.00</span> <span class="operator">|</span>    D <span class="operator">|</span>   supplier4 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">00</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">17</span> <span class="operator">|</span>  <span class="number">6.00</span> <span class="operator">|</span>    F <span class="operator">|</span>   supplier5 <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">10</span> <span class="operator">|</span> <span class="number">2020</span><span class="number">-04</span><span class="number">-15</span> <span class="number">08</span>:<span class="number">20</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+------+-------------+------------------+------------------+--------+</span></span><br></pre></td></tr></table></figure>

<p>注意:为了更好地理解窗口化的行为,我们简化了时间戳值的显示以不显示尾随零,例如如果类型为 ,2020-04-15 08:05则应显示为2020-04-15 08:05:00.000在 Flink SQL Client 中TIMESTAMP(3).</p>
<h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><h4 id="直接对-TVF-进行窗口化后对窗口重复数据删除的限制"><a href="#直接对-TVF-进行窗口化后对窗口重复数据删除的限制" class="headerlink" title="直接对 TVF 进行窗口化后对窗口重复数据删除的限制"></a>直接对 TVF 进行窗口化后对窗口重复数据删除的限制</h4><p>目前,如果在Windowing TVF之后进行 Window Deduplication ,则Windowing TVF必须使用 Tumble Windows/Hop Windows 或 Cumulate Windows 而不是 Session 窗口.<br>会话窗口将在不久的将来得到支持.</p>
<h4 id="订单键的时间属性限制"><a href="#订单键的时间属性限制" class="headerlink" title="订单键的时间属性限制"></a>订单键的时间属性限制</h4><p>目前,Window Deduplication 要求 order key 必须是event time 属性而不是processing time 属性.<br>在不久的将来将支持按处理时间排序.</p>
<h2 id="模式检测"><a href="#模式检测" class="headerlink" title="模式检测"></a>模式检测</h2><p>Streaming</p>
<p>搜索一组事件模式(event pattern)是一种常见的用例,尤其是在数据流情景中.<br>Flink 提供复杂事件处理(CEP)库,该库允许在事件流中进行模式检测.<br>此外,Flink 的 SQL API 提供了一种关系式的查询表达方式,其中包含大量内置函数和基于规则的优化,可以开箱即用.</p>
<p>2016 年 12 月,国际标准化组织(ISO)发布了新版本的 SQL 标准,其中包括在 SQL 中的行模式识别(Row Pattern Recognition in SQL)(ISO/IEC TR 19075-5:2016).<br>它允许 Flink 使用 MATCH_RECOGNIZE 子句融合 CEP 和 SQL API,以便在 SQL 中进行复杂事件处理.</p>
<p>MATCH_RECOGNIZE 子句启用以下任务:<br>使用 PARTITION BY 和 ORDER BY 子句对数据进行逻辑分区和排序.<br>使用 PATTERN 子句定义要查找的行模式.这些模式使用类似于正则表达式的语法.<br>在 DEFINE 子句中指定行模式变量的逻辑组合.<br>measures 是指在 MEASURES 子句中定义的表达式,这些表达式可用于 SQL 查询中的其他部分.</p>
<p>下面的示例演示了基本模式识别的语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> T.aid, T.bid, T.cid</span><br><span class="line"><span class="keyword">FROM</span> MyTable</span><br><span class="line">  <span class="keyword">MATCH_RECOGNIZE</span> (</span><br><span class="line">    <span class="keyword">PARTITION</span> <span class="keyword">BY</span> userid</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> proctime</span><br><span class="line">    MEASURES</span><br><span class="line">      A.id <span class="keyword">AS</span> aid,</span><br><span class="line">      B.id <span class="keyword">AS</span> bid,</span><br><span class="line">      C.id <span class="keyword">AS</span> cid</span><br><span class="line">    <span class="keyword">PATTERN</span> (A B C)</span><br><span class="line">    <span class="keyword">DEFINE</span></span><br><span class="line">      A <span class="keyword">AS</span> name <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">      B <span class="keyword">AS</span> name <span class="operator">=</span> <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">      C <span class="keyword">AS</span> name <span class="operator">=</span> <span class="string">&#x27;c&#x27;</span></span><br><span class="line">  ) <span class="keyword">AS</span> T</span><br></pre></td></tr></table></figure>

<p>本页将更详细地解释每个关键字,并演示说明更复杂的示例.</p>
<p>Flink 的 MATCH_RECOGNIZE 子句实现是一个完整标准子集.<br>仅支持以下部分中记录的功能.<br>基于社区反馈,可能会支持其他功能,请查看已知的局限.</p>
<h3 id="介绍和示例"><a href="#介绍和示例" class="headerlink" title="介绍和示例"></a>介绍和示例</h3><h4 id="安装指南"><a href="#安装指南" class="headerlink" title="安装指南"></a>安装指南</h4><p>模式识别特性使用 Apache Flink 内部的 CEP 库.<br>为了能够使用 MATCH_RECOGNIZE 子句,需要将库作为依赖项添加到 Maven 项目中.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-cep<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.15.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者,也可以将依赖项添加到集群的 classpath(查看 dependency section 获取更多相关依赖信息).</p>
<p>如果你想在 SQL Client 中使用 MATCH_RECOGNIZE 子句,你无需执行任何操作,因为默认情况下包含所有依赖项.</p>
<h4 id="SQL-语义"><a href="#SQL-语义" class="headerlink" title="SQL 语义"></a>SQL 语义</h4><p>每个 MATCH_RECOGNIZE 查询都包含以下子句:<br>PARTITION BY - 定义表的逻辑分区.类似于 GROUP BY 操作.<br>ORDER BY - 指定传入行的排序方式.这是必须的,因为模式依赖于顺序.<br>MEASURES - 定义子句的输出.类似于 SELECT 子句.<br>ONE ROW PER MATCH - 输出方式,定义每个匹配项应产生多少行.<br>AFTER MATCH SKIP - 指定下一个匹配的开始位置.这也是控制单个事件可以属于多少个不同匹配项的方法.<br>PATTERN - 允许使用类似于 正则表达式 的语法构造搜索的模式.<br>DEFINE - 本部分定义了模式变量必须满足的条件.</p>
<p>注意:目前,MATCH_RECOGNIZE 子句只能应用于追加表.<br>此外,它也总是生成一个追加表.</p>
<h4 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h4><p>对于我们的示例,我们假设已经注册了一个表 Ticker.<br>该表包含特定时间点的股票价格.</p>
<p>这张表的 schema 如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Ticker</span><br><span class="line">   |-- symbol: String                          </span><br><span class="line">   |-- price: Long                             </span><br><span class="line">   |-- tax: Long                               </span><br><span class="line">   |-- rowtime: TimeIndicatorTypeInfo(rowtime) </span><br></pre></td></tr></table></figure>

<p>为了简化,我们只考虑单个股票 ACME 的传入数据.<br>Ticker 可以类似于下表,其中的行是连续追加的.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">symbol         rowtime         price    tax</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:00&#39;   12      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:01&#39;   17      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:02&#39;   19      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:03&#39;   21      3</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:04&#39;   25      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:05&#39;   18      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:06&#39;   15      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:07&#39;   14      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:08&#39;   24      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:09&#39;   25      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:10&#39;   19      1</span><br></pre></td></tr></table></figure>

<p>现在的任务是找出一个单一股票价格不断下降的时期.<br>为此,可以编写如下查询:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Ticker</span><br><span class="line">  <span class="keyword">MATCH_RECOGNIZE</span> (</span><br><span class="line">      <span class="keyword">PARTITION</span> <span class="keyword">BY</span> symbol</span><br><span class="line">      <span class="keyword">ORDER</span> <span class="keyword">BY</span> rowtime</span><br><span class="line">      MEASURES</span><br><span class="line">          START_ROW.rowtime <span class="keyword">AS</span> start_tstamp,</span><br><span class="line">          <span class="keyword">LAST</span>(PRICE_DOWN.rowtime) <span class="keyword">AS</span> bottom_tstamp,</span><br><span class="line">          <span class="keyword">LAST</span>(PRICE_UP.rowtime) <span class="keyword">AS</span> end_tstamp</span><br><span class="line">      <span class="keyword">ONE</span> <span class="type">ROW</span> <span class="keyword">PER</span> <span class="keyword">MATCH</span></span><br><span class="line">      AFTER <span class="keyword">MATCH</span> <span class="keyword">SKIP</span> <span class="keyword">TO</span> <span class="keyword">LAST</span> PRICE_UP</span><br><span class="line">      <span class="keyword">PATTERN</span> (START_ROW PRICE_DOWN<span class="operator">+</span> PRICE_UP)</span><br><span class="line">      <span class="keyword">DEFINE</span></span><br><span class="line">          PRICE_DOWN <span class="keyword">AS</span></span><br><span class="line">              (<span class="keyword">LAST</span>(PRICE_DOWN.price, <span class="number">1</span>) <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">AND</span> PRICE_DOWN.price <span class="operator">&lt;</span> START_ROW.price) <span class="keyword">OR</span></span><br><span class="line">                  PRICE_DOWN.price <span class="operator">&lt;</span> <span class="keyword">LAST</span>(PRICE_DOWN.price, <span class="number">1</span>),</span><br><span class="line">          PRICE_UP <span class="keyword">AS</span></span><br><span class="line">              PRICE_UP.price <span class="operator">&gt;</span> <span class="keyword">LAST</span>(PRICE_DOWN.price, <span class="number">1</span>)</span><br><span class="line">  ) MR;</span><br></pre></td></tr></table></figure>

<p>此查询将 Ticker 表按照 symbol 列进行分区并按照 rowtime 属性进行排序.</p>
<p>PATTERN 子句指定我们对以下模式感兴趣:该模式具有开始事件 START_ROW,然后是一个或多个 PRICE_DOWN 事件,并以 PRICE_UP 事件结束.<br>如果可以找到这样的模式,如 AFTER MATCH SKIP TO LAST 子句所示,则从最后一个 PRICE_UP 事件开始寻找下一个模式匹配.</p>
<p>DEFINE 子句指定 PRICE_DOWN 和 PRICE_UP 事件需要满足的条件.<br>尽管不存在 START_ROW 模式变量,但它具有一个始终被评估为 TRUE 隐式条件.</p>
<p>模式变量 PRICE_DOWN 定义为价格小于满足 PRICE_DOWN 条件的最后一行.<br>对于初始情况或没有满足 PRICE_DOWN 条件的最后一行时,该行的价格应小于该模式中前一行(由 START_ROW 引用)的价格.</p>
<p>模式变量 PRICE_UP 定义为价格大于满足 PRICE_DOWN 条件的最后一行.</p>
<p>此查询为股票价格持续下跌的每个期间生成摘要行.</p>
<p>在查询的 MEASURES 子句部分定义确切的输出行信息.<br>输出行数由 ONE ROW PER MATCH 输出方式定义.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">symbol       start_tstamp       bottom_tstamp         end_tstamp</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">ACME       01-APR-11 10:00:04  01-APR-11 10:00:07  01-APR-11 10:00:08</span><br></pre></td></tr></table></figure>

<p>该行结果描述了从 01-APR-11 10:00:04 开始的价格下跌期,在 01-APR-11 10:00:07 达到最低价格,到 01-APR-11 10:00:08 再次上涨.</p>
<h3 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h3><p>可以在分区数据中寻找模式,例如单个股票行情或特定用户的趋势.<br>这可以用 PARTITION BY 子句来表示.<br>该子句类似于对 aggregation 使用 GROUP BY.</p>
<p>注意:强烈建议对传入的数据进行分区,否则 MATCH_RECOGNIZE 子句将被转换为非并行算子,以确保全局排序.</p>
<h3 id="事件顺序"><a href="#事件顺序" class="headerlink" title="事件顺序"></a>事件顺序</h3><p>Apache Flink 可以根据时间(处理时间或者事件时间)进行模式搜索.</p>
<p>如果是事件时间,则在将事件传递到内部模式状态机之前对其进行排序.<br>所以,无论行添加到表的顺序如何,生成的输出都是正确的.<br>而模式是按照每行中所包含的时间指定顺序计算的.</p>
<p>MATCH_RECOGNIZE 子句假定升序的 时间属性 是 ORDER BY 子句的第一个参数.</p>
<p>对于示例 Ticker 表,诸如 ORDER BY rowtime ASC, price DESC 的定义是有效的,但 ORDER BY price, rowtime 或者 ORDER BY rowtime DESC, price ASC 是无效的.</p>
<h3 id="Define-amp-Measures"><a href="#Define-amp-Measures" class="headerlink" title="Define &amp; Measures"></a>Define &amp; Measures</h3><p>DEFINE 和 MEASURES 关键字与简单 SQL 查询中的 WHERE 和 SELECT 子句具有相近的含义.</p>
<p>MEASURES 子句定义匹配模式的输出中要包含哪些内容.<br>它可以投影列并定义表达式进行计算.<br>产生的行数取决于输出方式设置.</p>
<p>DEFINE 子句指定行必须满足的条件才能被分类到相应的模式变量.<br>如果没有为模式变量定义条件,则将对每一行使用计算结果为 true 的默认条件.</p>
<p>有关在这些子句中可使用的表达式的更详细的说明,请查看事件流导航部分.</p>
<h4 id="Aggregations"><a href="#Aggregations" class="headerlink" title="Aggregations"></a>Aggregations</h4><p>Aggregations 可以在 DEFINE 和 MEASURES 子句中使用.<br>支持内置函数和用户自定义函数.</p>
<p>对相应匹配项的行子集可以使用 Aggregate functions.<br>请查看事件流导航部分以了解如何计算这些子集.</p>
<p>下面这个示例的任务是找出股票平均价格没有低于某个阈值的最长时间段.<br>它展示了 MATCH_RECOGNIZE 在 aggregation 中的可表达性.<br>可以使用以下查询执行此任务:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Ticker</span><br><span class="line">  <span class="keyword">MATCH_RECOGNIZE</span> (</span><br><span class="line">      <span class="keyword">PARTITION</span> <span class="keyword">BY</span> symbol</span><br><span class="line">      <span class="keyword">ORDER</span> <span class="keyword">BY</span> rowtime</span><br><span class="line">      MEASURES</span><br><span class="line">          <span class="keyword">FIRST</span>(A.rowtime) <span class="keyword">AS</span> start_tstamp,</span><br><span class="line">          <span class="keyword">LAST</span>(A.rowtime) <span class="keyword">AS</span> end_tstamp,</span><br><span class="line">          <span class="built_in">AVG</span>(A.price) <span class="keyword">AS</span> avgPrice</span><br><span class="line">      <span class="keyword">ONE</span> <span class="type">ROW</span> <span class="keyword">PER</span> <span class="keyword">MATCH</span></span><br><span class="line">      AFTER <span class="keyword">MATCH</span> <span class="keyword">SKIP</span> PAST <span class="keyword">LAST</span> <span class="type">ROW</span></span><br><span class="line">      <span class="keyword">PATTERN</span> (A<span class="operator">+</span> B)</span><br><span class="line">      <span class="keyword">DEFINE</span></span><br><span class="line">          A <span class="keyword">AS</span> <span class="built_in">AVG</span>(A.price) <span class="operator">&lt;</span> <span class="number">15</span></span><br><span class="line">  ) MR;</span><br></pre></td></tr></table></figure>

<p>给定此查询和以下输入值:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">symbol         rowtime         price    tax</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:00&#39;   12      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:01&#39;   17      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:02&#39;   13      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:03&#39;   16      3</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:04&#39;   25      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:05&#39;   2       1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:06&#39;   4       1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:07&#39;   10      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:08&#39;   15      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:09&#39;   25      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:10&#39;   25      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:11&#39;   30      1</span><br></pre></td></tr></table></figure>

<p>只要事件的平均价格不超过 15,查询就会将事件作为模式变量 A 的一部分进行累积.<br>例如,这种限制发生在 01-Apr-11 10:00:04.<br>接下来的时间段在 01-Apr-11 10:00:11 再次超过平均价格 15.<br>因此,所述查询的结果将是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">symbol       start_tstamp       end_tstamp          avgPrice</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">ACME       01-APR-11 10:00:00  01-APR-11 10:00:03     14.5</span><br><span class="line">ACME       01-APR-11 10:00:05  01-APR-11 10:00:10     13.5</span><br></pre></td></tr></table></figure>

<p>注意:Aggregation 可以应用于表达式,但前提是它们引用单个模式变量.<br>因此,SUM(A.price * A.tax) 是有效的,而 AVG(A.price * B.tax) 则是无效的.</p>
<p>注意:不支持 DISTINCT aggregation.</p>
<h3 id="定义模式"><a href="#定义模式" class="headerlink" title="定义模式"></a>定义模式</h3><p>MATCH_RECOGNIZE 子句允许用户在事件流中使用功能强大/表达力强的语法搜索模式,这种语法与广泛使用的正则表达式语法有些相似.</p>
<p>每个模式都是由基本的构建块构造的,称为 模式变量,可以应用算子(量词和其他修饰符)到这些模块中.<br>整个模式必须用括号括起来.</p>
<p>示例模式如下所示:<br>PATTERN (A B+ C* D)</p>
<p>可以使用以下算子:<br>Concatenation - 像 (A B) 这样的模式意味着 A 和 B 之间的连接是严格的.<br>因此,在它们之间不能存在没有映射到 A 或 B 的行.</p>
<p>Quantifiers - 修改可以映射到模式变量的行数.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* — 0 或者多行</span><br><span class="line">+ — 1 或者多行</span><br><span class="line">? — 0 或者 1 行</span><br><span class="line">&#123; n &#125; — 严格 n 行(n &gt; 0)</span><br><span class="line">&#123; n, &#125; — n 或者更多行(n ≥ 0)</span><br><span class="line">&#123; n, m &#125; — 在 n 到 m(包含)行之间(0 ≤ n ≤ m,0 &lt; m)</span><br><span class="line">&#123; , m &#125; — 在 0 到 m(包含)行之间(m &gt; 0)</span><br></pre></td></tr></table></figure>

<p>注意:不支持可能产生空匹配的模式.<br>此类模式的示例如 PATTERN (A*),PATTERN (A? B*),PATTERN (A{0,} B{0,} C*) 等.</p>
<h4 id="贪婪量词和勉强量词"><a href="#贪婪量词和勉强量词" class="headerlink" title="贪婪量词和勉强量词"></a>贪婪量词和勉强量词</h4><p>每一个量词可以是 贪婪(默认行为)的或者 勉强 的.<br>贪婪的量词尝试匹配尽可能多的行,而勉强的量词则尝试匹配尽可能少的行.</p>
<p>为了说明区别,可以通过查询查看以下示例,其中贪婪量词应用于 B 变量:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Ticker</span><br><span class="line">  <span class="keyword">MATCH_RECOGNIZE</span>(</span><br><span class="line">      <span class="keyword">PARTITION</span> <span class="keyword">BY</span> symbol</span><br><span class="line">      <span class="keyword">ORDER</span> <span class="keyword">BY</span> rowtime</span><br><span class="line">      MEASURES</span><br><span class="line">          C.price <span class="keyword">AS</span> lastPrice</span><br><span class="line">      <span class="keyword">ONE</span> <span class="type">ROW</span> <span class="keyword">PER</span> <span class="keyword">MATCH</span></span><br><span class="line">      AFTER <span class="keyword">MATCH</span> <span class="keyword">SKIP</span> PAST <span class="keyword">LAST</span> <span class="type">ROW</span></span><br><span class="line">      <span class="keyword">PATTERN</span> (A B<span class="operator">*</span> C)</span><br><span class="line">      <span class="keyword">DEFINE</span></span><br><span class="line">          A <span class="keyword">AS</span> A.price <span class="operator">&gt;</span> <span class="number">10</span>,</span><br><span class="line">          B <span class="keyword">AS</span> B.price <span class="operator">&lt;</span> <span class="number">15</span>,</span><br><span class="line">          C <span class="keyword">AS</span> C.price <span class="operator">&gt;</span> <span class="number">12</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>假设我们有以下输入:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">symbol  tax   price          rowtime</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">XYZ     1     10       2018-09-17 10:00:02</span><br><span class="line">XYZ     2     11       2018-09-17 10:00:03</span><br><span class="line">XYZ     1     12       2018-09-17 10:00:04</span><br><span class="line">XYZ     2     13       2018-09-17 10:00:05</span><br><span class="line">XYZ     1     14       2018-09-17 10:00:06</span><br><span class="line">XYZ     2     16       2018-09-17 10:00:07</span><br></pre></td></tr></table></figure>

<p>上面的模式将产生以下输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">symbol   lastPrice</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">XYZ      16</span><br></pre></td></tr></table></figure>

<p>将 B* 修改为 B*? 的同一查询,这意味着 B* 应该是勉强的,将产生:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">symbol   lastPrice</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">XYZ      13</span><br><span class="line">XYZ      16</span><br></pre></td></tr></table></figure>

<p>模式变量 B 只匹配价格为 12 的行,而不是包含价格为 12/13 和 14 的行.</p>
<p>注意:模式的最后一个变量不能使用贪婪量词.<br>因此,不允许使用类似 (A B*) 的模式.<br>通过引入条件为 B 的人工状态(例如 C),可以轻松解决此问题.<br>因此,你可以使用类似以下的查询:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PATTERN</span> (A B<span class="operator">*</span> C)</span><br><span class="line"><span class="keyword">DEFINE</span></span><br><span class="line">  A <span class="keyword">AS</span> condA(),</span><br><span class="line">  B <span class="keyword">AS</span> condB(),</span><br><span class="line">  C <span class="keyword">AS</span> <span class="keyword">NOT</span> condB()</span><br></pre></td></tr></table></figure>

<p>注意:目前不支持可选的勉强量词(A?? 或者 A{0,1}?).</p>
<h4 id="时间约束"><a href="#时间约束" class="headerlink" title="时间约束"></a>时间约束</h4><p>特别是对于流的使用场景,通常需要在给定的时间内完成模式.<br>这要求限制住 Flink 在内部必须保持的状态总体大小(即已经过期的状态就不需要再维护了),即使在贪婪的量词的情况下也是如此.</p>
<p>因此,Flink SQL 支持附加的(非标准 SQL)WITHIN 子句来定义模式的时间约束.<br>子句可以在 PATTERN 子句之后定义,并以毫秒为间隔进行解析.</p>
<p>如果潜在匹配的第一个和最后一个事件之间的时间长于给定值,则不会将这种匹配追加到结果表中.</p>
<p>注意:通常鼓励使用 WITHIN 子句,因为它有助于 Flink 进行有效的内存管理.<br>一旦达到阈值,即可修剪基础状态.</p>
<p>注意:然而,WITHIN 子句不是 SQL 标准的一部分.<br>时间约束处理的方法已被提议将来可能会改变.</p>
<p>下面的示例查询说明了 WITHIN 子句的用法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Ticker</span><br><span class="line">  <span class="keyword">MATCH_RECOGNIZE</span>(</span><br><span class="line">      <span class="keyword">PARTITION</span> <span class="keyword">BY</span> symbol</span><br><span class="line">      <span class="keyword">ORDER</span> <span class="keyword">BY</span> rowtime</span><br><span class="line">      MEASURES</span><br><span class="line">          C.rowtime <span class="keyword">AS</span> dropTime,</span><br><span class="line">          A.price <span class="operator">-</span> C.price <span class="keyword">AS</span> dropDiff</span><br><span class="line">      <span class="keyword">ONE</span> <span class="type">ROW</span> <span class="keyword">PER</span> <span class="keyword">MATCH</span></span><br><span class="line">      AFTER <span class="keyword">MATCH</span> <span class="keyword">SKIP</span> PAST <span class="keyword">LAST</span> <span class="type">ROW</span></span><br><span class="line">      <span class="keyword">PATTERN</span> (A B<span class="operator">*</span> C) <span class="keyword">WITHIN</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">HOUR</span></span><br><span class="line">      <span class="keyword">DEFINE</span></span><br><span class="line">          B <span class="keyword">AS</span> B.price <span class="operator">&gt;</span> A.price <span class="operator">-</span> <span class="number">10</span>,</span><br><span class="line">          C <span class="keyword">AS</span> C.price <span class="operator">&lt;</span> A.price <span class="operator">-</span> <span class="number">10</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>该查询检测到在 1 小时的间隔内价格下降了 10.</p>
<p>假设该查询用于分析以下股票数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">symbol         rowtime         price    tax</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:00:00&#39;   20      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:20:00&#39;   17      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 10:40:00&#39;   18      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 11:00:00&#39;   11      3</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 11:20:00&#39;   14      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 11:40:00&#39;   9       1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 12:00:00&#39;   15      1</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 12:20:00&#39;   14      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 12:40:00&#39;   24      2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 13:00:00&#39;   1       2</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 13:20:00&#39;   19      1</span><br></pre></td></tr></table></figure>

<p>查询将生成以下结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">symbol         dropTime         dropDiff</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#39;ACME&#39;  &#39;01-Apr-11 13:00:00&#39;      14</span><br></pre></td></tr></table></figure>

<p>结果行代表价格从 15(在01-Apr-11 12:00:00)下降到 1(在01-Apr-11 13:00:00).<br>dropDiff 列包含价格差异.</p>
<p>请注意,即使价格也下降了较高的值,例如,下降了 11(在 01-Apr-11 10:00:00 和 01-Apr-11 11:40:00 之间),这两个事件之间的时间差大于 1 小时.<br>因此,它们不会产生匹配.</p>
<h3 id="输出方式"><a href="#输出方式" class="headerlink" title="输出方式"></a>输出方式</h3><p>输出方式 描述每个找到的匹配项应该输出多少行.<br>SQL 标准描述了两种方式:</p>
<ol>
<li>ALL ROWS PER MATCH</li>
<li>ONE ROW PER MATCH</li>
</ol>
<p>目前,唯一支持的输出方式是 ONE ROW PER MATCH,它将始终为每个找到的匹配项生成一个输出摘要行.<br>输出行的 schema 将是按特定顺序连接 <code>[partitioning columns] + [measures columns]</code>.<br>以下示例显示了所定义的查询的输出:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Ticker</span><br><span class="line">  <span class="keyword">MATCH_RECOGNIZE</span>(</span><br><span class="line">      <span class="keyword">PARTITION</span> <span class="keyword">BY</span> symbol</span><br><span class="line">      <span class="keyword">ORDER</span> <span class="keyword">BY</span> rowtime</span><br><span class="line">      MEASURES</span><br><span class="line">          <span class="keyword">FIRST</span>(A.price) <span class="keyword">AS</span> startPrice,</span><br><span class="line">          <span class="keyword">LAST</span>(A.price) <span class="keyword">AS</span> topPrice,</span><br><span class="line">          B.price <span class="keyword">AS</span> lastPrice</span><br><span class="line">      <span class="keyword">ONE</span> <span class="type">ROW</span> <span class="keyword">PER</span> <span class="keyword">MATCH</span></span><br><span class="line">      <span class="keyword">PATTERN</span> (A<span class="operator">+</span> B)</span><br><span class="line">      <span class="keyword">DEFINE</span></span><br><span class="line">          A <span class="keyword">AS</span> <span class="keyword">LAST</span>(A.price, <span class="number">1</span>) <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> A.price <span class="operator">&gt;</span> <span class="keyword">LAST</span>(A.price, <span class="number">1</span>),</span><br><span class="line">          B <span class="keyword">AS</span> B.price <span class="operator">&lt;</span> <span class="keyword">LAST</span>(A.price)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>对于以下输入行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">symbol   tax   price          rowtime</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">XYZ      1     10       2018-09-17 10:00:02</span><br><span class="line">XYZ      2     12       2018-09-17 10:00:03</span><br><span class="line">XYZ      1     13       2018-09-17 10:00:04</span><br><span class="line">XYZ      2     11       2018-09-17 10:00:05</span><br></pre></td></tr></table></figure>

<p>该查询将生成以下输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">symbol   startPrice   topPrice   lastPrice</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">XYZ      10           13         11</span><br></pre></td></tr></table></figure>

<p>该模式识别由 symbol 列分区.<br>即使在 MEASURES 子句中未明确提及,分区列仍会添加到结果的开头.</p>
<h3 id="模式导航"><a href="#模式导航" class="headerlink" title="模式导航"></a>模式导航</h3><p>DEFINE 和 MEASURES 子句允许在(可能)匹配模式的行列表中进行导航.<br>本节讨论用于声明条件或产生输出结果的导航.</p>
<h4 id="引用模式变量"><a href="#引用模式变量" class="headerlink" title="引用模式变量"></a>引用模式变量</h4><p>引用模式变量 允许引用一组映射到 DEFINE 或 MEASURES 子句中特定模式变量的行.</p>
<p>例如,如果我们尝试将当前行与 A 进行匹配,则表达式 A.price 描述了目前为止已映射到 A 的一组行加上当前行.<br>如果 DEFINE/MEASURES 子句中的表达式需要一行(例如 a.price 或 a.price &gt; 10),它将选择属于相应集合的最后一个值.</p>
<p>如果没有指定模式变量(例如 SUM(price)),则表达式引用默认模式变量 *,该变量引用模式中的所有变量.<br>换句话说,它创建了一个列表,其中列出了迄今为止映射到任何变量的所有行以及当前行.</p>
<h5 id="示例-4"><a href="#示例-4" class="headerlink" title="示例"></a>示例</h5><p>对于更全面的示例,可以查看以下模式和相应的条件:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PATTERN</span> (A B<span class="operator">+</span>)</span><br><span class="line"><span class="keyword">DEFINE</span></span><br><span class="line"> A <span class="keyword">AS</span> A.price <span class="operator">&gt;=</span> <span class="number">10</span>,</span><br><span class="line"> B <span class="keyword">AS</span> B.price <span class="operator">&gt;</span> A.price <span class="keyword">AND</span> <span class="built_in">SUM</span>(price) <span class="operator">&lt;</span> <span class="number">100</span> <span class="keyword">AND</span> <span class="built_in">SUM</span>(B.price) <span class="operator">&lt;</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>下表描述了如何为每个传入事件计算这些条件.<br>该表由以下列组成:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># - 行标识符,用于唯一标识列表中的传入行 [A.price]&#x2F;[B.price]&#x2F;[price].</span><br><span class="line">price - 传入行的价格.</span><br><span class="line">[A.price]&#x2F;[B.price]&#x2F;[price] - 描述 DEFINE 子句中用于计算条件的行列表.</span><br><span class="line">Classifier - 当前行的分类器,指示该行映射到的模式变量.</span><br><span class="line">A.price&#x2F;B.price&#x2F;SUM(price)&#x2F;SUM(B.price) - 描述了这些表达式求值后的结果.</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># price Classifier  [A.price] [B.price] [price] A.price B.price SUM(price)  SUM(B.price)</span><br><span class="line">#1  10  -&gt; A </span><br><span class="line">#2  15  -&gt; B </span><br><span class="line">#3  20  -&gt; B </span><br><span class="line">#4  31  -&gt; B </span><br><span class="line">#5  35   </span><br></pre></td></tr></table></figure>

<p>从表中可以看出,第一行映射到模式变量 A,随后的行映射到模式变量 B.<br>但是,最后一行不满足 B 条件,因为所有映射行 SUM(price) 的总和与 B 中所有行的总和都超过了指定的阈值.</p>
<h4 id="Logical-Offsets"><a href="#Logical-Offsets" class="headerlink" title="Logical Offsets"></a>Logical Offsets</h4><p>Logical offsets 在映射到指定模式变量的事件启用导航.<br>这可以用两个相应的函数表示:<br>LAST(variable.field, n)<br>返回映射到变量最后 n 个元素的事件中的字段值.<br>计数从映射的最后一个元素开始.</p>
<p>FIRST(variable.field, n)<br>返回映射到变量的第 n 个元素的事件中的字段值.<br>计数从映射的第一个元素开始.</p>
<h5 id="示例-5"><a href="#示例-5" class="headerlink" title="示例"></a>示例</h5><p>对于更全面的示例,可以参考以下模式和相应的条件:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PATTERN</span> (A B<span class="operator">+</span>)</span><br><span class="line"><span class="keyword">DEFINE</span></span><br><span class="line"> A <span class="keyword">AS</span> A.price <span class="operator">&gt;=</span> <span class="number">10</span>,</span><br><span class="line"> B <span class="keyword">AS</span> (<span class="keyword">LAST</span>(B.price, <span class="number">1</span>) <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> B.price <span class="operator">&gt;</span> <span class="keyword">LAST</span>(B.price, <span class="number">1</span>)) <span class="keyword">AND</span></span><br><span class="line">     (<span class="keyword">LAST</span>(B.price, <span class="number">2</span>) <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> B.price <span class="operator">&gt;</span> <span class="number">2</span> <span class="operator">*</span> <span class="keyword">LAST</span>(B.price, <span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<p>下表描述了如何为每个传入事件计算这些条件.<br>该表包括以下列:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">price - 传入行的价格.</span><br><span class="line">Classifier - 当前行的分类器,指示该行映射到的模式变量.</span><br><span class="line">LAST(B.price, 1)&#x2F;LAST(B.price, 2) - 描述对这些表达式求值后的结果.</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">price Classifier  LAST(B.price, 1)  LAST(B.price, 2)  Comment</span><br><span class="line">10  -&gt; A      </span><br><span class="line">15  -&gt; B  null  null  注意:LAST(B.price, 1) 为空,因为仍然没有映射到 B.</span><br><span class="line"></span><br><span class="line">20  -&gt; B  15  null  </span><br><span class="line">31  -&gt; B  20  15  </span><br><span class="line">35    31  20  因为 35 &lt; 2 * 20 没有映射.</span><br></pre></td></tr></table></figure>

<p>将默认模式变量与 logical offsets 一起使用也可能很有意义.</p>
<p>在这种情况下,offset 会包含到目前为止映射的所有行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PATTERN (A B? C)</span><br><span class="line">DEFINE</span><br><span class="line"> B AS B.price &lt; 20,</span><br><span class="line"> C AS LAST(price, 1) &lt; C.price</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">price Classifier  LAST(price, 1)  Comment</span><br><span class="line">10  -&gt; A    </span><br><span class="line">15  -&gt; B    </span><br><span class="line">20  -&gt; C  15  LAST(price, 1) 被计算为映射到 B 变量的行的价格.</span><br></pre></td></tr></table></figure>

<p>如果第二行没有映射到 B 变量,则会得到以下结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">price Classifier  LAST(price, 1)  Comment</span><br><span class="line">10  -&gt; A    </span><br><span class="line">20  -&gt; C  10  LAST(price, 1) 被计算为映射到 A 变量的行的价格.</span><br></pre></td></tr></table></figure>

<p>也可以在 FIRST/LAST 函数的第一个参数中使用多个模式变量引用.<br>这样,可以编写访问多个列的表达式.<br>但是,它们都必须使用相同的模式变量.<br>换句话说,必须在一行中计算 LAST/FIRST 函数的值.</p>
<p>因此,可以使用 LAST(A.price * A.tax),但不允许使用类似 LAST(A.price * B.tax) 的表达式.</p>
<h3 id="匹配后的策略"><a href="#匹配后的策略" class="headerlink" title="匹配后的策略"></a>匹配后的策略</h3><p>AFTER MATCH SKIP 子句指定在找到完全匹配后从何处开始新的匹配过程.</p>
<p>有四种不同的策略:<br>SKIP PAST LAST ROW - 在当前匹配的最后一行之后的下一行继续模式匹配.<br>SKIP TO NEXT ROW - 继续从匹配项开始行后的下一行开始搜索新匹配项.<br>SKIP TO LAST variable - 恢复映射到指定模式变量的最后一行的模式匹配.<br>SKIP TO FIRST variable - 在映射到指定模式变量的第一行继续模式匹配.</p>
<p>这也是一种指定单个事件可以属于多少个匹配项的方法.<br>例如,使用 SKIP PAST LAST ROW 策略,每个事件最多只能属于一个匹配项.</p>
<h4 id="示例-6"><a href="#示例-6" class="headerlink" title="示例"></a>示例</h4><p>为了更好地理解这些策略之间的差异,我们可以看看下面的例子.</p>
<p>对于以下输入行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">symbol   tax   price         rowtime</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">XYZ      1     7       2018-09-17 10:00:01</span><br><span class="line">XYZ      2     9       2018-09-17 10:00:02</span><br><span class="line">XYZ      1     10      2018-09-17 10:00:03</span><br><span class="line">XYZ      2     5       2018-09-17 10:00:04</span><br><span class="line">XYZ      2     10      2018-09-17 10:00:05</span><br><span class="line">XYZ      2     7       2018-09-17 10:00:06</span><br><span class="line">XYZ      2     14      2018-09-17 10:00:07</span><br></pre></td></tr></table></figure>

<p>我们使用不同的策略评估以下查询:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Ticker</span><br><span class="line">  <span class="keyword">MATCH_RECOGNIZE</span>(</span><br><span class="line">      <span class="keyword">PARTITION</span> <span class="keyword">BY</span> symbol</span><br><span class="line">      <span class="keyword">ORDER</span> <span class="keyword">BY</span> rowtime</span><br><span class="line">      MEASURES</span><br><span class="line">          <span class="built_in">SUM</span>(A.price) <span class="keyword">AS</span> sumPrice,</span><br><span class="line">          <span class="keyword">FIRST</span>(rowtime) <span class="keyword">AS</span> startTime,</span><br><span class="line">          <span class="keyword">LAST</span>(rowtime) <span class="keyword">AS</span> endTime</span><br><span class="line">      <span class="keyword">ONE</span> <span class="type">ROW</span> <span class="keyword">PER</span> <span class="keyword">MATCH</span></span><br><span class="line">      [AFTER <span class="keyword">MATCH</span> STRATEGY]</span><br><span class="line">      <span class="keyword">PATTERN</span> (A<span class="operator">+</span> C)</span><br><span class="line">      <span class="keyword">DEFINE</span></span><br><span class="line">          A <span class="keyword">AS</span> <span class="built_in">SUM</span>(A.price) <span class="operator">&lt;</span> <span class="number">30</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>该查询返回映射到 A 的总体匹配的第一个和最后一个时间戳所有行的价格之和.</p>
<p>查询将根据使用的 AFTER MATCH 策略产生不同的结果:</p>
<p>AFTER MATCH SKIP PAST LAST ROW</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">symbol   sumPrice        startTime              endTime</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">XYZ      26         2018-09-17 10:00:01   2018-09-17 10:00:04</span><br><span class="line">XYZ      17         2018-09-17 10:00:05   2018-09-17 10:00:07</span><br></pre></td></tr></table></figure>

<p>第一个结果与<br>第二个结果与</p>
<p>AFTER MATCH SKIP TO NEXT ROW</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">symbol   sumPrice        startTime              endTime</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">XYZ      26         2018-09-17 10:00:01   2018-09-17 10:00:04</span><br><span class="line">XYZ      24         2018-09-17 10:00:02   2018-09-17 10:00:05</span><br><span class="line">XYZ      25         2018-09-17 10:00:03   2018-09-17 10:00:06</span><br><span class="line">XYZ      22         2018-09-17 10:00:04   2018-09-17 10:00:07</span><br><span class="line">XYZ      17         2018-09-17 10:00:05   2018-09-17 10:00:07</span><br></pre></td></tr></table></figure>

<p>同样,第一个结果与</p>
<p>与上一个策略相比,下一个匹配再次包含<br>因此,第二个结果与<br>第三个结果与<br>第四个结果与<br>最后一个结果与</p>
<p>AFTER MATCH SKIP TO LAST A</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">symbol   sumPrice        startTime              endTime</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">XYZ      26         2018-09-17 10:00:01   2018-09-17 10:00:04</span><br><span class="line">XYZ      25         2018-09-17 10:00:03   2018-09-17 10:00:06</span><br><span class="line">XYZ      17         2018-09-17 10:00:05   2018-09-17 10:00:07</span><br></pre></td></tr></table></figure>

<p>同样,第一个结果与</p>
<p>与前一个策略相比,下一个匹配只包含<br>因此,第二个结果与<br>最后一个结果与</p>
<p>AFTER MATCH SKIP TO FIRST A</p>
<p>这种组合将产生一个运行时异常,因为人们总是试图在上一个开始的地方开始一个新的匹配.<br>这将产生一个无限循环,因此是禁止的.</p>
<p>必须记住,在 SKIP TO FIRST/LAST variable 策略的场景下,可能没有映射到该变量的行(例如,对于模式 A*).<br>在这种情况下,将抛出一个运行时异常,因为标准要求一个有效的行来继续匹配.</p>
<h3 id="时间属性-1"><a href="#时间属性-1" class="headerlink" title="时间属性"></a>时间属性</h3><p>为了在 MATCH_RECOGNIZE 之上应用一些后续查询,可能需要使用时间属性.<br>有两个函数可供选择.</p>
<h4 id="MATCH-ROWTIME-rowtime-field"><a href="#MATCH-ROWTIME-rowtime-field" class="headerlink" title="MATCH_ROWTIME([rowtime_field])"></a>MATCH_ROWTIME(<code>[rowtime_field]</code>)</h4><p>返回映射到给定模式的最后一行的时间戳.<br>函数可以没有入参,这种情况下函数返回结果是 TIMESTAMP 类型且具有事件时间属性.也可以有一个入参,这个参数值必须是 TIMESTAMP 类型或者 TIMESTAMP_LTZ 类型,且必须有事件时间属性,这种情况下函数返回结果的数据类型和输入参数的一致,且必须有事件时间属性.</p>
<p>结果属性是事件时间属性,可用于后续基于时间的操作,例如 interval joins 和 group window or over window aggregations.</p>
<h4 id="MATCH-PROCTIME"><a href="#MATCH-PROCTIME" class="headerlink" title="MATCH_PROCTIME()"></a>MATCH_PROCTIME()</h4><p>返回处理时间属性,该属性可用于随后的基于时间的操作,例如 interval joins 和 group window or over window aggregations.</p>
<h3 id="控制内存消耗"><a href="#控制内存消耗" class="headerlink" title="控制内存消耗"></a>控制内存消耗</h3><p>在编写 MATCH_RECOGNIZE 查询时,内存消耗是一个重要的考虑因素,因为潜在匹配的空间是以宽度优先的方式构建的.<br>鉴于此,我们必须确保模式能够完成.<br>最好使用映射到匹配项的合理数量的行,因为它们必须内存相适.</p>
<p>例如,该模式不能有没有接受每一行上限的量词.<br>这种模式可以是这样的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PATTERN (A B+ C)</span><br><span class="line">DEFINE</span><br><span class="line"> A as A.price &gt; 10,</span><br><span class="line"> C as C.price &gt; 20</span><br></pre></td></tr></table></figure>

<p>查询将每个传入行映射到 B 变量,因此永远不会完成.<br>可以纠正此查询,例如,通过否定 C 的条件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PATTERN (A B+ C)</span><br><span class="line">DEFINE</span><br><span class="line"> A as A.price &gt; 10,</span><br><span class="line"> B as B.price &lt;&#x3D; 20,</span><br><span class="line"> C as C.price &gt; 20</span><br></pre></td></tr></table></figure>

<p>或者使用 reluctant quantifier:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PATTERN (A B+? C)</span><br><span class="line">DEFINE</span><br><span class="line"> A as A.price &gt; 10,</span><br><span class="line"> C as C.price &gt; 20</span><br></pre></td></tr></table></figure>

<p>注意:请注意,MATCH_RECOGNIZE 子句未使用配置的 state retention time.<br>为此,可能需要使用 WITHIN 子句.</p>
<h3 id="已知的局限"><a href="#已知的局限" class="headerlink" title="已知的局限"></a>已知的局限</h3><p>Flink 对 MATCH_RECOGNIZE 子句实现是一项长期持续的工作,目前尚不支持 SQL 标准的某些功能.</p>
<p>不支持的功能包括.</p>
<h4 id="模式表达式"><a href="#模式表达式" class="headerlink" title="模式表达式"></a>模式表达式</h4><p>Pattern groups - 这意味着量词不能应用于模式的子序列.<br>因此,(A (B C)+) 不是有效的模式.</p>
<p>Alterations - 像 PATTERN((A B | C D) E)这样的模式,这意味着在寻找 E 行之前必须先找到子序列 A B 或者 C D.</p>
<p>PERMUTE operator - 这等同于它应用于所示的所有变量的排列 PATTERN (PERMUTE (A, B, C)) = PATTERN (A B C | A C B | B A C | B C A | C A B | C B A).</p>
<p>Anchors - ^, $,表示分区的开始/结束,在流上下文中没有意义,将不被支持.</p>
<p>Exclusion - PATTERN ({- A -} B) 表示将查找 A,但是不会参与输出.<br>这只适用于 ALL ROWS PER MATCH 方式.</p>
<p>Reluctant optional quantifier - PATTERN A?? 只支持贪婪的可选量词.</p>
<p>ALL ROWS PER MATCH 输出方式 - 为参与创建匹配项的每一行产生一个输出行.<br>这也意味着:<br>MEASURES 子句唯一支持的语义是 FINAL<br>CLASSIFIER 函数,尚不支持返回行映射到的模式变量.</p>
<p>SUBSET - 它允许创建模式变量的逻辑组,并在 DEFINE 和 MEASURES 子句中使用这些组.</p>
<p>Physical offsets - PREV/NEXT,它为所有可见事件建立索引,而不是仅将那些映射到模式变量的事件编入索引(如 logical offsets 的情况).</p>
<p>提取时间属性 - 目前无法为后续基于时间的操作提取时间属性.</p>
<p>MATCH_RECOGNIZE 仅 SQL 支持.<br>Table API 中没有等效项.</p>
<p>Aggregations:<br>不支持 distinct aggregations.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/flink/" rel="tag"># flink</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/08/22/flink%20table%20api/" rel="prev" title="flink table api">
                  <i class="fa fa-chevron-left"></i> flink table api
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/08/22/flink%20sql/" rel="next" title="flink sql">
                  flink sql <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">maoeryu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  





</body>
</html>
