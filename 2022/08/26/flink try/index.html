<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"maoeryu.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.2.1","exturl":false,"sidebar":{"position":"left","width":200,"display":"post","padding":7,"offset":5},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="基于DataStream API实现欺诈检测对于一个账户,如果出现小于 $1 美元的交易后紧跟着一个大于 $500 的交易,就输出一个报警信息.  当标记状态被设置为 true 时,设置一个在当前时间一分钟后触发的定时器. 当定时器被触发时,重置标记状态. 当标记状态被重置时,删除定时器">
<meta property="og:type" content="article">
<meta property="og:title" content="flink try">
<meta property="og:url" content="https://maoeryu.github.io/2022/08/26/flink%20try/index.html">
<meta property="og:site_name" content="FlyingPig">
<meta property="og:description" content="基于DataStream API实现欺诈检测对于一个账户,如果出现小于 $1 美元的交易后紧跟着一个大于 $500 的交易,就输出一个报警信息.  当标记状态被设置为 true 时,设置一个在当前时间一分钟后触发的定时器. 当定时器被触发时,重置标记状态. 当标记状态被重置时,删除定时器">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://maoeryu.github.io/images/ft1.svg">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl89.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl90.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl91.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl92.png">
<meta property="article:published_time" content="2022-08-25T16:00:00.000Z">
<meta property="article:modified_time" content="2022-09-16T08:39:14.222Z">
<meta property="article:author" content="maoeryu">
<meta property="article:tag" content="flink">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://maoeryu.github.io/images/ft1.svg">


<link rel="canonical" href="https://maoeryu.github.io/2022/08/26/flink%20try/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>flink try | FlyingPig</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">FlyingPig</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EDataStream-API%E5%AE%9E%E7%8E%B0%E6%AC%BA%E8%AF%88%E6%A3%80%E6%B5%8B"><span class="nav-number">1.</span> <span class="nav-text">基于DataStream API实现欺诈检测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.1.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98-distributedCache"><span class="nav-number">2.</span> <span class="nav-text">分布式缓存(distributedCache)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">2.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">2.2.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Broadcast%E5%B9%BF%E6%92%AD%E5%8F%98%E9%87%8F-DataSet"><span class="nav-number">3.</span> <span class="nav-text">Broadcast广播变量(DataSet)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">3.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%B3%95"><span class="nav-number">3.2.</span> <span class="nav-text">用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">3.3.</span> <span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="nav-number">3.4.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EFlink-Broadcast-State%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE-DataStream"><span class="nav-number">4.</span> <span class="nav-text">基于Flink Broadcast State实现动态更新配置(DataStream)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF"><span class="nav-number">4.1.</span> <span class="nav-text">需求背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-3"><span class="nav-number">4.2.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-sink"><span class="nav-number">5.</span> <span class="nav-text">redis sink</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysql-sink"><span class="nav-number">6.</span> <span class="nav-text">mysql sink</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#clickhouse-sink"><span class="nav-number">7.</span> <span class="nav-text">clickhouse sink</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hbase"><span class="nav-number">8.</span> <span class="nav-text">hbase</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sink"><span class="nav-number">8.1.</span> <span class="nav-text">sink</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%A7%E6%89%BFRichSinkFunction"><span class="nav-number">8.1.1.</span> <span class="nav-text">继承RichSinkFunction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0OutputFormat%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.1.2.</span> <span class="nav-text">实现OutputFormat接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HBaseSinkFunction-HBaseMutationConverter"><span class="nav-number">8.1.3.</span> <span class="nav-text">HBaseSinkFunction&#x2F;HBaseMutationConverter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HBaseDynamicTableSink-HBaseUpsertTableSink"><span class="nav-number">8.1.4.</span> <span class="nav-text">HBaseDynamicTableSink&#x2F;HBaseUpsertTableSink</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#source"><span class="nav-number">8.2.</span> <span class="nav-text">source</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%A7%E6%89%BFRichSourceFunction"><span class="nav-number">8.2.1.</span> <span class="nav-text">继承RichSourceFunction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89TableInputFormat%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.2.2.</span> <span class="nav-text">实现自定义TableInputFormat接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HBaseTableSource"><span class="nav-number">8.2.3.</span> <span class="nav-text">HBaseTableSource</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#flink%E5%8F%8C%E6%B5%81join"><span class="nav-number">9.</span> <span class="nav-text">flink双流join</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#join%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="nav-number">9.1.</span> <span class="nav-text">join实现机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-Join"><span class="nav-number">9.2.</span> <span class="nav-text">Window Join</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#join"><span class="nav-number">9.2.1.</span> <span class="nav-text">join</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#coGroup"><span class="nav-number">9.2.2.</span> <span class="nav-text">coGroup</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Interval-Join"><span class="nav-number">9.3.</span> <span class="nav-text">Interval Join</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connect"><span class="nav-number">9.4.</span> <span class="nav-text">Connect</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">maoeryu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">219</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://maoeryu.github.io/2022/08/26/flink%20try/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="maoeryu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlyingPig">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          flink try
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2022-08-26T00:00:00+08:00">2022-08-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-09-16 16:39:14" itemprop="dateModified" datetime="2022-09-16T16:39:14+08:00">2022-09-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8D%8F%E5%90%8C%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">协同框架</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="基于DataStream-API实现欺诈检测"><a href="#基于DataStream-API实现欺诈检测" class="headerlink" title="基于DataStream API实现欺诈检测"></a>基于DataStream API实现欺诈检测</h2><p>对于一个账户,如果出现小于 $1 美元的交易后紧跟着一个大于 $500 的交易,就输出一个报警信息.</p>
<ol>
<li>当标记状态被设置为 true 时,设置一个在当前时间一分钟后触发的定时器.</li>
<li>当定时器被触发时,重置标记状态.</li>
<li>当标记状态被重置时,删除定时器</li>
</ol>
<span id="more"></span>
<img src="/images/ft1.svg" style="margin-left: 0px; padding-bottom: 10px;">

<p>欺诈检测器需要在多个交易事件之间记住一些信息.<br>仅当一个大额的交易紧随一个小额交易的情况发生时,这个大额交易才被认为是欺诈交易.<br>在多个事件之间存储信息就需要使用到 状态,这也是我们选择使用 KeyedProcessFunction 的原因.</p>
<p>Flink 中最基础的状态类型是 ValueState,这是一种能够为被其封装的变量添加容错能力的类型.<br>ValueState 是一种 keyed state,也就是说它只能被用于 keyed context 提供的 operator 中,即所有能够紧随 DataStream#keyBy 之后被调用的operator.<br>一个 operator 中的 keyed state 的作用域默认是属于它所属的 key 的.<br>这个例子中,key 就是当前正在处理的交易行为所属的信用卡账户(key 传入 keyBy() 函数调用),而 FraudDetector 维护了每个帐户的标记状态.<br>ValueState 需要使用 ValueStateDescriptor 来创建,ValueStateDescriptor 包含了 Flink 如何管理变量的一些元数据信息.<br>状态在使用之前需要先被注册.<br>状态需要使用 open() 函数来注册状态.</p>
<p>ValueState 是一个包装类,类似于 Java 标准库里边的 AtomicReference 和 AtomicLong.<br>它提供了三个用于交互的方法:update 用于更新状态,value 用于获取状态值,还有 clear 用于清空状态.<br>如果一个 key 还没有状态,例如当程序刚启动或者调用过 ValueState#clear 方法时,ValueState#value 将会返回 null.<br>如果需要更新状态,需要调用 ValueState#update 方法,直接更改 ValueState#value 的返回值可能不会被系统识别.<br>容错处理将在 Flink 后台自动管理,你可以像与常规变量那样与状态变量进行交互.</p>
<p>要删除一个定时器,你需要记录这个定时器的触发时间,这同样需要状态来实现.</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FraudDetectionJob</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">    DataStream&lt;Transaction&gt; transactions = env</span><br><span class="line">      .addSource(<span class="keyword">new</span> TransactionSource())</span><br><span class="line">      .name(<span class="string">&quot;transactions&quot;</span>);</span><br><span class="line"></span><br><span class="line">    DataStream&lt;Alert&gt; alerts = transactions</span><br><span class="line">      .keyBy(Transaction::getAccountId)</span><br><span class="line">      .process(<span class="keyword">new</span> FraudDetector())</span><br><span class="line">      .name(<span class="string">&quot;fraud-detector&quot;</span>);</span><br><span class="line"></span><br><span class="line">    alerts</span><br><span class="line">      .addSink(<span class="keyword">new</span> AlertSink())</span><br><span class="line">      .name(<span class="string">&quot;send-alerts&quot;</span>);</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;Fraud Detection&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 欺诈检测器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FraudDetector</span> <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>&lt;<span class="title">String</span>, <span class="title">Transaction</span>, <span class="title">Alert</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> SMALL_AMOUNT = <span class="number">1.00</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> LARGE_AMOUNT = <span class="number">500.00</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> ONE_MINUTE = <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">transient</span> ValueState&lt;Boolean&gt; flagState;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">transient</span> ValueState&lt;Long&gt; timerState;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> </span>&#123;</span><br><span class="line">    ValueStateDescriptor&lt;Boolean&gt; flagDescriptor = <span class="keyword">new</span> ValueStateDescriptor&lt;&gt;(</span><br><span class="line">        <span class="string">&quot;flag&quot;</span>,</span><br><span class="line">        Types.BOOLEAN);</span><br><span class="line">    flagState = getRuntimeContext().getState(flagDescriptor);</span><br><span class="line"></span><br><span class="line">    ValueStateDescriptor&lt;Long&gt; timerDescriptor = <span class="keyword">new</span> ValueStateDescriptor&lt;&gt;(</span><br><span class="line">        <span class="string">&quot;timer-state&quot;</span>,</span><br><span class="line">        Types.LONG);</span><br><span class="line">    timerState = getRuntimeContext().getState(timerDescriptor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * processElement 将会在每个交易事件上被调用</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      Transaction transaction,</span></span></span><br><span class="line"><span class="function"><span class="params">      Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">      Collector&lt;Alert&gt; collector)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the current state for the current key</span></span><br><span class="line">    Boolean lastTransactionWasSmall = flagState.value();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if the flag is set</span></span><br><span class="line">    <span class="keyword">if</span> (lastTransactionWasSmall != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (transaction.getAmount() &gt; LARGE_AMOUNT) &#123;</span><br><span class="line">        <span class="comment">//Output an alert downstream</span></span><br><span class="line">        Alert alert = <span class="keyword">new</span> Alert();</span><br><span class="line">        alert.setId(transaction.getAccountId());</span><br><span class="line"></span><br><span class="line">        collector.collect(alert);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Clean up our state</span></span><br><span class="line">      cleanUp(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (transaction.getAmount() &lt; SMALL_AMOUNT) &#123;</span><br><span class="line">      <span class="comment">// set the flag to true</span></span><br><span class="line">      flagState.update(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> timer = context.timerService().currentProcessingTime() + ONE_MINUTE;</span><br><span class="line">      context.timerService().registerProcessingTimeTimer(timer);</span><br><span class="line"></span><br><span class="line">      timerState.update(timer);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimer</span><span class="params">(<span class="keyword">long</span> timestamp, OnTimerContext ctx, Collector&lt;Alert&gt; out)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// remove flag after 1 minute</span></span><br><span class="line">    timerState.clear();</span><br><span class="line">    flagState.clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanUp</span><span class="params">(Context ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// delete timer</span></span><br><span class="line">    Long timer = timerState.value();</span><br><span class="line">    ctx.timerService().deleteProcessingTimeTimer(timer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clean up all state</span></span><br><span class="line">    timerState.clear();</span><br><span class="line">    flagState.clear();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="分布式缓存-distributedCache"><a href="#分布式缓存-distributedCache" class="headerlink" title="分布式缓存(distributedCache)"></a>分布式缓存(distributedCache)</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Flink提供了一个分布式缓存,类似于hadoop,可以使用户在并行函数中很方便的读取本地文件,并把它放在taskmanager节点中,防止task重复拉取.</p>
<p>此缓存的工作机制如下:<br>程序注册一个文件或者目录(本地或者远程文件系统,例如hdfs或者s3),通过ExecutionEnvironment注册缓存文件并为它起一个名称.</p>
<p>当程序执行,Flink自动将文件或者目录复制到所有taskmanager节点的本地文件系统,仅会执行一次.<br>用户可以通过这个指定的名称查找文件或者目录,然后从taskmanager节点的本地文件系统访问它.</p>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><p>在ExecutionEnvironment中注册一个文件.<br>在用户函数中访问缓存文件或者目录(这里是一个map函数).<br>这个函数必须继承RichFunction,因为它需要使用RuntimeContext读取数据.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册一个文件,可以使用hdfs上的文件,也可以是本地文件进行测试</span></span><br><span class="line"><span class="comment">//text中有4个单词:hello flink hello FLINK</span></span><br><span class="line">env.registerCachedFile(<span class="string">&quot;d:/mypro/sftp/a.txt&quot;</span>, <span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">DataStream&lt;String&gt; source = env.fromElements(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>);</span><br><span class="line">DataStream&lt;String&gt; result = source.map(<span class="keyword">new</span> RichMapFunction&lt;String, String&gt;() &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;String&gt; dataList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.open(parameters);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2:使用文件</span></span><br><span class="line">    File myFile = getRuntimeContext().getDistributedCache().getFile(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">    List&lt;String&gt; lines = FileUtils.readLines(myFile);</span><br><span class="line">    <span class="keyword">for</span> (String line : lines) &#123;</span><br><span class="line">      dataList.add(line);</span><br><span class="line">      System.err.println(<span class="string">&quot;分布式缓存为:&quot;</span> + line);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//在这里就可以使用dataList</span></span><br><span class="line">    System.err.println(<span class="string">&quot;使用datalist:&quot;</span> + dataList + <span class="string">&quot;------------&quot;</span> + value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//业务逻辑</span></span><br><span class="line">    <span class="keyword">return</span> dataList + <span class="string">&quot;: &quot;</span> + value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">result.printToErr();</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行job</span></span><br><span class="line">env.execute(<span class="string">&quot;distributedCacheJob&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>8&gt; [hello, flink, hello, FLINK]: a<br>2&gt; [hello, flink, hello, FLINK]: c<br>3&gt; [hello, flink, hello, FLINK]: d</p>
<h2 id="Broadcast广播变量-DataSet"><a href="#Broadcast广播变量-DataSet" class="headerlink" title="Broadcast广播变量(DataSet)"></a>Broadcast广播变量(DataSet)</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>在Flink中,同一个算子可能存在若干个不同的并行实例,计算过程可能不在同一个Slot中进行,不同算子之间更是如此,因此不同算子的计算数据之间不能像Java数组之间一样互相访问,而广播变量Broadcast便是解决这种情况的.</p>
<p>我们可以把广播变量理解为是一个公共的共享变量,我们可以把一个dataset 数据集广播出去,然后不同的task在节点上都能够获取到,这个数据在每个节点上只会存在一份.</p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#1:初始化数据</span><br><span class="line">DataSet&lt;Integer&gt; num = env.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">#2:广播数据</span><br><span class="line">.withBroadcastSet(toBroadcast, <span class="string">&quot;num&quot;</span>);</span><br><span class="line">#3:获取数据</span><br><span class="line">Collection&lt;Integer&gt; broadcastSet = getRuntimeContext().getBroadcastVariable(<span class="string">&quot;num&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><p>使用广播状态,task 之间不会相互通信<br>只有广播的一边可以修改广播状态的内容.<br>用户必须保证所有 operator 并发实例上对广播状态的修改行为都是一致的.<br>或者说,如果不同的并发实例拥有不同的广播状态内容,将导致不一致的结果.</p>
</li>
<li><p>广播状态中事件的顺序在各个并发实例中可能不尽相同<br>广播流的元素保证了将所有元素(最终)都发给下游所有的并发实例,但是元素的到达的顺序可能在并发实例之间并不相同.<br>因此,对广播状态的修改不能依赖于输入数据的顺序.</p>
</li>
<li><p>所有operator task都会快照下他们的广播状态<br>在checkpoint时,所有的 task 都会 checkpoint 下他们的广播状态,随着并发度的增加,checkpoint 的大小也会随之增加.</p>
</li>
<li><p>广播变量存在内存中<br>广播出去的变量存在于每个节点的内存中,所以这个数据集不能太大,百兆左右可以接受,Gb不能接受.</p>
</li>
</ol>
<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">DataSet&lt;Integer&gt; broadcast = env.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">DataSet&lt;String&gt; source = env.fromElements(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>);</span><br><span class="line"></span><br><span class="line">source</span><br><span class="line">    .map(<span class="keyword">new</span> RichMapFunction&lt;String, String&gt;() &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;Integer&gt; dataList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.open(parameters);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 获取广播的DataSet数据 作为一个Collection</span></span><br><span class="line">        Collection&lt;Integer&gt; broadcastSet = getRuntimeContext().getBroadcastVariable(<span class="string">&quot;number&quot;</span>);</span><br><span class="line">        dataList.addAll(broadcastSet);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataList + <span class="string">&quot;: &quot;</span> + value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .withBroadcastSet(broadcast, <span class="string">&quot;number&quot;</span>)</span><br><span class="line">    .printToErr();</span><br></pre></td></tr></table></figure>

<h2 id="基于Flink-Broadcast-State实现动态更新配置-DataStream"><a href="#基于Flink-Broadcast-State实现动态更新配置-DataStream" class="headerlink" title="基于Flink Broadcast State实现动态更新配置(DataStream)"></a>基于Flink Broadcast State实现动态更新配置(DataStream)</h2><p>Flink从1.5.0开始支持广播状态(Broadcast State).<br>广播状态可以用来解决如下问题:一条流需要根据规则或配置处理数据,而规则或配置又是随时变化的.<br>此时,就可将规则或配置作为广播流广播出去,并以Broadcast State的形式存储在下游Task中.<br>下游Task根据Broadcast State中的规则或配置来处理常规流中的数据.</p>
<p>场景举例:</p>
<ol>
<li>动态更新计算规则<br>如事件流需要根据最新的规则进行计算,则可将规则作为广播状态广播到下游Task中.</li>
<li>实时增加额外字段<br>如事件流需要实时增加用户的基础信息,则可将用户的基础信息作为广播状态广播到下游Task中.</li>
</ol>
<p>注意:</p>
<ol>
<li>Broadcast State是Map类型,即K-V类型.</li>
<li>Broadcast State只有在广播的一侧,即在BroadcastProcessFunction或KeyedBroadcastProcessFunction的processBroadcastElement方法中可以修改.<br>在非广播的一侧,即在BroadcastProcessFunction或KeyedBroadcastProcessFunction的processElement方法中只读.</li>
<li>Broadcast State中元素的顺序,在各Task中可能不同,基于顺序的处理,需要注意.</li>
<li>Broadcast State在Checkpoint时,每个Task都会Checkpoint广播状态.</li>
<li>Broadcast State在运行时保存在内存中,目前还不能保存在RocksDB State Backend中.</li>
</ol>
<p>假设我们现在有这样的需求:基于Broadcast State 动态更新配置以实现实时过滤数据并增加字段.</p>
<h3 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h3><p>假设有这样的一个需求,需要实时过滤出配置中的用户,并在事件流中补全这批用户的基础信息.</p>
<p>事件: 在Kafka中,自己造的数据,格式如下.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#某个用户在某个时刻浏览或点击了某个商品</span><br><span class="line">1661496308305 3</span><br><span class="line">1661496312409 1</span><br><span class="line">1661496313425 2</span><br></pre></td></tr></table></figure>

<p>配置: 在Mysql中,自己造的数据,表字段为id/name/age.<br>1/tom1/11<br>2/tom2/12<br>3/tom3/13</p>
<h3 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(TestBroadcastState.class);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="comment">//1.解析命令行参数 --conf /xxx/xxx</span></span><br><span class="line">  ParameterTool fromArgs = ParameterTool.fromArgs(args);</span><br><span class="line">  ParameterTool parameterTool = ParameterTool.fromPropertiesFile(fromArgs.getRequired(<span class="string">&quot;conf&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//2.配置运行环境</span></span><br><span class="line">  StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">  env.getConfig().setGlobalJobParameters(parameterTool);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//3.Kafka事件流</span></span><br><span class="line">  <span class="comment">//某个用户在某个时刻浏览或点击了某个商品,如&quot;1661493722490/1&quot;</span></span><br><span class="line">  KafkaSource&lt;String&gt; kafkaSource = KafkaSource.&lt;String&gt;builder()</span><br><span class="line">      .setBootstrapServers(parameterTool.get(Constants.KAFKA_CONSUMER_BOOTSTRAP_SERVERS))</span><br><span class="line">      .setTopics(parameterTool.get(Constants.KAFKA_TOPICS))</span><br><span class="line">      .setGroupId(parameterTool.get(Constants.KAFKA_CONSUMER_GROUP_ID))</span><br><span class="line">      .setStartingOffsets(OffsetsInitializer.committedOffsets(OffsetResetStrategy.LATEST))</span><br><span class="line">      .setValueOnlyDeserializer(<span class="keyword">new</span> SimpleStringSchema())</span><br><span class="line">      .build();</span><br><span class="line"></span><br><span class="line">  WatermarkStrategy&lt;String&gt; watermarkStrategy = WatermarkStrategy</span><br><span class="line">      .&lt;String&gt;forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">      .withTimestampAssigner(<span class="keyword">new</span> SerializableTimestampAssigner&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(String element, <span class="keyword">long</span> recordTimestamp)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> Long.parseLong(element.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .withIdleness(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; eventStream = env.fromSource(kafkaSource, watermarkStrategy, <span class="string">&quot;kafka-source&quot;</span>)</span><br><span class="line">      .uid(<span class="string">&quot;xx1&quot;</span>)</span><br><span class="line">      .process(<span class="keyword">new</span> ProcessFunction&lt;String, Tuple2&lt;String, Integer&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(String value, Context ctx, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] arr = value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">            String eventTime = arr[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> id = Integer.parseInt(arr[<span class="number">1</span>]);</span><br><span class="line">            out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(eventTime, id));</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;异常数据:&#123;&#125;&quot;</span>, value, e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//4.Mysql配置流</span></span><br><span class="line">  <span class="comment">//自定义Mysql Source,周期性地从Mysql中获取配置,并广播出去</span></span><br><span class="line">  <span class="comment">//用户ID,用户姓名:用户年龄</span></span><br><span class="line">  DataStreamSource&lt;HashMap&lt;Integer, Tuple2&lt;String, Integer&gt;&gt;&gt; configStream = env.addSource(<span class="keyword">new</span> MysqlSource());</span><br><span class="line"></span><br><span class="line">  <span class="comment">//先建立MapStateDescriptor</span></span><br><span class="line">  <span class="comment">//MapStateDescriptor定义了状态的名称/Key和Value的类型</span></span><br><span class="line">  <span class="comment">//这里,MapStateDescriptor中,key是Void类型,value是Map&lt;Integer, Tuple2&lt;String,Integer&gt;&gt;类型</span></span><br><span class="line">  MapStateDescriptor&lt;Void, Map&lt;Integer, Tuple2&lt;String, Integer&gt;&gt;&gt; configDescriptor = <span class="keyword">new</span> MapStateDescriptor&lt;&gt;(<span class="string">&quot;config&quot;</span>,</span><br><span class="line">      Types.VOID,</span><br><span class="line">      Types.MAP(Types.INT, Types.TUPLE(Types.STRING, Types.INT))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//将配置流广播,形成BroadcastStream</span></span><br><span class="line">  BroadcastStream&lt;HashMap&lt;Integer, Tuple2&lt;String, Integer&gt;&gt;&gt; broadcastConfigStream = configStream.broadcast(configDescriptor);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//5.事件流和广播的配置流连接,形成BroadcastConnectedStream</span></span><br><span class="line">  BroadcastConnectedStream&lt;Tuple2&lt;String, Integer&gt;, HashMap&lt;Integer, Tuple2&lt;String, Integer&gt;&gt;&gt; connectedStream = eventStream.connect(broadcastConfigStream);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//6.对BroadcastConnectedStream应用process方法,根据配置(规则)处理事件</span></span><br><span class="line">  SingleOutputStreamOperator&lt;Tuple4&lt;String, Integer, String, Integer&gt;&gt; resultStream = connectedStream.process(<span class="keyword">new</span> CustomBroadcastProcessFunction());</span><br><span class="line"></span><br><span class="line">  <span class="comment">//7.输出结果</span></span><br><span class="line">  resultStream.print();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//8.生成JobGraph,并开始执行</span></span><br><span class="line">  env.execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义BroadcastProcessFunction</span></span><br><span class="line"><span class="comment"> * 当事件流中的用户ID在配置中出现时,才对该事件处理, 并在事件中补全用户的基础信息</span></span><br><span class="line"><span class="comment"> * Tuple2&lt;String, Integer&gt;:第一个流(事件流)的数据类型</span></span><br><span class="line"><span class="comment"> * HashMap&lt;Integer, Tuple2&lt;String, Integer&gt;&gt;:第二个流(配置流)的数据类型</span></span><br><span class="line"><span class="comment"> * Tuple4&lt;String, Integer, String, Integer&gt;:返回的数据类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomBroadcastProcessFunction</span> <span class="keyword">extends</span> <span class="title">BroadcastProcessFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;,</span></span><br><span class="line"><span class="class">    <span class="title">HashMap</span>&lt;<span class="title">Integer</span>, <span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt;,</span></span><br><span class="line"><span class="class">    <span class="title">Tuple4</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>, <span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//定义MapStateDescriptor</span></span><br><span class="line">  MapStateDescriptor&lt;Void, Map&lt;Integer, Tuple2&lt;String, Integer&gt;&gt;&gt; configDescriptor = <span class="keyword">new</span> MapStateDescriptor&lt;&gt;(<span class="string">&quot;config&quot;</span>,</span><br><span class="line">      Types.VOID,</span><br><span class="line">      Types.MAP(Types.INT, Types.TUPLE(Types.STRING, Types.INT))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 读取状态,并基于状态,处理事件流中的数据</span></span><br><span class="line"><span class="comment">   * 在这里,从上下文中获取状态,基于获取的状态,对事件流中的数据进行处理</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> value 事件流中的数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ctx   上下文</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> out   输出零条或多条数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(Tuple2&lt;String, Integer&gt; value, ReadOnlyContext ctx, Collector&lt;Tuple4&lt;String, Integer, String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//事件流中的用户ID</span></span><br><span class="line">    <span class="keyword">int</span> id = value.f1;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取状态</span></span><br><span class="line">    ReadOnlyBroadcastState&lt;Void, Map&lt;Integer, Tuple2&lt;String, Integer&gt;&gt;&gt; broadcastState = ctx.getBroadcastState(configDescriptor);</span><br><span class="line">    Map&lt;Integer, Tuple2&lt;String, Integer&gt;&gt; broadcastStateUserInfo = broadcastState.get(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置中有此用户,则在该事件中添加用户的name/age字段</span></span><br><span class="line">    <span class="comment">//配置中没有此用户,则丢弃</span></span><br><span class="line">    Tuple2&lt;String, Integer&gt; userInfo = broadcastStateUserInfo.get(id);</span><br><span class="line">    <span class="keyword">if</span> (userInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">      out.collect(<span class="keyword">new</span> Tuple4&lt;&gt;(value.f0, value.f1, userInfo.f0, userInfo.f1));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理广播流中的每一条数据,并更新状态</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> value 广播流中的数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ctx   上下文</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> out   输出零条或多条数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processBroadcastElement</span><span class="params">(HashMap&lt;Integer, Tuple2&lt;String, Integer&gt;&gt; value, Context ctx, Collector&lt;Tuple4&lt;String, Integer, String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//获取状态</span></span><br><span class="line">    BroadcastState&lt;Void, Map&lt;Integer, Tuple2&lt;String, Integer&gt;&gt;&gt; broadcastState = ctx.getBroadcastState(configDescriptor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清空状态</span></span><br><span class="line">    broadcastState.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新状态</span></span><br><span class="line">    broadcastState.put(<span class="keyword">null</span>, value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义Mysql Source,每隔 secondInterval 秒从Mysql中获取一次配置</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlSource</span> <span class="keyword">extends</span> <span class="title">RichSourceFunction</span>&lt;<span class="title">HashMap</span>&lt;<span class="title">Integer</span>, <span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> secondInterval;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isRunning = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Connection connection;</span><br><span class="line">  <span class="keyword">private</span> PreparedStatement preparedStatement;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//开始时,在open()方法中建立连接</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.open(parameters);</span><br><span class="line">    ParameterTool parameterTool = (ParameterTool) getRuntimeContext().getExecutionConfig().getGlobalJobParameters();</span><br><span class="line">    secondInterval = parameterTool.getInt(Constants.SECOND_INTERVAL, Constants.SECOND_INTERVAL_DEFAULT);</span><br><span class="line">    String host = parameterTool.get(Constants.MYSQL_HOST);</span><br><span class="line">    <span class="keyword">int</span> port = parameterTool.getInt(Constants.MYSQL_PORT);</span><br><span class="line">    String database = parameterTool.get(Constants.MYSQL_DATABASE);</span><br><span class="line">    String user = parameterTool.get(Constants.MYSQL_USER, Constants.MYSQL_USER_DEFAULT);</span><br><span class="line">    String password = parameterTool.get(Constants.MYSQL_PASSWORD, Constants.MYSQL_PASSWORD_DEFAULT);</span><br><span class="line">    String jdbcUrl = Constants.MYSQL_URL_PREFIX + String.format(<span class="string">&quot;%s:%s/%s&quot;</span>, host, port, database);</span><br><span class="line">    Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">    connection = DriverManager.getConnection(jdbcUrl + <span class="string">&quot;?useUnicode=true&amp;characterEncoding=UTF-8&quot;</span>, user, password);</span><br><span class="line">    String sql = <span class="string">&quot;select id,name,age from t2&quot;</span>;</span><br><span class="line">    preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//执行完,调用close()方法关系连接,释放资源</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">      connection.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preparedStatement != <span class="keyword">null</span>) &#123;</span><br><span class="line">      preparedStatement.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//调用run()方法获取数据</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext&lt;HashMap&lt;Integer, Tuple2&lt;String, Integer&gt;&gt;&gt; ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">        HashMap&lt;Integer, Tuple2&lt;String, Integer&gt;&gt; output = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        ResultSet resultSet = preparedStatement.executeQuery();</span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">          <span class="keyword">int</span> id = resultSet.getInt(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">          String name = resultSet.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">          <span class="keyword">int</span> age = resultSet.getInt(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">          output.put(id, <span class="keyword">new</span> Tuple2&lt;&gt;(name, age));</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.collect(output);</span><br><span class="line">        <span class="comment">//每隔多少秒执行一次查询</span></span><br><span class="line">        TimeUnit.SECONDS.sleep(secondInterval);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(<span class="string">&quot;从Mysql获取配置异常.&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//取消时,会调用此方法</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    isRunning = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1&gt; (1661496308305,3,tom3,133)<br>8&gt; (1661496312409,1,tom1,111)<br>7&gt; (1661496313425,2,tom2,12)<br>1&gt; (1661496316434,3,tom3,133)<br>8&gt; (1661496320442,2,tom2,12)<br>1&gt; <strong>(1661496322445,3,tom3,13)</strong><br>7&gt; <strong>(1661496322445,2,tom2,122)</strong><br>8&gt; (1661496328450,1,tom1,111)<br>7&gt; (1661496334455,2,tom2,122)</p>
<h2 id="redis-sink"><a href="#redis-sink" class="headerlink" title="redis sink"></a>redis sink</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.bahir<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-redis_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">DataStream&lt;String&gt; source = env.fromElements(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>);</span><br><span class="line"></span><br><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; counts = source.flatMap(<span class="keyword">new</span> FlatMapFunction&lt;String, Tuple2&lt;String, Integer&gt;&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String value, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(value, <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">FlinkJedisPoolConfig conf = <span class="keyword">new</span> FlinkJedisPoolConfig.Builder().setHost(<span class="string">&quot;oceanbase004&quot;</span>).setPort(<span class="number">6379</span>).build();</span><br><span class="line">counts.addSink(<span class="keyword">new</span> RedisSink&lt;&gt;(conf, <span class="keyword">new</span> RedisMapper&lt;Tuple2&lt;String, Integer&gt;&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RedisCommandDescription <span class="title">getCommandDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RedisCommandDescription(RedisCommand.SET, (String) <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getKeyFromData</span><span class="params">(Tuple2&lt;String, Integer&gt; data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;xxx:&quot;</span> + data.f0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getValueFromData</span><span class="params">(Tuple2&lt;String, Integer&gt; data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> data.f1.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行job</span></span><br><span class="line">env.execute(<span class="string">&quot;redisJob&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="mysql-sink"><a href="#mysql-sink" class="headerlink" title="mysql sink"></a>mysql sink</h2><p><code>counts.addSink(new MysqlSink());</code><br>其它代码同上.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysqlSink</span> <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Connection connection;</span><br><span class="line">  <span class="keyword">private</span> PreparedStatement preparedStatement;</span><br><span class="line">  String username = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">  String password = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">  String drivername = <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line">  String dburl = <span class="string">&quot;jdbc:mysql://oceanbase004:3306/xxx&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Tuple2&lt;String, Integer&gt; value, Context context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class.forName(drivername);</span><br><span class="line">    connection = DriverManager.getConnection(dburl, username, password);</span><br><span class="line">    String sql = <span class="string">&quot;insert into t1(num,price) values(?,?)&quot;</span>;</span><br><span class="line">    preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">    preparedStatement.setString(<span class="number">1</span>, value.f0);</span><br><span class="line">    preparedStatement.setInt(<span class="number">2</span>, value.f1);</span><br><span class="line">    preparedStatement.executeUpdate();</span><br><span class="line">    <span class="keyword">if</span> (preparedStatement != <span class="keyword">null</span>) &#123;</span><br><span class="line">      preparedStatement.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">      connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="clickhouse-sink"><a href="#clickhouse-sink" class="headerlink" title="clickhouse sink"></a>clickhouse sink</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.clickhouse<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>clickhouse-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ru.ivi.opensource<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clickhouse-sink<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomClickHouseSink</span> <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>&lt;<span class="title">LogBean</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> BalancedClickhouseDataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line">  String sql;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CustomClickHouseSink</span><span class="params">(String sql)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sql = sql;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.open(parameters);</span><br><span class="line">    ParameterTool parameterTool = (ParameterTool) getRuntimeContext().getExecutionConfig().getGlobalJobParameters();</span><br><span class="line">    String host = parameterTool.get(Constants.CLICKHOUSE_HOST);</span><br><span class="line">    <span class="keyword">int</span> port = parameterTool.getInt(Constants.CLICKHOUSE_PORT);</span><br><span class="line">    String database = parameterTool.get(Constants.CLICKHOUSE_DATABASE);</span><br><span class="line">    String user = parameterTool.get(Constants.CLICKHOUSE_USER, Constants.CLICKHOUSE_USER_DEFAULT);</span><br><span class="line">    String password = parameterTool.get(Constants.CLICKHOUSE_PASSWORD, Constants.CLICKHOUSE_PASSWORD_DEFAULT);</span><br><span class="line"></span><br><span class="line">    String jdbcUrl = Constants.CLICKHOUSE_URL_PREFIX + String.format(<span class="string">&quot;%s:%s/%s&quot;</span>, host, port, database);</span><br><span class="line">    ClickHouseProperties properties = <span class="keyword">new</span> ClickHouseProperties().withCredentials(user, password);</span><br><span class="line">    dataSource = <span class="keyword">new</span> BalancedClickhouseDataSource(jdbcUrl, properties);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(LogBean logBean, Context context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ClickHouseConnectionImpl connection = (ClickHouseConnectionImpl) dataSource.getConnection();</span><br><span class="line">    PreparedStatement preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">    <span class="keyword">if</span> (logBean.getCode() == <span class="number">100</span>) &#123;</span><br><span class="line">      preparedStatement.setString(<span class="number">1</span>, logBean.getFamilyId());</span><br><span class="line">      preparedStatement.setString(<span class="number">2</span>, logBean.getAccid());</span><br><span class="line">      preparedStatement.setString(<span class="number">3</span>, logBean.getType());</span><br><span class="line">      preparedStatement.setInt(<span class="number">4</span>, logBean.getIncr());</span><br><span class="line">      preparedStatement.setLong(<span class="number">5</span>, logBean.getLogTs());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    preparedStatement.addBatch();</span><br><span class="line">    preparedStatement.executeBatch();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="hbase"><a href="#hbase" class="headerlink" title="hbase"></a>hbase</h2><h3 id="sink"><a href="#sink" class="headerlink" title="sink"></a>sink</h3><p>Flink上将数据写入HBase有两种方式:<br>继承RichSinkFunction重写父类方法(flink streaming)<br>实现OutputFormat接口(flink streaming和flink dataSet)</p>
<h4 id="继承RichSinkFunction"><a href="#继承RichSinkFunction" class="headerlink" title="继承RichSinkFunction"></a>继承RichSinkFunction</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.utils.ParameterTool;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.sink.RichSinkFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.TableName;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBaseWriter</span> <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(HBaseWriter.class);</span><br><span class="line">  <span class="keyword">private</span> Connection connection;</span><br><span class="line">  <span class="keyword">private</span> BufferedMutator bufferedMutator;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ParameterTool parameterTool = (ParameterTool) getRuntimeContext().getExecutionConfig().getGlobalJobParameters();</span><br><span class="line">    org.apache.hadoop.conf.Configuration config = HBaseConfiguration.create();</span><br><span class="line">    config.set(<span class="string">&quot;hbase.zookeeper.quorum&quot;</span>, parameterTool.get(Constants.HBASE_ZOOKEEPER));</span><br><span class="line">    connection = ConnectionFactory.createConnection(config);</span><br><span class="line">    String tableName = parameterTool.get(Constants.HBASE_TABLE);</span><br><span class="line">    BufferedMutatorParams bufferedMutatorParams = <span class="keyword">new</span> BufferedMutatorParams(TableName.valueOf(tableName));</span><br><span class="line">    <span class="comment">//设置缓存1m,当达到1m时数据会自动刷到hbase</span></span><br><span class="line">    bufferedMutatorParams.writeBufferSize(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    bufferedMutator = connection.getBufferedMutator(bufferedMutatorParams);</span><br><span class="line">    count = <span class="number">0L</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Tuple2&lt;String, String&gt; value, Context context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Put put = <span class="keyword">new</span> Put(Bytes.toBytes(value.f0));</span><br><span class="line">    put.addColumn(Constants.FAMILY, Bytes.toBytes(<span class="string">&quot;name&quot;</span>), Bytes.toBytes(value.f1));</span><br><span class="line">    bufferedMutator.mutate(put);</span><br><span class="line">    <span class="keyword">if</span> (count &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">      bufferedMutator.flush();</span><br><span class="line">      logger.info(<span class="string">&quot;buffer is flush, count:&#123;&#125;&quot;</span>, count);</span><br><span class="line">      count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">    logger.info(<span class="string">&quot;count:&#123;&#125;&quot;</span>, count);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bufferedMutator.flush();</span><br><span class="line">        connection.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">ParameterTool parameterTool = ParameterTool.fromPropertiesFile(TestApp3.class.getResourceAsStream(<span class="string">&quot;/application.properties&quot;</span>));</span><br><span class="line">env.getConfig().setGlobalJobParameters(parameterTool);</span><br><span class="line"></span><br><span class="line">DataStream&lt;String&gt; source = getSourceDataStream(env, parameterTool);</span><br><span class="line">DataStream&lt;Tuple2&lt;String, String&gt;&gt; map = source.map(<span class="keyword">new</span> RichMapFunction&lt;String, Tuple2&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Tuple2&lt;String, String&gt; <span class="title">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String[] arr = value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">    String rowkey = StringUtils.reverse(arr[<span class="number">0</span>]);</span><br><span class="line">    String record = arr[<span class="number">1</span>];</span><br><span class="line">    logger.info(<span class="string">&quot;map转换-&#123;&#125;-&#123;&#125;-&#123;&#125;&quot;</span>, <span class="string">&quot;xxx-map&quot;</span>, rowkey, record);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(rowkey, record);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">DataStream&lt;Tuple2&lt;String, String&gt;&gt; filter = map.filter(<span class="keyword">new</span> RichFilterFunction&lt;Tuple2&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(Tuple2&lt;String, String&gt; value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(value.f0) || StringUtils.isEmpty(value.f1)) &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;value is null.&#123;&#125;-&#123;&#125;&quot;</span>, value.f0, value.f1);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">filter.addSink(<span class="keyword">new</span> HBaseWriter());</span><br><span class="line"><span class="comment">//运行job</span></span><br><span class="line">env.execute(<span class="string">&quot;xxx&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="实现OutputFormat接口"><a href="#实现OutputFormat接口" class="headerlink" title="实现OutputFormat接口"></a>实现OutputFormat接口</h4><h4 id="HBaseSinkFunction-HBaseMutationConverter"><a href="#HBaseSinkFunction-HBaseMutationConverter" class="headerlink" title="HBaseSinkFunction/HBaseMutationConverter"></a>HBaseSinkFunction/HBaseMutationConverter</h4><p>高版本使用.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-hbase-base_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.14.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt; dataStream = ...</span><br><span class="line"></span><br><span class="line">HBaseMutationConverter&lt;Tuple2&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt; mutationConverter = <span class="keyword">new</span> HBaseMutationConverter&lt;Tuple2&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt;() &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Mutation <span class="title">convertToMutation</span><span class="params">(Tuple2&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt; record)</span> </span>&#123;</span><br><span class="line">    Put put = <span class="keyword">new</span> Put(record.f0);</span><br><span class="line">    put.addColumn(Bytes.toBytes(<span class="string">&quot;f1&quot;</span>), Bytes.toBytes(<span class="string">&quot;str&quot;</span>), record.f1);</span><br><span class="line">    <span class="keyword">return</span> put;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">HBaseSinkFunction&lt;Tuple2&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt; hBaseSink = <span class="keyword">new</span> HBaseSinkFunction&lt;Tuple2&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt;(</span><br><span class="line">    <span class="string">&quot;t2&quot;</span>, HBaseConfigurationUtil.createHBaseConf(), mutationConverter, <span class="number">10000</span>, <span class="number">2</span>, <span class="number">1000</span>);</span><br><span class="line">dataStream.addSink(hBaseSink);</span><br></pre></td></tr></table></figure>

<h4 id="HBaseDynamicTableSink-HBaseUpsertTableSink"><a href="#HBaseDynamicTableSink-HBaseUpsertTableSink" class="headerlink" title="HBaseDynamicTableSink/HBaseUpsertTableSink"></a>HBaseDynamicTableSink/HBaseUpsertTableSink</h4><p>高版本使用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream = ...</span><br><span class="line"></span><br><span class="line">HBaseTableSchema schema = <span class="keyword">new</span> HBaseTableSchema();</span><br><span class="line">schema.setRowKey(<span class="string">&quot;rowkey&quot;</span>, <span class="keyword">byte</span>[].class);</span><br><span class="line">schema.addColumn(<span class="string">&quot;f1&quot;</span>, <span class="string">&quot;str&quot;</span>, <span class="keyword">byte</span>[].class);</span><br><span class="line"></span><br><span class="line">HBaseUpsertTableSink sink = <span class="keyword">new</span> HBaseUpsertTableSink(<span class="string">&quot;t3&quot;</span>, schema, HBaseConfigurationUtil.createHBaseConf(),</span><br><span class="line">    HBaseWriteOptions.builder().setBufferFlushIntervalMillis(<span class="number">1000</span>).build());</span><br><span class="line">sink.consumeDataStream(dataStream);</span><br></pre></td></tr></table></figure>

<h3 id="source"><a href="#source" class="headerlink" title="source"></a>source</h3><p>Flink上读取HBase数据有两种方式:</p>
<ol>
<li>继承RichSourceFunction重写父类方法(flink streaming)</li>
<li>实现自定义TableInputFormat接口(flink streaming和flink dataSet)</li>
</ol>
<h4 id="继承RichSourceFunction"><a href="#继承RichSourceFunction" class="headerlink" title="继承RichSourceFunction"></a>继承RichSourceFunction</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.14.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-cli<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-cli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.utils.ParameterTool;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.RichSourceFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.TableName;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBaseReader</span> <span class="keyword">extends</span> <span class="title">RichSourceFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(HBaseReader.class);</span><br><span class="line">  <span class="keyword">private</span> Connection connection;</span><br><span class="line">  <span class="keyword">private</span> Table table;</span><br><span class="line">  <span class="keyword">private</span> Scan scan;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在open方法使用HBase的客户端连接</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ParameterTool parameterTool = (ParameterTool) getRuntimeContext().getExecutionConfig().getGlobalJobParameters();</span><br><span class="line">    org.apache.hadoop.conf.Configuration config = HBaseConfiguration.create();</span><br><span class="line">    config.set(<span class="string">&quot;hbase.zookeeper.quorum&quot;</span>, parameterTool.get(Constants.HBASE_ZOOKEEPER));</span><br><span class="line">    connection = ConnectionFactory.createConnection(config);</span><br><span class="line">    table = connection.getTable(TableName.valueOf(parameterTool.get(Constants.HBASE_TABLE)));</span><br><span class="line">    scan = <span class="keyword">new</span> Scan();</span><br><span class="line">    scan.setStartRow(Bytes.toBytes(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">    scan.setStopRow(Bytes.toBytes(<span class="string">&quot;z&quot;</span>));</span><br><span class="line">    scan.addFamily(Constants.FAMILY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext&lt;Tuple2&lt;String, String&gt;&gt; ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ResultScanner results = table.getScanner(scan);</span><br><span class="line">    <span class="keyword">for</span> (Result result : results) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">        String rowkey = Bytes.toString(result.getRow());</span><br><span class="line">        <span class="keyword">if</span> (result.getValue(Constants.FAMILY, Constants.IS_CB) != <span class="keyword">null</span>) &#123;</span><br><span class="line">          String iscb = Bytes.toString(result.getValue(Constants.FAMILY, Constants.IS_CB));</span><br><span class="line">          logger.info(<span class="string">&quot;rowkey:&#123;&#125;, iscb:&#123;&#125;&quot;</span>, rowkey, iscb);</span><br><span class="line">          ctx.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(rowkey, iscb));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    results.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (table != <span class="keyword">null</span>) &#123;</span><br><span class="line">        table.close();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">        connection.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">ParameterTool parameterTool = ParameterTool.fromPropertiesFile(TestApp2.class.getResourceAsStream(<span class="string">&quot;/application.properties&quot;</span>));</span><br><span class="line">env.getConfig().setGlobalJobParameters(parameterTool);</span><br><span class="line"></span><br><span class="line">DataStream&lt;Tuple2&lt;String, String&gt;&gt; source = env.addSource(<span class="keyword">new</span> HBaseReader());</span><br><span class="line">source.flatMap(<span class="keyword">new</span> FlatMapFunction&lt;Tuple2&lt;String, String&gt;, String&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(Tuple2&lt;String, String&gt; value, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String record = value.f0 + <span class="string">&quot;\t&quot;</span> + value.f1;</span><br><span class="line">    logger.info(<span class="string">&quot;record:&#123;&#125;&quot;</span>, record);</span><br><span class="line">    out.collect(record);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).print();</span><br><span class="line"></span><br><span class="line">env.execute(<span class="string">&quot;xxx&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="实现自定义TableInputFormat接口"><a href="#实现自定义TableInputFormat接口" class="headerlink" title="实现自定义TableInputFormat接口"></a>实现自定义TableInputFormat接口</h4><h4 id="HBaseTableSource"><a href="#HBaseTableSource" class="headerlink" title="HBaseTableSource"></a>HBaseTableSource</h4><p>高版本使用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env, tableSettings);</span><br><span class="line"></span><br><span class="line">HBaseTableSource hBaseSource = <span class="keyword">new</span> HBaseTableSource(HBaseConfigurationUtil.createHBaseConf(), <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">hBaseSource.setRowKey(<span class="string">&quot;rowkey&quot;</span>, <span class="keyword">byte</span>[].class);</span><br><span class="line">hBaseSource.addColumn(<span class="string">&quot;f1&quot;</span>, <span class="string">&quot;str&quot;</span>, <span class="keyword">byte</span>[].class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Direct conversion to DataStream&lt;Row&gt;</span></span><br><span class="line">DataStream&lt;Row&gt; rowStream = hBaseSource.getDataStream(env);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Table API</span></span><br><span class="line">((TableEnvironmentInternal) tableEnv).registerTableSourceInternal(<span class="string">&quot;t1&quot;</span>, hBaseSource);</span><br><span class="line">Table table = tableEnv.sqlQuery(<span class="string">&quot;SELECT t.rowkey, t.f1.str FROM t1 t&quot;</span>);</span><br><span class="line">DataStream&lt;Tuple2&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt; resultStream = tableEnv.toAppendStream(table, TypeInformation.of(<span class="keyword">new</span> TypeHint&lt;Tuple2&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt;()&#123;&#125;));</span><br></pre></td></tr></table></figure>

<h2 id="flink双流join"><a href="#flink双流join" class="headerlink" title="flink双流join"></a>flink双流join</h2><h3 id="join实现机制"><a href="#join实现机制" class="headerlink" title="join实现机制"></a>join实现机制</h3><p>Flink双流JOIN主要分为两大类:</p>
<ol>
<li>基于原生State的Connect算子操作.</li>
<li>基于窗口的JOIN操作.<br>其中基于窗口的JOIN可细分为window join和interval join两种.</li>
</ol>
<blockquote>
<p>实现原理</p>
<blockquote>
<p>底层原理依赖Flink的State状态存储,通过将数据存储到State中进行关联join,最终输出结果.</p>
</blockquote>
</blockquote>
<h3 id="Window-Join"><a href="#Window-Join" class="headerlink" title="Window Join"></a>Window Join</h3><p>利用Flink的窗口机制实现双流join.<br>将两条实时流中元素分配到同一个时间窗口中完成Join.<br>底层原理:两条实时流数据缓存在Window State中,当窗口触发计算时,执行join操作.</p>
<img src="/images/flgl89.png" style="margin-left: 0px; padding-bottom: 10px;">

<h4 id="join"><a href="#join" class="headerlink" title="join"></a>join</h4><p>两条流数据按照关联主键在(滚动/滑动/会话)窗口内进行inner join,底层基于State存储,并支持处理时间和事件时间两种时间特征.<br>inner join指的是仅保留两条流关联上的数据.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; one = ...;</span><br><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; two = ...;</span><br><span class="line">DataStream&lt;T&gt; result = one.join(two)</span><br><span class="line">.where(<span class="keyword">new</span> MyFirstKeySelector())</span><br><span class="line">.equalTo(<span class="keyword">new</span> MyFirstKeySelector())</span><br><span class="line">.window(TumblingEventTimeWindows.of(Time.of(<span class="number">5</span>, TimeUnit.SECONDS)))</span><br><span class="line">.apply(<span class="keyword">new</span> MyJoinFunction());</span><br></pre></td></tr></table></figure>

<blockquote>
<p>windows窗口 + state存储 + 双层for循环执行join()<br>源码如下:</p>
</blockquote>
<img src="/images/flgl90.png" style="margin-left: 0px; padding-bottom: 10px;">

<img src="/images/flgl91.png" style="margin-left: 0px; padding-bottom: 10px;">

<blockquote>
<p>定义60秒的滚动窗口,将订单流和订单明细流通过order_id关联</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A流调用join(b流)算子</span></span><br><span class="line"><span class="comment">//关联关系定义:where/equalTo为A流关联键,都是订单id</span></span><br><span class="line"><span class="comment">//定义window窗口(60s间隔)</span></span><br><span class="line"><span class="comment">//apply方法定义逻辑输出</span></span><br><span class="line">orderStream.join(orderDetailStream)</span><br><span class="line">  .where(<span class="keyword">new</span> KeySelector&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .equalTo(<span class="keyword">new</span> KeySelector&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .window(TumblingEventTimeWindows.of(Time.seconds(<span class="number">60</span>)))</span><br><span class="line">  .allowedLateness(Time.seconds(<span class="number">2</span>))</span><br><span class="line">  .apply(<span class="keyword">new</span> JoinFunction&lt;String, String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">join</span><span class="params">(String first, String second)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> first + <span class="string">&quot;=========&quot;</span> + second;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).print();</span><br></pre></td></tr></table></figure>

<h4 id="coGroup"><a href="#coGroup" class="headerlink" title="coGroup"></a>coGroup</h4><p>基于window窗口机制,比Join算子更加灵活,可以按照用户指定的逻辑匹配左流或右流数据并输出.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; one = ...;</span><br><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; two = ...;</span><br><span class="line">DataStream&lt;T&gt; result = one.coGroup(two)</span><br><span class="line">.where(<span class="keyword">new</span> MyFirstKeySelector())</span><br><span class="line">.equalTo(<span class="keyword">new</span> MyFirstKeySelector())</span><br><span class="line">.window(TumblingEventTimeWindows.of(Time.of(<span class="number">5</span>, TimeUnit.SECONDS)))</span><br><span class="line">.apply(<span class="keyword">new</span> MyCoGroupFunction());</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">orderDetailStream.coGroup(orderStream)</span><br><span class="line">  .where(<span class="keyword">new</span> KeySelector&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .equalTo(<span class="keyword">new</span> KeySelector&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .window(TumblingEventTimeWindows.of(Time.seconds(<span class="number">60</span>)))</span><br><span class="line">  .allowedLateness(Time.seconds(<span class="number">2</span>))</span><br><span class="line">  .apply(<span class="keyword">new</span> CoGroupFunction&lt;String, String, Tuple2&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">coGroup</span><span class="params">(Iterable&lt;String&gt; first, Iterable&lt;String&gt; second, Collector&lt;Tuple2&lt;String, String&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (String orderDetail : first) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (String order : second) &#123;</span><br><span class="line">          <span class="comment">// 右流中有对应的记录</span></span><br><span class="line">          out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(orderDetail, order));</span><br><span class="line">          flag = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">          <span class="comment">// 右流中没有对应的记录</span></span><br><span class="line">          out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(orderDetail, <span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).print();</span><br></pre></td></tr></table></figure>

<h3 id="Interval-Join"><a href="#Interval-Join" class="headerlink" title="Interval Join"></a>Interval Join</h3><p>根据右流相对左流偏移的时间区间(interval)作为关联窗口,在偏移区间窗口中完成join操作.</p>
<img src="/images/flgl92.png" style="margin-left: 0px; padding-bottom: 10px;">

<p><code>stream2.time ∈ (stream1.time +low, stream1.time +high)</code></p>
<p>满足数据流stream2在数据流stream1的interval(low, high)偏移区间内关联join.<br>interval越大,关联上的数据就越多,超出interval的数据不再关联.<br>实现原理:interval join也是利用Flink的state存储数据,不过此时存在state失效机制ttl,触发数据清理操作.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">orderStream.keyBy(<span class="keyword">new</span> KeySelector&lt;String, String&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).intervalJoin(orderDetailStream.keyBy(<span class="keyword">new</span> KeySelector&lt;String, String&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;))</span><br><span class="line">.between(Time.milliseconds(-<span class="number">30</span>), Time.milliseconds(<span class="number">30</span>))</span><br><span class="line">.process(<span class="keyword">new</span> ProcessJoinFunction&lt;String, String, Tuple2&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(String left, String right, Context ctx, Collector&lt;Tuple2&lt;String, String&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(left, right));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).print();</span><br></pre></td></tr></table></figure>

<p>订单流在流入程序后,等候(low,high)时间间隔内的订单明细流数据进行join,否则继续处理下一个流.<br>从代码中我们发现,interval join需要在两个KeyedStream之上操作,即keyBy(),并在between()方法中指定偏移区间的上下界.<br>需要注意的是interval join实现的也是inner join,且目前只支持事件时间.</p>
<h3 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h3><p>在Flink中可以使用Window join或者Interval Join实现双流join,不过使用join只能实现内连接.<br>如果要实现左右连接或者外连接,则可以通过connect算子来实现.</p>
<p>两个不同来源的数据流进行连接,实现数据匹配.<br>可以连接两个保持他们类型的数据流,两个数据流被connect之后,只是被放在了一个同一个流中,内部依然保持各自的数据和形式不发生任何变化,两个流相互独立.<br><code>[DataStream1, DataStream2] -&gt; ConnectedStreams[1,2]</code></p>
<blockquote>
<p>现有订单数据及支付数据如下方说明,基于数据时间实现订单及支付数据的关联,超时或者缺失则由侧输出流输出.</p>
</blockquote>
<p>//订单数据,首列为订单id,付款成功则类型为pay(第二列),且生成支付id(第三列),最后列为时间<br>34729,create,35jue34we,1558430842<br>34730,create,,1558430843<br>34729,pay,sd76f87d6,1558430844<br>34730,pay,3hu3k2432,1558430845<br>34731,pay,,1558430849</p>
<p>//支付数据,付款成功后生成,对于支付id/支付渠道/时间<br>sd76f87d6,wechat,1558430847<br>3hu3k2432,alipay,1558430848</p>
<p>//输出结果,限定时间内到达数据实现关联以Tuple2输出,否则侧输出流输出<br>(OrderEvent(orderId=34729, eventType=pay, txId=sd76f87d6, eventTime=1558430844),TxEvent(txId=sd76f87d6, payChannel=wechat, eventTime=1558430847))<br>(OrderEvent(orderId=34730, eventType=pay, txId=3hu3k2432, eventTime=1558430845),TxEvent(txId=3hu3k2432, payChannel=alipay, eventTime=1558430848))<br>No Receipt&gt; 35jue34we 只有下单没有到账数据</p>
<blockquote>
<p>步骤</p>
</blockquote>
<ol>
<li>按支付id进行keyby,使相同id数据进入相同并行度处理.</li>
<li>由于使用到定时器,故使用process算子(支持定时器)分别对两条流进行处理.</li>
<li>process中使用状态编程(ValueState),对先到数据存入状态,并建立定时器,另外一条流在限定时间内到达则输出并删除定时器,否则触发定时器走侧输出流输出.</li>
<li>在定时器中,对未到数据均输出到侧输出流则实现全外连接,对A到了B未到输出及A未到B到了不做输出则实现左连接,反之则是右连接效果.</li>
</ol>
<p>在connect中,无非对两条流进行单独的处理,在A流中处理B流未到时如何输出,在B流中处理A流未到时如何输入,建立定时器,能实现另一条流延迟到达的处理,如左连接、右连接或全外连接,如使用join算子,则只能实现内连接.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">ParameterTool parameterTool = ParameterTool.fromPropertiesFile(TestApp.class.getResourceAsStream(<span class="string">&quot;/application.properties&quot;</span>));</span><br><span class="line">env.getConfig().setGlobalJobParameters(parameterTool);</span><br><span class="line"></span><br><span class="line">WatermarkStrategy&lt;String&gt; orderWms = WatermarkStrategy</span><br><span class="line">    .&lt;String&gt;forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">    .withIdleness(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .withTimestampAssigner(<span class="keyword">new</span> SerializableTimestampAssigner&lt;String&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(String orderEvent, <span class="keyword">long</span> recordTimestamp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Long.parseLong(orderEvent.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)[<span class="number">3</span>]) * <span class="number">1000</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">WatermarkStrategy&lt;String&gt; txWms = WatermarkStrategy</span><br><span class="line">    .&lt;String&gt;forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">    .withIdleness(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .withTimestampAssigner(<span class="keyword">new</span> SerializableTimestampAssigner&lt;String&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(String txEvent, <span class="keyword">long</span> recordTimestamp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Long.parseLong(txEvent.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)[<span class="number">2</span>]) * <span class="number">1000</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">String orderTopic = parameterTool.get(Constants.KAFKA_TOPICS);</span><br><span class="line">String txTopic = parameterTool.get(Constants.KAFKA_TOPICS2);</span><br><span class="line">SingleOutputStreamOperator&lt;OrderEvent&gt; orderStream = getSourceDataStream(env, parameterTool, orderWms, orderTopic, <span class="string">&quot;order-source&quot;</span>)</span><br><span class="line">    .map(<span class="keyword">new</span> MapFunction&lt;String, OrderEvent&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> OrderEvent <span class="title">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String[] arr = value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OrderEvent(arr[<span class="number">0</span>], arr[<span class="number">1</span>], arr[<span class="number">2</span>], arr[<span class="number">3</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;TxEvent&gt; txStream = getSourceDataStream(env, parameterTool, txWms, txTopic, <span class="string">&quot;tx-source&quot;</span>)</span><br><span class="line">    .map(<span class="keyword">new</span> MapFunction&lt;String, TxEvent&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> TxEvent <span class="title">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String[] arr = value.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TxEvent(arr[<span class="number">0</span>], arr[<span class="number">1</span>], arr[<span class="number">2</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;Tuple2&lt;OrderEvent, TxEvent&gt;&gt; processStream = orderStream</span><br><span class="line">    .connect(txStream)</span><br><span class="line">    .keyBy(<span class="string">&quot;payId&quot;</span>, <span class="string">&quot;payId&quot;</span>)</span><br><span class="line">    .process(<span class="keyword">new</span> OrderProcessFunc());</span><br><span class="line"></span><br><span class="line">processStream.print().name(<span class="string">&quot;==========正常流输出&quot;</span>);</span><br><span class="line">processStream.getSideOutput(<span class="keyword">new</span> OutputTag&lt;String&gt;(<span class="string">&quot;left-join&quot;</span>) &#123;&#125;).print().name(<span class="string">&quot;==========只有下单没有到账数据&quot;</span>);</span><br><span class="line">processStream.getSideOutput(<span class="keyword">new</span> OutputTag&lt;String&gt;(<span class="string">&quot;right-join&quot;</span>) &#123;&#125;).print().name(<span class="string">&quot;==========只有到账无下单数据&quot;</span>);</span><br><span class="line">env.execute(<span class="string">&quot;xxx&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DataStream&lt;String&gt; <span class="title">getSourceDataStream</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    StreamExecutionEnvironment env, ParameterTool parameterTool,</span></span></span><br><span class="line"><span class="function"><span class="params">    WatermarkStrategy&lt;String&gt; watermarkStrategy, String topic, String flag)</span> </span>&#123;</span><br><span class="line">  String bootStrapServers = parameterTool.get(Constants.KAFKA_CONSUMER_BOOTSTRAP_SERVERS);</span><br><span class="line">  String groupId = parameterTool.get(Constants.KAFKA_CONSUMER_GROUP_ID);</span><br><span class="line"></span><br><span class="line">  KafkaSourceBuilder&lt;String&gt; kafkaSourceBuilder = KafkaSource.builder();</span><br><span class="line">  kafkaSourceBuilder.setTopics(Arrays.asList(topic.split(<span class="string">&quot;,&quot;</span>)));</span><br><span class="line">  kafkaSourceBuilder.setBootstrapServers(bootStrapServers);</span><br><span class="line">  kafkaSourceBuilder.setGroupId(groupId);</span><br><span class="line">  kafkaSourceBuilder.setStartingOffsets(OffsetsInitializer.committedOffsets(OffsetResetStrategy.LATEST));</span><br><span class="line">  kafkaSourceBuilder.setValueOnlyDeserializer(<span class="keyword">new</span> SimpleStringSchema());</span><br><span class="line">  KafkaSource&lt;String&gt; kafkaSource = kafkaSourceBuilder.build();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> env.fromSource(kafkaSource, watermarkStrategy, flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderProcessFunc</span> <span class="keyword">extends</span> <span class="title">KeyedCoProcessFunction</span>&lt;<span class="title">String</span>, <span class="title">OrderEvent</span>, <span class="title">TxEvent</span>, <span class="title">Tuple2</span>&lt;<span class="title">OrderEvent</span>, <span class="title">TxEvent</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(OrderProcessFunc.class);</span><br><span class="line">  <span class="keyword">private</span> ValueState&lt;OrderEvent&gt; orderState;</span><br><span class="line">  <span class="keyword">private</span> ValueState&lt;TxEvent&gt; txState;</span><br><span class="line">  <span class="keyword">private</span> ValueState&lt;Long&gt; timeState;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    logger.info(<span class="string">&quot;初始化状态Value&quot;</span>);</span><br><span class="line">    orderState = getRuntimeContext().getState(</span><br><span class="line">        <span class="keyword">new</span> ValueStateDescriptor&lt;&gt;(<span class="string">&quot;order-state&quot;</span>, OrderEvent.class)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    txState = getRuntimeContext().getState(</span><br><span class="line">        <span class="keyword">new</span> ValueStateDescriptor&lt;&gt;(<span class="string">&quot;tx-state&quot;</span>, TxEvent.class)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    timeState = getRuntimeContext().getState(</span><br><span class="line">        <span class="keyword">new</span> ValueStateDescriptor&lt;&gt;(<span class="string">&quot;time-state&quot;</span>, Types.LONG)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为每个进入的数据流保存state状态并创建定时器.</span></span><br><span class="line"><span class="comment">   * 在时间窗口内另一个流达到时进行join并输出,完成后删除定时器.</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * 在订单流中,判断支付流是否有数据,没有则启用定时器10秒后触发输出到侧输出流</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement1</span><span class="params">(OrderEvent value, KeyedCoProcessFunction&lt;String, OrderEvent, TxEvent, Context ctx, Collector&lt;Tuple2&lt;OrderEvent, TxEvent&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (txState.value() == <span class="keyword">null</span>) &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;支付数据未到,先把订单数据放入状态&quot;</span>);</span><br><span class="line">      orderState.update(value);</span><br><span class="line">      logger.info(<span class="string">&quot;建立定时器,10秒后触发&quot;</span>);</span><br><span class="line">      <span class="keyword">long</span> ts = Long.parseLong(value.getDateline() + <span class="number">10</span>) * <span class="number">1000</span>;</span><br><span class="line">      ctx.timerService().registerEventTimeTimer(ts);</span><br><span class="line">      timeState.update(ts);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;支付数据已到,直接输出到主流&quot;</span>);</span><br><span class="line">      out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(value, txState.value()));</span><br><span class="line">      <span class="comment">//如支付流先到,支付流建立了的定时器,在这里删除</span></span><br><span class="line">      logger.info(<span class="string">&quot;删除定时器&quot;</span>);</span><br><span class="line">      ctx.timerService().deleteEventTimeTimer(timeState.value());</span><br><span class="line">      logger.info(<span class="string">&quot;清空状态,注意清空的是支付状态&quot;</span>);</span><br><span class="line">      txState.clear();</span><br><span class="line">      timeState.clear();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在支付流中,判断订单流是否有数据,没有则启用定时器5秒后触发输出到侧输出流</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement2</span><span class="params">(TxEvent value, KeyedCoProcessFunction&lt;String, OrderEvent, TxEvent, Context ctx, Collector&lt;Tuple2&lt;OrderEvent, TxEvent&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (orderState.value() == <span class="keyword">null</span>) &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;订单数据未到,先把支付数据放入状态&quot;</span>);</span><br><span class="line">      txState.update(value);</span><br><span class="line">      logger.info(<span class="string">&quot;建立定时器,5秒后再关联&quot;</span>);</span><br><span class="line">      <span class="keyword">long</span> ts = Long.parseLong(value.getDateline() + <span class="number">5</span>) * <span class="number">1000</span>;</span><br><span class="line">      ctx.timerService().registerEventTimeTimer(ts);</span><br><span class="line">      timeState.update(ts);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;订单数据已到,直接输出到主流&quot;</span>);</span><br><span class="line">      out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(orderState.value(), value));</span><br><span class="line">      <span class="comment">//删除定时器,如支付流先到,支付流建立了的定时器,在这里删除</span></span><br><span class="line">      ctx.timerService().deleteEventTimeTimer(timeState.value());</span><br><span class="line">      logger.info(<span class="string">&quot;清空状态,注意清空的是订单状态&quot;</span>);</span><br><span class="line">      orderState.clear();</span><br><span class="line">      timeState.clear();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 未及时达到的数据流触发定时器输出到侧输出流,</span></span><br><span class="line"><span class="comment">   * 左流先到而右流未到,则输出左流,</span></span><br><span class="line"><span class="comment">   * 反之输出右连流.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimer</span><span class="params">(<span class="keyword">long</span> timestamp, OnTimerContext ctx, Collector&lt;Tuple2&lt;OrderEvent, TxEvent&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    logger.info(<span class="string">&quot;实现左连接&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (orderState.value() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      ctx.output(<span class="keyword">new</span> OutputTag&lt;String&gt;(<span class="string">&quot;left-join&quot;</span>) &#123;&#125;, orderState.value().getPayId());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;实现右连接&quot;</span>);</span><br><span class="line">      ctx.output(<span class="keyword">new</span> OutputTag&lt;String&gt;(<span class="string">&quot;right-join&quot;</span>) &#123;&#125;, txState.value().getPayId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    orderState.clear();</span><br><span class="line">    txState.clear();</span><br><span class="line">    timeState.clear();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/flink/" rel="tag"># flink</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/08/26/hadoop%E5%B0%8F%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/" rel="prev" title="hadoop小文件处理">
                  <i class="fa fa-chevron-left"></i> hadoop小文件处理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/08/29/hive%20on%20tez/" rel="next" title="hive on tez">
                  hive on tez <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">maoeryu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  





</body>
</html>
