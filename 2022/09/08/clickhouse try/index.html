<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"maoeryu.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.2.1","exturl":false,"sidebar":{"position":"left","width":200,"display":"post","padding":7,"offset":5},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="ClickHouse client version 22.8.4.7ClickHouse有2类解析器:完整SQL解析器(递归式解析器),以及数据格式解析器(快速流式解析器).除了 INSERT 查询,其它情况下仅使用完整SQL解析器.官方文档:https:&#x2F;&#x2F;clickhouse.com&#x2F;docs&#x2F;zh&#x2F;sql-reference&#x2F;syntax. clickhouse-client -h c100">
<meta property="og:type" content="article">
<meta property="og:title" content="clickhouse try">
<meta property="og:url" content="https://maoeryu.github.io/2022/09/08/clickhouse%20try/index.html">
<meta property="og:site_name" content="FlyingPig">
<meta property="og:description" content="ClickHouse client version 22.8.4.7ClickHouse有2类解析器:完整SQL解析器(递归式解析器),以及数据格式解析器(快速流式解析器).除了 INSERT 查询,其它情况下仅使用完整SQL解析器.官方文档:https:&#x2F;&#x2F;clickhouse.com&#x2F;docs&#x2F;zh&#x2F;sql-reference&#x2F;syntax. clickhouse-client -h c100">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl112.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl199.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl198.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl201.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl202.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl113.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl116.png">
<meta property="og:image" content="https://maoeryu.github.io/images/flgl115.png">
<meta property="article:published_time" content="2022-09-07T16:00:00.000Z">
<meta property="article:modified_time" content="2022-09-16T08:37:18.086Z">
<meta property="article:author" content="maoeryu">
<meta property="article:tag" content="clickhouse">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://maoeryu.github.io/images/flgl112.png">


<link rel="canonical" href="https://maoeryu.github.io/2022/09/08/clickhouse%20try/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>clickhouse try | FlyingPig</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">FlyingPig</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">1.</span> <span class="nav-text">数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">1.1.</span> <span class="nav-text">创建数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="nav-number">1.1.1.</span> <span class="nav-text">单点操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C"><span class="nav-number">1.1.2.</span> <span class="nav-text">集群操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C%E5%88%87%E6%8D%A2MYSQL%E5%BC%95%E6%93%8E"><span class="nav-number">1.1.3.</span> <span class="nav-text">集群操作切换MYSQL引擎</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.</span> <span class="nav-text">表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MergeTree%E7%B3%BB%E5%88%97%E5%BC%95%E6%93%8E"><span class="nav-number">2.1.</span> <span class="nav-text">MergeTree系列引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MergeTree%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.1.1.</span> <span class="nav-text">MergeTree表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E6%B3%95"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">建表语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">参数说明</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#SETTINGS"><span class="nav-number">2.1.1.2.1.</span> <span class="nav-text">SETTINGS</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E9%85%8D%E7%BD%AE"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">示例配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.1.1.4.</span> <span class="nav-text">建表示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">2.1.1.5.</span> <span class="nav-text">数据目录结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="nav-number">2.1.1.6.</span> <span class="nav-text">注意点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="nav-number">2.1.1.7.</span> <span class="nav-text">简单使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E5%9D%97%E8%AE%BE%E5%A4%87%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="nav-number">2.1.1.8.</span> <span class="nav-text">使用多个块设备进行数据存储</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ReplacingMergeTree%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.1.2.</span> <span class="nav-text">ReplacingMergeTree表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E6%B3%95-1"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">建表语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">建表示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9-1"><span class="nav-number">2.1.2.3.</span> <span class="nav-text">注意点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.1.2.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SummingMergeTree%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.1.3.</span> <span class="nav-text">SummingMergeTree表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E6%B3%95-2"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">建表语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E7%A4%BA%E4%BE%8B-2"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">建表示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9-2"><span class="nav-number">2.1.3.3.</span> <span class="nav-text">注意点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">2.1.3.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Aggregatingmergetree%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.1.4.</span> <span class="nav-text">Aggregatingmergetree表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E6%B3%95-3"><span class="nav-number">2.1.4.1.</span> <span class="nav-text">建表语法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CollapsingMergeTree%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.1.5.</span> <span class="nav-text">CollapsingMergeTree表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E6%B3%95-4"><span class="nav-number">2.1.5.1.</span> <span class="nav-text">建表语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9-3"><span class="nav-number">2.1.5.2.</span> <span class="nav-text">注意点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VersionedCollapsingMergeTree%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.1.6.</span> <span class="nav-text">VersionedCollapsingMergeTree表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E6%B3%95-5"><span class="nav-number">2.1.6.1.</span> <span class="nav-text">建表语法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GraphiteMergeTree%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.1.7.</span> <span class="nav-text">GraphiteMergeTree表引擎</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Log%E7%B3%BB%E5%88%97%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.2.</span> <span class="nav-text">Log系列表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">2.2.1.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Log%E7%B3%BB%E5%88%97%E8%A1%A8%E5%BC%95%E6%93%8E%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">2.2.2.</span> <span class="nav-text">Log系列表引擎的特点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B1%E6%80%A7%E7%89%B9%E7%82%B9"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">共性特点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8C%BA%E5%88%AB"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">区别</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TinyLog%E8%A1%A8%E5%BC%95%E6%93%8E%E4%BD%BF%E7%94%A8"><span class="nav-number">2.2.3.</span> <span class="nav-text">TinyLog表引擎使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-1"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">数据目录结构</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8Bsizes-json%E6%95%B0%E6%8D%AE"><span class="nav-number">2.2.3.1.1.</span> <span class="nav-text">查看sizes.json数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#StripLog%E8%A1%A8%E5%BC%95%E6%93%8E%E4%BD%BF%E7%94%A8"><span class="nav-number">2.2.4.</span> <span class="nav-text">StripLog表引擎使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-2"><span class="nav-number">2.2.4.1.</span> <span class="nav-text">数据目录结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9-4"><span class="nav-number">2.2.4.2.</span> <span class="nav-text">注意点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Log%E8%A1%A8%E5%BC%95%E6%93%8E%E4%BD%BF%E7%94%A8"><span class="nav-number">2.2.5.</span> <span class="nav-text">Log表引擎使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-3"><span class="nav-number">2.2.5.1.</span> <span class="nav-text">数据目录结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9-5"><span class="nav-number">2.2.5.2.</span> <span class="nav-text">注意点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E9%9B%86%E6%88%90%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.3.</span> <span class="nav-text">外部集成表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HDFS-2-6-5"><span class="nav-number">2.3.1.</span> <span class="nav-text">HDFS(2.6.5)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E-1"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">参数说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hive-2-1-1"><span class="nav-number">2.3.2.</span> <span class="nav-text">Hive(2.1.1)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E6%B3%95-6"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">建表语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E-2"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">参数说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MySQL"><span class="nav-number">2.3.3.</span> <span class="nav-text">MySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E-3"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">参数说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9-6"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">注意点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="nav-number">2.3.3.3.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JDBC"><span class="nav-number">2.3.4.</span> <span class="nav-text">JDBC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kafka"><span class="nav-number">2.3.5.</span> <span class="nav-text">Kafka</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E-4"><span class="nav-number">2.3.5.1.</span> <span class="nav-text">参数说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9-7"><span class="nav-number">2.3.5.2.</span> <span class="nav-text">注意点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-3"><span class="nav-number">2.3.5.3.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B2"><span class="nav-number">2.3.5.4.</span> <span class="nav-text">示例2</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%89%B9%E6%AE%8A%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.4.</span> <span class="nav-text">其他特殊的表引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Memory%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.4.1.</span> <span class="nav-text">Memory表引擎</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Distributed%E8%A1%A8%E5%BC%95%E6%93%8E"><span class="nav-number">2.4.2.</span> <span class="nav-text">Distributed表引擎</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ClickHouse%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">ClickHouse常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%90%AF-ClickHouse-%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%97%B6%E9%97%B4%E4%BC%9A%E6%AF%94%E8%BE%83%E9%95%BF"><span class="nav-number">3.1.</span> <span class="nav-text">重启 ClickHouse 服务的时间会比较长</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5%E6%8A%A5%E9%94%99-too-many-parts-exception"><span class="nav-number">3.2.</span> <span class="nav-text">数据插入报错 too many parts exception</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E8%A1%A8%E5%8F%98%E4%B8%BA%E5%8F%AA%E8%AF%BB"><span class="nav-number">3.3.</span> <span class="nav-text">复制表变为只读</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C-JOIN-%E6%93%8D%E4%BD%9C%E6%97%B6%E5%86%85%E5%AD%98%E8%B6%85%E9%99%90"><span class="nav-number">3.4.</span> <span class="nav-text">执行 JOIN 操作时内存超限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ClickHouse%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95"><span class="nav-number">4.</span> <span class="nav-text">ClickHouse问题排查方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E5%86%99%E5%85%A5%E7%9A%84%E9%A3%8E%E9%99%A9"><span class="nav-number">5.</span> <span class="nav-text">直接写入的风险</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E5%88%86%E5%B8%83%E5%BC%8F%E8%A1%A8"><span class="nav-number">5.1.</span> <span class="nav-text">写入分布式表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E5%85%A5-MergeTree-%E8%A1%A8"><span class="nav-number">5.2.</span> <span class="nav-text">写入 MergeTree 表</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">maoeryu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">220</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://maoeryu.github.io/2022/09/08/clickhouse%20try/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="maoeryu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlyingPig">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          clickhouse try
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-08 00:00:00" itemprop="dateCreated datePublished" datetime="2022-09-08T00:00:00+08:00">2022-09-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-09-16 16:37:18" itemprop="dateModified" datetime="2022-09-16T16:37:18+08:00">2022-09-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ClickHouse client version 22.8.4.7<br>ClickHouse有2类解析器:完整SQL解析器(递归式解析器),以及数据格式解析器(快速流式解析器).<br>除了 INSERT 查询,其它情况下仅使用完整SQL解析器.<br>官方文档:<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/sql-reference/syntax">https://clickhouse.com/docs/zh/sql-reference/syntax</a>.</p>
<p>clickhouse-client -h c100 -d default -m -u default --password</p>
<span id="more"></span>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] db_name [<span class="keyword">ON</span> CLUSTER cluster] [ENGINE <span class="operator">=</span> engine(...)]</span><br></pre></td></tr></table></figure>

<p><strong>ON CLUSTER</strong>:ClickHouse在指定集群的所有服务器上创建db_name数据库.<br><strong>ENGINE</strong>:指定数据库引擎,默认情况下ClickHouse使用Atomic,还有其它数据库引擎.</p>
<h4 id="单点操作"><a href="#单点操作" class="headerlink" title="单点操作"></a>单点操作</h4><p>不指定数据库引擎,默认使用Atomic引擎.<br>不指定集群,则只在当前击节点有效,<strong>其它节点是不会有这个库的</strong>.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> ck_test;</span><br><span class="line"><span class="keyword">show</span> databases;</span><br></pre></td></tr></table></figure>

<p>默认的数据库是磁盘上的一个文件目录,执行创建之后可以在数据目录下创建文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls -l /var/lib/clickhouse/data/</span><br><span class="line"><span class="comment"># 可以看相关的元数据</span></span><br><span class="line">ls -l /var/lib/clickhouse/metadata</span><br><span class="line"><span class="comment"># 查看数据库引擎</span></span><br><span class="line">cat /var/lib/clickhouse/metadata/ck_test.sql</span><br></pre></td></tr></table></figure>

<img src="/images/flgl112.png" style="margin-left: 0px; padding-bottom: 10px;">

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看创建数据库的语句</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> database ck_test;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> database ck_test\G;</span><br><span class="line"># 删除数据库</span><br><span class="line"><span class="keyword">drop</span> database ck_test;</span><br></pre></td></tr></table></figure>

<h4 id="集群操作"><a href="#集群操作" class="headerlink" title="集群操作"></a>集群操作</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> system.clusters;</span><br><span class="line"># 先查看</span><br><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"># 不指定数据库引擎,默认使用<span class="keyword">Atomic</span>引擎,指定集群</span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> ck_test <span class="keyword">ON</span> CLUSTER ck_cluster_2022;</span><br><span class="line"># 检查</span><br><span class="line"><span class="keyword">show</span> databases;</span><br></pre></td></tr></table></figure>

<h4 id="集群操作切换MYSQL引擎"><a href="#集群操作切换MYSQL引擎" class="headerlink" title="集群操作切换MYSQL引擎"></a>集群操作切换MYSQL引擎</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] db_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">ENGINE <span class="operator">=</span> MySQL(<span class="string">&#x27;host:port&#x27;</span>, [<span class="string">&#x27;database&#x27;</span> <span class="operator">|</span> database], <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;password&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>引擎参数:<br>host:port -- MySQL服务地址<br>database -- MySQL数据库名称<br>user -- MySQL用户名<br>password -- MySQL用户密码</p>
<p>1)MySQL操作<br>mysql -uroot -p -h oceanbase004</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 创建数据库</span><br><span class="line"><span class="keyword">create</span> database ck_test001;</span><br><span class="line">USE ck_test001;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ck_test001`.`mysql_table` (</span><br><span class="line">`int_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">`<span class="type">float</span>` <span class="type">FLOAT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`int_id`));</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> tabels;</span><br><span class="line"></span><br><span class="line"># 添加数据</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mysql_table (`int_id`, `<span class="type">float</span>`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"># 查看数据</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql_table;</span><br></pre></td></tr></table></figure>

<p>2)ClickHouse操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建数据库使用mysql引擎</span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> mysql_db <span class="keyword">ON</span> CLUSTER ck_cluster_2022 ENGINE <span class="operator">=</span> MySQL(<span class="string">&#x27;oceanbase004:3306&#x27;</span>, <span class="string">&#x27;ck_test001&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"></span><br><span class="line">use mysql_db;</span><br><span class="line"><span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql_table;</span><br></pre></td></tr></table></figure>

<h2 id="表引擎"><a href="#表引擎" class="headerlink" title="表引擎"></a>表引擎</h2><p>ClickHouse 的表引擎是 ClickHouse 服务的核心,它们决定了 ClickHouse 的以下行为:</p>
<ol>
<li>数据的存储方式和位置.</li>
<li>支持哪些查询操作以及如何支持.</li>
<li>数据的并发访问.</li>
<li>数据索引的使用.</li>
<li>是否可以支持多线程请求.</li>
<li>是否可以支持数据复制.</li>
</ol>
<p>ClickHouse 包含以下几种常用的引擎类型:</p>
<ol>
<li>MergeTree 引擎<br>该系列引擎是执行高负载任务的最通用和最强大的表引擎,它们的特点是可以快速插入数据以及进行后续的数据处理.<br>该系列引擎还同时支持数据复制(使用Replicated的引擎版本),分区 (partition) 以及一些其它引擎不支持的额外功能.</li>
<li>Log 引擎<br>该系列引擎是具有最小功能的轻量级引擎.<br>当你需要快速写入许多小表(最多约有 100 万行)并在后续任务中整体读取它们时使用该系列引擎是最有效的.</li>
<li>集成引擎<br>该系列引擎是与其它数据存储以及处理系统集成的引擎,如 Kafka,MySQL 以及 HDFS 等.<br>使用该系列引擎可以直接与其它系统进行交互,但也会有一定的限制.</li>
<li>特殊引擎<br>该系列引擎主要用于一些特定的功能,如 Distributed 用于分布式查询,MaterializedView 用来聚合数据,以及 Dictionary 用来查询字典数据等.</li>
</ol>
<h3 id="MergeTree系列引擎"><a href="#MergeTree系列引擎" class="headerlink" title="MergeTree系列引擎"></a>MergeTree系列引擎</h3><p>在所有的表引擎中,最为核心的当属MergeTree系列表引擎,这些表引擎拥有最为强大的性能和最广泛的使用场合.<br>对于非MergeTree系列的其他引擎而言,主要用于特殊用途,场景相对有限.<br>而MergeTree系列表引擎是官方主推的存储引擎,支持几乎所有ClickHouse核心功能.</p>
<h4 id="MergeTree表引擎"><a href="#MergeTree表引擎" class="headerlink" title="MergeTree表引擎"></a>MergeTree表引擎</h4><p>MergeTree在写入一批数据时,数据总会以数据片段的形式写入磁盘,且数据片段不可修改.<br>为了避免片段过多,ClickHouse会通过后台线程,定期合并这些数据片段,属于相同分区的数据片段会被合成一个新的片段.<br>这种数据片段往复合并的特点,也正是合并树名称的由来.</p>
<p>MergeTree作为家族系列最基础的表引擎,主要有以下特点:</p>
<ol>
<li>存储的数据按照主键排序:允许创建稀疏索引,从而加快数据查询速度</li>
<li>支持分区,可以通过PRIMARY KEY语句指定分区字段.</li>
<li>支持数据副本</li>
<li>支持数据采样</li>
</ol>
<h5 id="建表语法"><a href="#建表语法" class="headerlink" title="建表语法"></a>建表语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">  name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1] [TTL expr1],</span><br><span class="line">  name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2] [TTL expr2],</span><br><span class="line">  ...</span><br><span class="line">  INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1,</span><br><span class="line">  INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> expr</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">PRIMARY</span> KEY expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[TTL expr [<span class="keyword">DELETE</span><span class="operator">|</span><span class="keyword">TO</span> DISK <span class="string">&#x27;xxx&#x27;</span><span class="operator">|</span><span class="keyword">TO</span> VOLUME <span class="string">&#x27;xxx&#x27;</span>], ...]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure>

<h5 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h5><p><code>ENGINE</code><br>引擎名和参数.<br>ENGINE = MergeTree(),MergeTree引擎没有参数</p>
<p><code>ORDER BY</code><br>排序字段,可以是一组列的元组或任意的表达式,比如ORDER BY (Col1, Col2).<br>如果没有PRIMARY KEY显式指定的主键,默认情况下 sorting key(排序字段)即为主键.<br>如果不需要排序,则可以使用<code>ORDER BY tuple()</code>语法,这样的话,创建的表也就不包含主键.<br>这种情况下,ClickHouse会按照插入的顺序存储数据.<br>必选.</p>
<p><code>PARTITION BY</code><br>分区字段,可选.<br>要按月分区,可以使用表达式<code>toYYYYMM(date_column)</code>,这里的date_column是一个Date类型的列.<br>分区名的格式会是&quot;YYYYMM&quot;.</p>
<p><code>PRIMARY KEY</code><br>指定主键,如果排序字段与主键不一致,可以单独指定主键字段.<br>默认情况下主键跟排序键(由 ORDER BY 子句指定)相同.<br>因此,大部分情况下不需要再专门指定一个 PRIMARY KEY 子句.<br>可选.</p>
<p><code>SAMPLE BY</code><br>用于抽样的表达式,如果要用抽样表达式,主键中必须包含这个表达式.<br>比如SAMPLE BY intHash32(UserID) ORDER BY (CounterID, EventDate, intHash32(UserID)).<br>可选.</p>
<p><code>TTL</code><br>数据的存活时间.<br>在MergeTree中,可以为某个列字段或整张表设置TTL.<br>当时间到达时,如果是列字段级别的TTL,则会删除这一列的数据.<br>如果是表级别的TTL,则会删除整张表的数据.<br>可选.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 表达式中必须存在至少一个 Date 或 DateTime 类型的列,比如:</span><br><span class="line">TTL date + INTERVAl 1 DAY</span><br></pre></td></tr></table></figure>

<p><code>SETTINGS</code><br>额外的参数配置.<br>可选.</p>
<h6 id="SETTINGS"><a href="#SETTINGS" class="headerlink" title="SETTINGS"></a>SETTINGS</h6><p><code>index_granularity</code><br>索引粒度.默认值8192.<br>索引中相邻的『标记』间的数据行数.<br>参考数据存储.</p>
<p><code>index_granularity_bytes</code><br>索引粒度,以字节为单位,默认值10Mb.<br>如果想要仅按数据行数限制索引粒度,请设置为0(不建议).</p>
<p><code>min_index_granularity_bytes</code><br>允许的最小数据粒度,默认值1024b.<br>该选项用于防止误操作,添加了一个非常低索引粒度的表.</p>
<p><code>enable_mixed_granularity_parts</code><br>是否启用通过 index_granularity_bytes 控制索引粒度的大小.<br>在19.11版本之前,只有 index_granularity 配置能够用于限制索引粒度的大小.<br>当从具有很大的行(几十上百兆字节)的表中查询数据时候,index_granularity_bytes 配置能够提升ClickHouse的性能.<br>如果您的表里有很大的行,可以开启这项配置来提升SELECT 查询的性能.</p>
<p><code>use_minimalistic_part_header_in_zookeeper</code><br>ZooKeeper中数据片段存储方式.<br>如果use_minimalistic_part_header_in_zookeeper=1 ,ZooKeeper会存储更少的数据.</p>
<p><code>min_merge_bytes_to_use_direct_io</code><br>使用直接 I/O 来操作磁盘的合并操作时要求的最小数据量.<br>合并数据片段时,ClickHouse 会计算要被合并的所有数据的总存储空间.<br>如果大小超过了 min_merge_bytes_to_use_direct_io 设置的字节数,则 ClickHouse 将使用直接 I/O 接口(O_DIRECT 选项)对磁盘读写.<br>如果设置 min_merge_bytes_to_use_direct_io = 0 ,则会禁用直接 I/O.<br>默认值:10 * 1024 * 1024 * 1024 字节.</p>
<p><code>merge_with_ttl_timeout</code><br>TTL合并频率的最小间隔时间,单位:秒.<br>默认值: 86400 (1天).</p>
<p><code>write_final_mark</code><br>是否启用在数据片段尾部写入最终索引标记.<br>默认值: 1(不要关闭).</p>
<p><code>merge_max_block_size</code><br>在块中进行合并操作时的最大行数限制.<br>默认值:8192</p>
<p><code>storage_policy</code><br>存储策略</p>
<p><code>min_bytes_for_wide_part,min_rows_for_wide_part</code><br>在数据片段中可以使用Wide格式进行存储的最小字节数/行数.<br>可以不设置/只设置一个/全都设置.</p>
<p><code>max_parts_in_total</code><br>所有分区中最大块的数量(意义不明)</p>
<p><code>max_compress_block_size</code><br>在数据压缩写入表前,未压缩数据块的最大大小.<br>可以在全局设置中设置该值(参见max_compress_block_size).<br>建表时指定该值会覆盖全局设置.</p>
<p><code>min_compress_block_size</code><br>在数据压缩写入表前,未压缩数据块的最小大小.<br>建表时指定该值会覆盖全局设置.</p>
<p><code>max_partitions_to_read</code><br>一次查询中可访问的分区最大数.</p>
<h5 id="示例配置"><a href="#示例配置" class="headerlink" title="示例配置"></a>示例配置</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ENGINE MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(EventDate)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (CounterID, EventDate, intHash32(UserID))</span><br><span class="line">SAMPLE <span class="keyword">BY</span> intHash32(UserID)</span><br><span class="line">SETTINGS index_granularity<span class="operator">=</span><span class="number">8192</span></span><br></pre></td></tr></table></figure>

<p>同时设置了一个按用户 ID 哈希的抽样表达式.<br>这使得可以对该表中每个 CounterID 和 EventDate 的数据伪随机分布.<br>如果在查询时指定了 SAMPLE 子句.<br>ClickHouse会返回对于用户子集的一个均匀的伪随机数据采样.<br>index_granularity 可省略因为 8192 是默认设置.</p>
<h5 id="建表示例"><a href="#建表示例" class="headerlink" title="建表示例"></a>建表示例</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp_mergetree (</span><br><span class="line">  emp_id UInt16 COMMENT <span class="string">&#x27;员工id&#x27;</span>,</span><br><span class="line">  name String COMMENT <span class="string">&#x27;员工姓名&#x27;</span>,</span><br><span class="line">  work_place String COMMENT <span class="string">&#x27;工作地点&#x27;</span>,</span><br><span class="line">  age UInt8 COMMENT <span class="string">&#x27;员工年龄&#x27;</span>,</span><br><span class="line">  depart String COMMENT <span class="string">&#x27;部门&#x27;</span>,</span><br><span class="line">  salary Decimal32(<span class="number">2</span>) COMMENT <span class="string">&#x27;工资&#x27;</span></span><br><span class="line">)ENGINE<span class="operator">=</span>MergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> emp_id</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> work_place</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_mergetree <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">20000</span>),(<span class="number">2</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;人事部&#x27;</span>,<span class="number">10000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_mergetree <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">33</span>,<span class="string">&#x27;财务部&#x27;</span>,<span class="number">50000</span>),(<span class="number">4</span>,<span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;杭州&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;销售事部&#x27;</span>,<span class="number">50000</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询数据</span></span><br><span class="line"><span class="comment">-- 按work_place进行分区</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_mergetree;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br></pre></td></tr></table></figure>

<h5 id="数据目录结构"><a href="#数据目录结构" class="headerlink" title="数据目录结构"></a>数据目录结构</h5><p>查看一下数据存储格式,可以看出,存在三个分区文件夹,每一个分区文件夹内存储了对应分区的数据.<br>ll /var/lib/clickhouse/data/default/emp_mergetree</p>
<img src="/images/flgl199.png" style="margin-left: 0px; padding-bottom: 10px;">

<p>进入一个分区目录查看图片.</p>
<ol>
<li>checksums.txt<br>校验文件,使用二进制格式存储.<br>它保存了余下各类文件(primary.idx/count.txt等)的size大小及size的哈希值,用于快速校验文件的完整性和正确性.</li>
<li>columns.txt<br>列信息文件,使用明文格式存储.<br>用于保存此数据分区下的列字段信息,例如 <code>cat columns.txt</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">columns format version: 1</span><br><span class="line">6 columns:</span><br><span class="line">&#96;emp_id&#96; UInt16</span><br><span class="line">&#96;name&#96; String</span><br><span class="line">&#96;work_place&#96; String</span><br><span class="line">&#96;age&#96; UInt8</span><br><span class="line">&#96;depart&#96; String</span><br><span class="line">&#96;salary&#96; Decimal(9, 2)</span><br></pre></td></tr></table></figure></li>
<li>count.txt<br>计数文件,使用明文格式存储.<br>用于记录当前数据分区目录下数据的总行数.</li>
<li>primary.idx<br>一级索引文件,使用二进制格式存储.<br>用于存放稀疏索引,一张MergeTree表只能声明一次一级索引,即通过ORDER BY或者PRIMARY KEY指定字段.<br>借助稀疏索引,在数据查询的时能够排除主键条件范围之外的数据文件,从而有效减少数据扫描范围,加速查询速度.</li>
<li>列.bin<br>数据文件,使用压缩格式存储,默认为LZ4压缩格式,用于存储某一列的数据.<br>由于MergeTree采用列式存储,所以每一个列字段都拥有独立的.bin数据文件,并以列字段名称命名.</li>
<li>列.mrk2<br>列字段标记文件,使用二进制格式存储.<br>标记文件中保存了.bin文件中数据的偏移量信息.</li>
<li>partition.dat与<code>minmax_[Column].idx</code><br>如果指定了分区键,则会额外生成partition.dat与minmax索引文件,它们均使用二进制格式存储.<br>partition.dat用于保存当前分区下分区表达式最终生成的值,即分区字段值.<br>而minmax索引用于记录当前分区下分区字段对应原始数据的最小和最大值.<br>比如当使用EventTime字段对应的原始数据为2020-09-17/2020-09-30,分区表达式为PARTITION BY toYYYYMM(EventTime),即按月分区.<br>partition.dat中保存的值将会是2019-09,而minmax索引中保存的值将会是2020-09-17 2020-09-30.</li>
</ol>
<h5 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h5><p>1)多次插入数据,会生成多个分区文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 新插入两条数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_mergetree <span class="keyword">VALUES</span> (<span class="number">5</span>,<span class="string">&#x27;robin&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">35</span>,<span class="string">&#x27;财务部&#x27;</span>,<span class="number">50000</span>),(<span class="number">6</span>,<span class="string">&#x27;lilei&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">38</span>,<span class="string">&#x27;销售事部&#x27;</span>,<span class="number">50000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询结果</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp_mergetree;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name──┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">5</span> │ robin │ 北京       │  <span class="number">35</span> │ 财务部   │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">6</span> │ lilei │ 北京       │  <span class="number">38</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴───────┴────────────┴─────┴──────────┴────────┘</span><br></pre></td></tr></table></figure>

<p>可以看出,新插入的数据新生成了一个数据块,并没有与原来的分区数据在一起,我们可以执行optimize命令,执行合并操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 执行合并操作</span></span><br><span class="line">OPTIMIZE <span class="keyword">TABLE</span> emp_mergetree <span class="keyword">PARTITION</span> <span class="string">&#x27;北京&#x27;</span>;</span><br><span class="line"><span class="comment">-- 再次执行查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_mergetree;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name──┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob   │ 北京       │  <span class="number">33</span> │ 财务部   │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">5</span> │ robin │ 北京       │  <span class="number">35</span> │ 财务部   │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">6</span> │ lilei │ 北京       │  <span class="number">38</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴───────┴────────────┴─────┴──────────┴────────┘</span><br></pre></td></tr></table></figure>

<p>执行上面的合并操作之后,会新生成一个该分区的文件夹,原理的分区文件夹不变.</p>
<p>2)在MergeTree中主键并不用于去重,而是用于索引,加快查询速度</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 插入一条相同主键的数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_mergetree <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;sam&#x27;</span>,<span class="string">&#x27;杭州&#x27;</span>,<span class="number">35</span>,<span class="string">&#x27;财务部&#x27;</span>,<span class="number">50000</span>);</span><br><span class="line"><span class="comment">-- 会发现该条数据可以插入,由此可知,并不会对主键进行去重</span></span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ sam  │ 杭州       │  <span class="number">35</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name──┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob   │ 北京       │  <span class="number">33</span> │ 财务部   │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">5</span> │ robin │ 北京       │  <span class="number">35</span> │ 财务部   │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">6</span> │ lilei │ 北京       │  <span class="number">38</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴───────┴────────────┴─────┴──────────┴────────┘</span><br></pre></td></tr></table></figure>

<h5 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建本地数据库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> ck_test002;</span><br><span class="line"><span class="comment">-- 创建本地表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ck_test002.example_table</span><br><span class="line">(</span><br><span class="line">  d DateTime,</span><br><span class="line">  a <span class="type">Int</span> TTL d <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">MONTH</span>,</span><br><span class="line">  b <span class="type">Int</span> TTL d <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">MONTH</span>,</span><br><span class="line">  c String</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(d)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">from</span> ck_test002;</span><br></pre></td></tr></table></figure>

<h5 id="使用多个块设备进行数据存储"><a href="#使用多个块设备进行数据存储" class="headerlink" title="使用多个块设备进行数据存储"></a>使用多个块设备进行数据存储</h5><p>MergeTree 系列表引擎可以将数据存储在多个块设备上.<br>这对某些可以潜在被划分为&quot;冷/热&quot;表来说是很有用的.<br>为了应用存储策略,可以在建表时使用<code>storage_policy</code>设置.</p>
<p>磁盘/卷/存储策略应当在主配置文件 /etc/clickhouse-server/config.xml 或 /etc/clickhouse-server/config.d 目录中的独立文件中的 <code>&lt;storage_configuration&gt;</code> 标签内定义.</p>
<p>示例配置如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建存储路径</span></span><br><span class="line">mkdir -p /var/lib/clickhouse/storage001/data&#123;1..3&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 授权</span></span><br><span class="line">chown -R clickhouse:clickhouse /var/lib/clickhouse/storage001</span><br></pre></td></tr></table></figure>

<p>存储配置如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">storage_configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">disks</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk1</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/storage001/data1/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk2</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/storage001/data2/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">keep_free_space_bytes</span>&gt;</span>10485760<span class="tag">&lt;/<span class="name">keep_free_space_bytes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk3</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/storage001/data3/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">keep_free_space_bytes</span>&gt;</span>10485760<span class="tag">&lt;/<span class="name">keep_free_space_bytes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk3</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">disks</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">storage_configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;disk_name_N&gt;</code> -- 磁盘名,名称必须与其他磁盘不同.<br><code>path</code> -- 服务器将用来存储数据 (data 和 shadow 目录) 的路径, 应当以 / 结尾.<br><code>keep_free_space_bytes</code> -- 需要保留的剩余磁盘空间.</p>
<p>存储策略配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">storage_configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">policies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hdd_in_order</span>&gt;</span> <span class="comment">&lt;!-- policy name --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">volumes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">single</span>&gt;</span> <span class="comment">&lt;!-- volume name --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk1<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">single</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">volumes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hdd_in_order</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">moving_from_ssd_to_hdd</span>&gt;</span> <span class="comment">&lt;!-- policy name --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">volumes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hot</span>&gt;</span> <span class="comment">&lt;!-- volume name --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk2<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">max_data_part_size_bytes</span>&gt;</span>1073741824<span class="tag">&lt;/<span class="name">max_data_part_size_bytes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">hot</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cold</span>&gt;</span> <span class="comment">&lt;!-- volume name --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk3<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">cold</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">volumes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">move_factor</span>&gt;</span>0.2<span class="tag">&lt;/<span class="name">move_factor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">moving_from_ssd_to_hdd</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">policies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">storage_configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>标签:<br><code>disk</code> -- 卷中的磁盘.<br><code>max_data_part_size_bytes</code> -- 卷中的磁盘可以存储的数据片段的最大大小.<br><code>move_factor</code> -- 当可用空间少于这个因子时,数据将自动的向下一个卷(如果有的话)移动 (默认值为 0.1).<br><code>prefer_not_to_merge</code> -- 禁止在这个卷中进行数据合并.<br>该选项启用时,对该卷的数据不能进行合并.<br>这个选项主要用于慢速磁盘.</p>
<p>完整配置(/etc/clickhouse-server/config.d/storage001.xml):</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">yandex</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">storage_configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 存储配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disks</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">disk1</span>&gt;</span> <span class="comment">&lt;!-- disk name --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/storage001/data1/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">disk1</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">disk2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/storage001/data2/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keep_free_space_bytes</span>&gt;</span>10485760<span class="tag">&lt;/<span class="name">keep_free_space_bytes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">disk2</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">disk3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/storage001/data3/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keep_free_space_bytes</span>&gt;</span>10485760<span class="tag">&lt;/<span class="name">keep_free_space_bytes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">disk3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disks</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 存储策略配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">policies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hdd_in_order</span>&gt;</span> <span class="comment">&lt;!-- policy name --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">volumes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">single</span>&gt;</span> <span class="comment">&lt;!-- volume name --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk1<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">single</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">volumes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">hdd_in_order</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">moving_from_ssd_to_hdd</span>&gt;</span> <span class="comment">&lt;!-- policy name --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">volumes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">hot</span>&gt;</span> <span class="comment">&lt;!-- volume name --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk2<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">max_data_part_size_bytes</span>&gt;</span>1073741824<span class="tag">&lt;/<span class="name">max_data_part_size_bytes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">hot</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">cold</span>&gt;</span> <span class="comment">&lt;!-- volume name --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk3<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">cold</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">volumes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">move_factor</span>&gt;</span>0.2<span class="tag">&lt;/<span class="name">move_factor</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">moving_from_ssd_to_hdd</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">policies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">storage_configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">yandex</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>授权,<br>chown -R clickhouse.clickhouse /etc/clickhouse-server/config.d<br>查看(配置自动加载,不需要重启服务).</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 检查</span><br><span class="line"><span class="keyword">SELECT</span> name,path,formatReadableSize(free_space) <span class="keyword">AS</span> <span class="keyword">free</span>,formatReadableSize(total_space) <span class="keyword">AS</span> total,formatReadableSize(keep_free_space) <span class="keyword">AS</span> reserved <span class="keyword">from</span> system.disks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> policy_name, volume_name, disks <span class="keyword">FROM</span> system.storage_policies;</span><br></pre></td></tr></table></figure>

<p>在创建表时,指定存储策略(默认default):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_with_non_default_policy </span><br><span class="line">(</span><br><span class="line">    EventDate <span class="type">Date</span>,</span><br><span class="line">    OrderID UInt64,</span><br><span class="line">    BannerID UInt64,</span><br><span class="line">    SearchPhrase String</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (OrderID, BannerID)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(EventDate)</span><br><span class="line">SETTINGS storage_policy <span class="operator">=</span> <span class="string">&#x27;moving_from_ssd_to_hdd&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="ReplacingMergeTree表引擎"><a href="#ReplacingMergeTree表引擎" class="headerlink" title="ReplacingMergeTree表引擎"></a>ReplacingMergeTree表引擎</h4><p>上文提到MergeTree表引擎无法对相同主键的数据进行去重.<br>ClickHouse提供了ReplacingMergeTree引擎,可以针对相同主键的数据进行去重,它能够在合并分区时删除重复的数据.<br>值得注意的是,ReplacingMergeTree只是在一定程度上解决了数据重复问题,但是并不能完全保障数据不重复.</p>
<h5 id="建表语法-1"><a href="#建表语法-1" class="headerlink" title="建表语法"></a>建表语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">  name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">  name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">  ...</span><br><span class="line">) ENGINE <span class="operator">=</span> ReplacingMergeTree([ver])</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">PRIMARY</span> KEY expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure>

<ol>
<li><code>[ver]</code>:可选参数,列的版本,可以是UInt/Date或者DateTime类型的字段作为版本号.<br>该参数决定了数据去重的方式.</li>
<li>当没有指定<code>[ver]</code>参数时,保留最新的数据.如果指定了具体的值,保留最大的版本数据.</li>
</ol>
<h5 id="建表示例-1"><a href="#建表示例-1" class="headerlink" title="建表示例"></a>建表示例</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp_replacingmergetree (</span><br><span class="line">  emp_id UInt16 COMMENT <span class="string">&#x27;员工id&#x27;</span>,</span><br><span class="line">  name String COMMENT <span class="string">&#x27;员工姓名&#x27;</span>,</span><br><span class="line">  work_place String COMMENT <span class="string">&#x27;工作地点&#x27;</span>,</span><br><span class="line">  age UInt8 COMMENT <span class="string">&#x27;员工年龄&#x27;</span>,</span><br><span class="line">  depart String COMMENT <span class="string">&#x27;部门&#x27;</span>,</span><br><span class="line">  salary Decimal32(<span class="number">2</span>) COMMENT <span class="string">&#x27;工资&#x27;</span></span><br><span class="line">)ENGINE<span class="operator">=</span>ReplacingMergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> emp_id</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY emp_id</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> work_place</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_replacingmergetree <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">20000</span>),(<span class="number">2</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;人事部&#x27;</span>,<span class="number">10000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_replacingmergetree <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">33</span>,<span class="string">&#x27;财务部&#x27;</span>,<span class="number">50000</span>),(<span class="number">4</span>,<span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;杭州&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;销售事部&#x27;</span>,<span class="number">50000</span>);</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br></pre></td></tr></table></figure>

<h5 id="注意点-1"><a href="#注意点-1" class="headerlink" title="注意点"></a>注意点</h5><p>当我们再次向该表插入具有相同主键的数据时,观察查询数据的变化.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_replacingmergetree <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">50000</span>);</span><br><span class="line"><span class="comment">-- 查询数据,由于没有进行合并,所以存在主键重复的数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_replacingmergetree;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行合并操作</span></span><br><span class="line">optimize <span class="keyword">table</span> emp_replacingmergetree <span class="keyword">final</span>;</span><br><span class="line"><span class="comment">-- 再次查询,相同主键的数据,保留最近插入的数据,旧的数据被清除</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_replacingmergetree;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br></pre></td></tr></table></figure>

<p>从上面的示例中可以看出,ReplacingMergeTree是支持对数据去重的,那么是根据什么进行去重呢?<br>ReplacingMergeTree在去除重复数据时,是<strong>以ORDERBY排序键为基准的,而不是PRIMARY KEY</strong>.<br>我们再看一个示例:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp_replacingmergetree1 (</span><br><span class="line">  emp_id UInt16 COMMENT <span class="string">&#x27;员工id&#x27;</span>,</span><br><span class="line">  name String COMMENT <span class="string">&#x27;员工姓名&#x27;</span>,</span><br><span class="line">  work_place String COMMENT <span class="string">&#x27;工作地点&#x27;</span>,</span><br><span class="line">  age UInt8 COMMENT <span class="string">&#x27;员工年龄&#x27;</span>,</span><br><span class="line">  depart String COMMENT <span class="string">&#x27;部门&#x27;</span>,</span><br><span class="line">  salary Decimal32(<span class="number">2</span>) COMMENT <span class="string">&#x27;工资&#x27;</span></span><br><span class="line">)ENGINE<span class="operator">=</span>ReplacingMergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (emp_id,name) <span class="comment">-- 注意排序key是两个字段</span></span><br><span class="line"><span class="keyword">PRIMARY</span> KEY emp_id     <span class="comment">-- 主键是一个字段</span></span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> work_place</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_replacingmergetree1 <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">20000</span>),(<span class="number">2</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;人事部&#x27;</span>,<span class="number">10000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_replacingmergetree1 <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">33</span>,<span class="string">&#x27;财务部&#x27;</span>,<span class="number">50000</span>),(<span class="number">4</span>,<span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;杭州&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;销售事部&#x27;</span>,<span class="number">50000</span>);</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br></pre></td></tr></table></figure>

<p>再次向该表中插入相同emp_id和name的数据,并执行合并操作,再观察数据.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_replacingmergetree1 <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">50000</span>),(<span class="number">1</span>,<span class="string">&#x27;sam&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">20000</span>);</span><br><span class="line"><span class="comment">-- 执行合并操作</span></span><br><span class="line">optimize <span class="keyword">table</span> emp_replacingmergetree1 <span class="keyword">final</span>;</span><br><span class="line"><span class="comment">-- 再次查询,可见相同的emp_id和name数据被去重,而形同的主键emp_id不会去重</span></span><br><span class="line"><span class="comment">-- ReplacingMergeTree在去除重复数据时,是以ORDERBY排序键为基准的,而不是PRIMARY KEY</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_replacingmergetree1;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ sam  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br></pre></td></tr></table></figure>

<p>至此,我们知道了ReplacingMergeTree是支持去重的,并且是按照ORDERBY排序键为基准进行去重的.<br>细心的你会发现,上面的重复数据是在一个分区内的,那么如果重复的数据不在一个分区内,会发生什么现象呢?<br>我们再次向上面的emp_replacingmergetree1表插入不同分区的重复数据.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_replacingmergetree1 <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">10000</span>);</span><br><span class="line"><span class="comment">-- 执行合并操作</span></span><br><span class="line">optimize <span class="keyword">table</span> emp_replacingmergetree1 <span class="keyword">final</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_replacingmergetree1;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ sam  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 北京       │  <span class="number">26</span> │ 技术部 │  <span class="number">10000</span> │</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br></pre></td></tr></table></figure>

<p>再次查询,发现 <code>1│tom│北京</code> 与 <code>1│tom│上海</code> 数据重复,因为这两行数据不在同一个分区内.<br>这是因为ReplacingMergeTree是以分区为单位删除重复数据的.</p>
<p>只有在相同的数据分区内重复的数据才可以被删除,而不同数据分区之间的重复数据依然不能被剔除.</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ol>
<li>如何判断数据重复<br>ReplacingMergeTree在去除重复数据时,是以ORDERBY排序键为基准的,而不是PRIMARY KEY.</li>
<li>何时删除重复数据<br>在执行分区合并时,会触发删除重复数据.<br>optimize的合并操作是在后台执行的,无法预测具体执行时间点,除非是手动执行.</li>
<li>不同分区的重复数据不会被去重<br>ReplacingMergeTree是以分区为单位删除重复数据的.<br>只有在相同的数据分区内重复的数据才可以被删除,而不同数据分区之间的重复数据依然不能被剔除.</li>
<li>数据去重的策略是什么<br>如果没有设置<code>[ver]</code>版本号,则保留同一组重复数据中的最新插入的数据.<br>如果设置了<code>[ver]</code>版本号,则保留同一组重复数据中ver字段取值最大的那一行.</li>
<li>optimize命令使用<br>一般在数据量比较大的情况,尽量不要使用该命令.<br>因为在海量数据场景下,执行optimize要消耗大量时间.</li>
</ol>
<h4 id="SummingMergeTree表引擎"><a href="#SummingMergeTree表引擎" class="headerlink" title="SummingMergeTree表引擎"></a>SummingMergeTree表引擎</h4><p>该引擎继承了MergeTree引擎,当合并 SummingMergeTree 表的数据片段时,ClickHouse 会把所有具有相同主键的行合并为一行,该行包含了被合并的行中具有数值数据类型的列的汇总值,即如果存在重复的数据,会对对这些重复的数据进行合并成一条数据,类似于group by的效果.</p>
<p>推荐将该引擎和 MergeTree 一起使用.<br>例如,将完整的数据存储在 MergeTree 表中,并且使用 SummingMergeTree 来存储聚合数据.<br>这种方法可以避免因为使用不正确的主键组合方式而丢失数据.</p>
<p>如果用户只需要查询数据的汇总结果,不关心明细数据,并且数据的汇总条件是预先明确的,即GROUP BY的分组字段是确定的,可以使用该表引擎.</p>
<h5 id="建表语法-2"><a href="#建表语法-2" class="headerlink" title="建表语法"></a>建表语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">  name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">  name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">  ...</span><br><span class="line">) ENGINE <span class="operator">=</span> SummingMergeTree([columns]) <span class="comment">-- 指定合并汇总字段</span></span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure>

<h5 id="建表示例-2"><a href="#建表示例-2" class="headerlink" title="建表示例"></a>建表示例</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp_summingmergetree (</span><br><span class="line">  emp_id UInt16 COMMENT <span class="string">&#x27;员工id&#x27;</span>,</span><br><span class="line">  name String COMMENT <span class="string">&#x27;员工姓名&#x27;</span>,</span><br><span class="line">  work_place String COMMENT <span class="string">&#x27;工作地点&#x27;</span>,</span><br><span class="line">  age UInt8 COMMENT <span class="string">&#x27;员工年龄&#x27;</span>,</span><br><span class="line">  depart String COMMENT <span class="string">&#x27;部门&#x27;</span>,</span><br><span class="line">  salary Decimal32(<span class="number">2</span>) COMMENT <span class="string">&#x27;工资&#x27;</span></span><br><span class="line">)ENGINE<span class="operator">=</span>SummingMergeTree(salary)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (emp_id,name) <span class="comment">-- 注意排序key是两个字段</span></span><br><span class="line"><span class="keyword">PRIMARY</span> KEY emp_id     <span class="comment">-- 主键是一个字段</span></span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> work_place</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_summingmergetree <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">20000</span>),(<span class="number">2</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;人事部&#x27;</span>,<span class="number">10000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_summingmergetree <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">33</span>,<span class="string">&#x27;财务部&#x27;</span>,<span class="number">50000</span>),(<span class="number">4</span>,<span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;杭州&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;销售事部&#x27;</span>,<span class="number">50000</span>);</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br></pre></td></tr></table></figure>

<p>当我们再次插入具有相同emp_id,name的数据时,观察结果.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_summingmergetree <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;信息部&#x27;</span>,<span class="number">10000</span>),(<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;人事部&#x27;</span>,<span class="number">10000</span>);</span><br><span class="line"><span class="comment">-- 查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_summingmergetree;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 信息部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 北京       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行合并操作</span></span><br><span class="line">optimize <span class="keyword">table</span> emp_summingmergetree <span class="keyword">final</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_summingmergetree;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">30000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 北京       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br></pre></td></tr></table></figure>

<p>再次查询,新插入的数据 <code>1│tom│上海│25│信息部│10000.00</code><br>原来的数据 <code>1│tom│上海│25│技术部│20000.00</code><br>这两行数据合并成:<code>1│tom│上海│25│技术部│30000.00</code>.</p>
<h5 id="注意点-2"><a href="#注意点-2" class="headerlink" title="注意点"></a>注意点</h5><p>要保证PRIMARY KEY expr指定的主键是ORDER BY expr 指定字段的前缀,比如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 允许</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (A,B,C) </span><br><span class="line"><span class="keyword">PRIMARY</span> KEY A  </span><br><span class="line"><span class="comment">-- 会报错,DB::Exception: Primary key must be a prefix of the sorting key</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (A,B,C) </span><br><span class="line"><span class="keyword">PRIMARY</span> KEY B</span><br></pre></td></tr></table></figure>

<p>这种强制约束保障了即便在两者定义不同的情况下,主键仍然是排序键的前缀,不会出现索引与数据顺序混乱的问题.</p>
<h5 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h5><ol>
<li>SummingMergeTree是根据什么对两条数据进行合并的<br>用ORBER BY排序键作为聚合数据的条件Key.<br>即如果排序key是相同的,则会合并成一条数据,并对指定的合并字段进行聚合.</li>
<li>仅对分区内的相同排序key的数据行进行合并<br>以数据分区为单位来聚合数据.<br>当分区合并时,同一数据分区内聚合Key相同的数据会被合并汇总,而不同分区之间的数据则不会被汇总.</li>
<li>如果没有指定聚合字段,会怎么聚合<br>如果没有指定聚合字段,则会按照非主键的数值类型字段进行聚合</li>
<li>对于非汇总字段的数据,该保留哪一条<br>如果两行数据除了排序字段相同,其他的非聚合字段不相同,那么在聚合发生时,会保留最初的那条数据,新插入的数据对应的那个字段值会被舍弃</li>
</ol>
<h4 id="Aggregatingmergetree表引擎"><a href="#Aggregatingmergetree表引擎" class="headerlink" title="Aggregatingmergetree表引擎"></a>Aggregatingmergetree表引擎</h4><p>该表引擎继承自MergeTree,可以使用 AggregatingMergeTree 表来做增量数据统计聚合.<br>如果要按一组规则来合并减少行数,则使用 AggregatingMergeTree 是合适的.</p>
<p>AggregatingMergeTree是通过预先定义的聚合函数计算数据并通过二进制的格式存入表内.<br>与SummingMergeTree的区别在于:<br>SummingMergeTree对非主键列进行sum聚合,而AggregatingMergeTree则可以指定各种聚合函数.</p>
<h5 id="建表语法-3"><a href="#建表语法-3" class="headerlink" title="建表语法"></a>建表语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">  name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">  name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">  ...</span><br><span class="line">) ENGINE <span class="operator">=</span> AggregatingMergeTree()</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure>

<h4 id="CollapsingMergeTree表引擎"><a href="#CollapsingMergeTree表引擎" class="headerlink" title="CollapsingMergeTree表引擎"></a>CollapsingMergeTree表引擎</h4><p>CollapsingMergeTree就是一种通过以增代删的思路,支持行级数据修改和删除的表引擎.<br>它通过定义一个sign标记位字段,记录数据行的状态.<br>如果sign标记为1,则表示这是一行有效的数据.<br>如果sign标记为-1,则表示这行数据需要被删除.<br>当CollapsingMergeTree分区合并时,同一数据分区内,sign标记为1和-1的一组数据会被抵消删除.</p>
<p>每次需要新增数据时,写入一行sign标记为1的数据.需要删除数据时,则写入一行sign标记为-1的数据.</p>
<h5 id="建表语法-4"><a href="#建表语法-4" class="headerlink" title="建表语法"></a>建表语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">  name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">  name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">  ...</span><br><span class="line">) ENGINE <span class="operator">=</span> CollapsingMergeTree(sign)</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure>

<h5 id="注意点-3"><a href="#注意点-3" class="headerlink" title="注意点"></a>注意点</h5><p>1)分区合并<br>分数数据折叠不是实时的,需要后台进行Compaction操作,用户也可以使用手动合并命令,但是效率会很低,一般不推荐在生产环境中使用.</p>
<p>当进行汇总数据操作时,可以通过改变查询方式,来过滤掉被删除的数据<br>只有相同分区内的数据才有可能被折叠.<br>其实,当我们修改或删除数据时,这些被修改的数据通常是在一个分区内的,所以不会产生影响.</p>
<p>2)数据写入顺序<br>CollapsingMergeTree对于写入数据的顺序有着严格要求,否则导致无法正常折叠.</p>
<p>如果数据的写入程序是单线程执行的,则能够较好地控制写入顺序.<br>如果需要处理的数据量很大,数据的写入程序通常是多线程执行的,那么此时就不能保障数据的写入顺序了.<br>在这种情况下,CollapsingMergeTree的工作机制就会出现问题.<br>但是可以通过VersionedCollapsingMergeTree的表引擎得到解决.</p>
<h4 id="VersionedCollapsingMergeTree表引擎"><a href="#VersionedCollapsingMergeTree表引擎" class="headerlink" title="VersionedCollapsingMergeTree表引擎"></a>VersionedCollapsingMergeTree表引擎</h4><p>上面提到CollapsingMergeTree表引擎对于数据写入乱序的情况下,不能够实现数据折叠的效果.<br>VersionedCollapsingMergeTree表引擎的作用与CollapsingMergeTree完全相同.<br>不同之处在于,VersionedCollapsingMergeTree对数据的写入顺序没有要求,在同一个分区内,任意顺序的数据都能够完成折叠操作.</p>
<p>VersionedCollapsingMergeTree使用version列来实现乱序情况下的数据折叠.</p>
<h5 id="建表语法-5"><a href="#建表语法-5" class="headerlink" title="建表语法"></a>建表语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">  name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">  name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">  ...</span><br><span class="line">) ENGINE <span class="operator">=</span> VersionedCollapsingMergeTree(sign, version)</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure>

<p>可以看出:该引擎除了需要指定一个sign标识之外,还需要指定一个UInt8类型的version版本号.</p>
<h4 id="GraphiteMergeTree表引擎"><a href="#GraphiteMergeTree表引擎" class="headerlink" title="GraphiteMergeTree表引擎"></a>GraphiteMergeTree表引擎</h4><p>该引擎用来对 Graphite数据进行&#39;瘦身&#39;及汇总.<br>对于想使用CH来存储Graphite数据的开发者来说可能有用.</p>
<p>如果不需要对Graphite数据做汇总,那么可以使用任意的CH表引擎.但若需要,那就采用 GraphiteMergeTree 引擎.<br>它能减少存储空间,同时能提高Graphite数据的查询效率.</p>
<h3 id="Log系列表引擎"><a href="#Log系列表引擎" class="headerlink" title="Log系列表引擎"></a>Log系列表引擎</h3><h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><p>Log系列表引擎功能相对简单,主要用于快速写入小表(1百万行左右的表),然后全部读出的场景.<br>即一次写入多次查询.</p>
<h4 id="Log系列表引擎的特点"><a href="#Log系列表引擎的特点" class="headerlink" title="Log系列表引擎的特点"></a>Log系列表引擎的特点</h4><h5 id="共性特点"><a href="#共性特点" class="headerlink" title="共性特点"></a>共性特点</h5><ol>
<li>数据存储在磁盘上</li>
<li>当写数据时,将数据追加到文件的末尾</li>
<li>不支持并发读写,当向表中写入数据时,针对这张表的查询会被阻塞,直至写入动作结束</li>
<li>不支持索引</li>
<li>不支持原子写:如果某些操作(异常的服务器关闭)中断了写操作,则可能会获得带有损坏数据的表</li>
<li>不支持ALTER操作(这些操作会修改表设置或数据,比如delete/update等等)</li>
</ol>
<h5 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h5><ol>
<li>TinyLog是Log系列引擎中功能简单/性能较低的引擎.<br>它的存储结构由数据文件和元数据两部分组成.<br>其中,数据文件是按列独立存储的,也就是说每一个列字段都对应一个文件.<br>除此之外,TinyLog不支持并发数据读取.</li>
<li>StripLog支持并发读取数据文件,当读取数据时,ClickHouse会使用多线程进行读取,每个线程处理一个单独的数据块.<br>另外,StripLog将所有列数据存储在同一个文件中,减少了文件的使用数量.</li>
<li>Log支持并发读取数据文件,当读取数据时,ClickHouse会使用多线程进行读取,每个线程处理一个单独的数据块.<br>Log引擎会将每个列数据单独存储在一个独立文件中.</li>
</ol>
<h4 id="TinyLog表引擎使用"><a href="#TinyLog表引擎使用" class="headerlink" title="TinyLog表引擎使用"></a>TinyLog表引擎使用</h4><p>该引擎适用于一次写入,多次读取的场景.<br>对于处理小批数据的中间表可以使用该引擎.<br>值得注意的是,使用大量的小表存储数据,性能会很低.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp_tinylog (</span><br><span class="line">  emp_id UInt16 COMMENT <span class="string">&#x27;员工id&#x27;</span>,</span><br><span class="line">  name String COMMENT <span class="string">&#x27;员工姓名&#x27;</span>,</span><br><span class="line">  work_place String COMMENT <span class="string">&#x27;工作地点&#x27;</span>,</span><br><span class="line">  age UInt8 COMMENT <span class="string">&#x27;员工年龄&#x27;</span>,</span><br><span class="line">  depart String COMMENT <span class="string">&#x27;部门&#x27;</span>,</span><br><span class="line">  salary Decimal32(<span class="number">2</span>) COMMENT <span class="string">&#x27;工资&#x27;</span></span><br><span class="line">)ENGINE<span class="operator">=</span>TinyLog();</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_tinylog <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">20000</span>),(<span class="number">2</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;人事部&#x27;</span>,<span class="number">10000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_tinylog <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">33</span>,<span class="string">&#x27;财务部&#x27;</span>,<span class="number">50000</span>),(<span class="number">4</span>,<span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;杭州&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;销售事部&#x27;</span>,<span class="number">50000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp_tinylog;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部   │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部   │  <span class="number">10000</span> │</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部   │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br></pre></td></tr></table></figure>

<h5 id="数据目录结构-1"><a href="#数据目录结构-1" class="headerlink" title="数据目录结构"></a>数据目录结构</h5><p>进入默认数据存储目录,查看底层数据存储形式,可以看出TinyLog引擎表每一列都对应的文件.<br>ll /var/lib/clickhouse/data/default/emp_tinylog</p>
<img src="/images/flgl198.png" style="margin-left: 0px; padding-bottom: 10px;">

<h6 id="查看sizes-json数据"><a href="#查看sizes-json数据" class="headerlink" title="查看sizes.json数据"></a>查看sizes.json数据</h6><p>在sizes.json文件内使用JSON格式记录了每个.bin文件内对应的数据大小的信息.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;clickhouse&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;age%2Ebin&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="string">&quot;56&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;depart%2Ebin&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="string">&quot;97&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;emp_id%2Ebin&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="string">&quot;60&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;name%2Ebin&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="string">&quot;70&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;salary%2Ebin&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="string">&quot;68&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;work_place%2Ebin&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="string">&quot;80&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们执行ALTER操作时会报错,说明该表引擎不支持ALTER操作.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 以下操作会报错:</span></span><br><span class="line"><span class="comment">-- Code: 48. DB::Exception: Received from localhost:9000. DB::Exception: Table engine TinyLog doesn&#x27;t support mutations. (NOT_IMPLEMENTED)</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp_tinylog <span class="keyword">DELETE</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp_tinylog UPDATE age <span class="operator">=</span> <span class="number">30</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<h4 id="StripLog表引擎使用"><a href="#StripLog表引擎使用" class="headerlink" title="StripLog表引擎使用"></a>StripLog表引擎使用</h4><p>相比TinyLog而言,StripeLog拥有更高的查询性能(拥有.mrk标记文件,支持并行查询),同时其使用了更少的文件描述符(所有数据使用同一个文件保存).</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp_stripelog (</span><br><span class="line">  emp_id UInt16 COMMENT <span class="string">&#x27;员工id&#x27;</span>,</span><br><span class="line">  name String COMMENT <span class="string">&#x27;员工姓名&#x27;</span>,</span><br><span class="line">  work_place String COMMENT <span class="string">&#x27;工作地点&#x27;</span>,</span><br><span class="line">  age UInt8 COMMENT <span class="string">&#x27;员工年龄&#x27;</span>,</span><br><span class="line">  depart String COMMENT <span class="string">&#x27;部门&#x27;</span>,</span><br><span class="line">  salary Decimal32(<span class="number">2</span>) COMMENT <span class="string">&#x27;工资&#x27;</span></span><br><span class="line">)ENGINE<span class="operator">=</span>StripeLog;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据  </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_stripelog <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">20000</span>),(<span class="number">2</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;人事部&#x27;</span>,<span class="number">10000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_stripelog <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">33</span>,<span class="string">&#x27;财务部&#x27;</span>,<span class="number">50000</span>),(<span class="number">4</span>,<span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;杭州&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;销售事部&#x27;</span>,<span class="number">50000</span>);</span><br><span class="line"><span class="comment">-- 查询数据</span></span><br><span class="line"><span class="comment">-- 由于是分两次插入数据,所以查询时会有两个数据块</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_stripelog;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart─┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部 │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部 │  <span class="number">10000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴────────┴────────┘</span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部   │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br></pre></td></tr></table></figure>

<h5 id="数据目录结构-2"><a href="#数据目录结构-2" class="headerlink" title="数据目录结构"></a>数据目录结构</h5><p>进入默认数据存储目录,查看底层数据存储形式.<br>ll /var/lib/clickhouse/data/default/emp_stripelog</p>
<img src="/images/flgl201.png" style="margin-left: 0px; padding-bottom: 10px;">

<p>可以看出StripeLog表引擎对应的存储结构包括三个文件:</p>
<ol>
<li>data.bin<br>数据文件,所有的列字段使用同一个文件保存,它们的数据都会被写入data.bin.</li>
<li>index.mrk<br>数据标记,保存了数据在data.bin文件中的位置信息(每个插入数据块对应列的offset).<br>利用数据标记能够使用多个线程,以并行的方式读取data.bin内的压缩数据块,从而提升数据查询的性能.</li>
<li>sizes.json<br>元数据文件,记录了data.bin和index.mrk大小的信息.</li>
</ol>
<h5 id="注意点-4"><a href="#注意点-4" class="headerlink" title="注意点"></a>注意点</h5><p>StripeLog引擎将所有数据都存储在了一个文件中,对于每次的INSERT操作,ClickHouse会将数据块追加到表文件的末尾.<br>StripeLog引擎同样不支持ALTER UPDATE 和ALTER DELETE 操作.</p>
<h4 id="Log表引擎使用"><a href="#Log表引擎使用" class="headerlink" title="Log表引擎使用"></a>Log表引擎使用</h4><p>Log引擎表适用于临时数据,一次性写入/测试场景.<br>Log引擎结合了TinyLog表引擎和StripeLog表引擎的长处,是Log系列引擎中性能最高的表引擎.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp_log (</span><br><span class="line">  emp_id UInt16 COMMENT <span class="string">&#x27;员工id&#x27;</span>,</span><br><span class="line">  name String COMMENT <span class="string">&#x27;员工姓名&#x27;</span>,</span><br><span class="line">  work_place String COMMENT <span class="string">&#x27;工作地点&#x27;</span>,</span><br><span class="line">  age UInt8 COMMENT <span class="string">&#x27;员工年龄&#x27;</span>,</span><br><span class="line">  depart String COMMENT <span class="string">&#x27;部门&#x27;</span>,</span><br><span class="line">  salary Decimal32(<span class="number">2</span>) COMMENT <span class="string">&#x27;工资&#x27;</span></span><br><span class="line">)ENGINE<span class="operator">=</span>Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_log <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">25</span>,<span class="string">&#x27;技术部&#x27;</span>,<span class="number">20000</span>),(<span class="number">2</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>,<span class="number">26</span>,<span class="string">&#x27;人事部&#x27;</span>,<span class="number">10000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_log <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="number">33</span>,<span class="string">&#x27;财务部&#x27;</span>,<span class="number">50000</span>),(<span class="number">4</span>,<span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;杭州&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;销售事部&#x27;</span>,<span class="number">50000</span>);</span><br><span class="line"><span class="comment">-- 查询数据,</span></span><br><span class="line"><span class="comment">-- 由于是分两次插入数据,所以查询时会有两个数据块</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_log;</span><br><span class="line"></span><br><span class="line">┌─emp_id─┬─name─┬─work_place─┬─age─┬─depart───┬─salary─┐</span><br><span class="line">│      <span class="number">1</span> │ tom  │ 上海       │  <span class="number">25</span> │ 技术部   │  <span class="number">20000</span> │</span><br><span class="line">│      <span class="number">2</span> │ jack │ 上海       │  <span class="number">26</span> │ 人事部   │  <span class="number">10000</span> │</span><br><span class="line">│      <span class="number">3</span> │ bob  │ 北京       │  <span class="number">33</span> │ 财务部   │  <span class="number">50000</span> │</span><br><span class="line">│      <span class="number">4</span> │ tony │ 杭州       │  <span class="number">28</span> │ 销售事部 │  <span class="number">50000</span> │</span><br><span class="line">└────────┴──────┴────────────┴─────┴──────────┴────────┘</span><br></pre></td></tr></table></figure>

<h5 id="数据目录结构-3"><a href="#数据目录结构-3" class="headerlink" title="数据目录结构"></a>数据目录结构</h5><p>进入默认数据存储目录,查看底层数据存储形式.<br>ll /var/lib/clickhouse/data/default/emp_log</p>
<img src="/images/flgl202.png" style="margin-left: 0px; padding-bottom: 10px;">

<p>Log引擎的存储结构包含三部分:</p>
<ol>
<li>列.bin:数据文件,数据文件按列单独存储</li>
<li><code>__marks.mrk</code>:数据标记,统一保存了数据在各个.bin文件中的位置信息.<br>利用数据标记能够使用多个线程,以并行的方式读取.<br>.bin内的压缩数据块,从而提升数据查询的性能.</li>
<li>sizes.json:记录了.bin和__marks.mrk大小的信息</li>
</ol>
<h5 id="注意点-5"><a href="#注意点-5" class="headerlink" title="注意点"></a>注意点</h5><p>Log表引擎会将每一列都存在一个文件中,对于每一次的INSERT操作,都会对应一个数据块.</p>
<h3 id="外部集成表引擎"><a href="#外部集成表引擎" class="headerlink" title="外部集成表引擎"></a>外部集成表引擎</h3><p>ClickHouse提供了许多与外部系统集成的方法,包括一些表引擎.<br>这些表引擎与其他类型的表引擎类似,可以用于将外部数据导入到ClickHouse中,或者在ClickHouse中直接操作外部数据源.</p>
<p>例如直接读取HDFS的文件或者MySQL数据库的表.<br>这些表引擎只负责元数据管理和数据查询,而它们自身通常并不负责数据的写入,数据文件直接由外部系统提供.<br>目前ClickHouse提供了下面的外部集成表引擎:</p>
<ol>
<li>ODBC:通过指定odbc连接读取数据源</li>
<li>JDBC:通过指定jdbc连接读取数据源.</li>
<li>MySQL:将MySQL作为数据存储,直接查询其数据</li>
<li>HDFS:直接读取HDFS上的特定格式的数据文件.</li>
<li>Kafka:将Kafka数据导入ClickHouse</li>
<li>RabbitMQ:与Kafka类似</li>
</ol>
<h4 id="HDFS-2-6-5"><a href="#HDFS-2-6-5" class="headerlink" title="HDFS(2.6.5)"></a>HDFS(2.6.5)</h4><p>提供了与 Apache Hadoop 生态系统的集成,允许通过 ClickHouse 管理 HDFS 上的数据.<br>类似于 文件 和 URL 引擎,但提供了 Hadoop 的特定功能.</p>
<p>HDFS表引擎两种使用方式:</p>
<ol>
<li>即负责读文件也负责写文件</li>
<li>只负责读文件,文件写入工作则由外部系统完成</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENGINE &#x3D; HDFS(URI, format)</span><br></pre></td></tr></table></figure>

<h5 id="参数说明-1"><a href="#参数说明-1" class="headerlink" title="参数说明"></a>参数说明</h5><p><code>URI</code><br>HDFS 中整个文件的 URI.</p>
<p><code>format</code><br>指定一种可用的文件格式(指ClickHouse支持的文件格式,常见有CSV/TSV/JSON等).<br>执行 SELECT 查询时,格式必须支持输入,以及执行 INSERT 查询时,格式必须支持输出.<br>可以在 格式 章节查看可用的格式.<br>路径部分 URI 可能包含 glob 通配符.<br>在这种情况下,表将是只读的.</p>
<p>只负责读文件,文件写入工作则由外部系统完成.<br>这种形式类似于hive的外挂表,由其它系统直接将文件直接写入HDFS,通过参数hdfs_uri和format与HDFS的文件路径/文件格式建立映射.<br>其中hdfs_uri支持以下几种常见的配置方法:</p>
<ol>
<li>绝对路径:会指定路径上的单个文件,例如<code>hdfs://mycluster/1.txt</code></li>
<li>*通配符:匹配所有字符,例如<code>hdfs://mycluster/*</code>,会读取hdfs://mycluster/路径下的所有文件</li>
<li>?通配符:匹配单个字符,例如<code>hdfs://mycluster/test_?.txt</code>,会匹配所有test_?.txt的文件,?代表任意字符</li>
<li>{M…N}数字区间:匹配指定数字的文件,例如<code>hdfs://mycluster/test_&#123;1…3&#125;.txt</code>,会读取hdfs://mycluster/路径下的文件test_1.txt,test_2.txt,test_3.txt</li>
</ol>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><p>创建ClickHouse存储目录.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -mkdir &#x2F;clickhouse</span><br><span class="line"># 给目录授权</span><br><span class="line">hdfs dfs -chown clickhouse:clickhouse &#x2F;clickhouse</span><br></pre></td></tr></table></figure>

<p>创建 hdfs_engine_table 表,在HDFS上查看.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 创建表,hdfs_engine_table这个目录是不能提前创建的</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hdfs_engine_table (name String, <span class="keyword">value</span> UInt32) ENGINE<span class="operator">=</span>HDFS(<span class="string">&#x27;hdfs://xxx:8020/clickhouse/hdfs_engine_table&#x27;</span>, <span class="string">&#x27;TSV&#x27;</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hdfs_engine_table (name String, <span class="keyword">value</span> UInt32) ENGINE<span class="operator">=</span>HDFS(<span class="string">&#x27;hdfs://mycluster/clickhouse/hdfs_engine_table&#x27;</span>, <span class="string">&#x27;TSV&#x27;</span>);</span><br><span class="line"></span><br><span class="line"># 添加数据</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> hdfs_engine_table <span class="keyword">VALUES</span> (<span class="string">&#x27;one&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;two&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;three&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> hdfs_engine_table;</span><br></pre></td></tr></table></figure>

<img src="/images/flgl113.png" style="margin-left: 0px; padding-bottom: 10px;">

<h4 id="Hive-2-1-1"><a href="#Hive-2-1-1" class="headerlink" title="Hive(2.1.1)"></a>Hive(2.1.1)</h4><h5 id="建表语法-6"><a href="#建表语法-6" class="headerlink" title="建表语法"></a>建表语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">  name1 [type1] [ALIAS expr1],</span><br><span class="line">  name2 [type2] [ALIAS expr2],</span><br><span class="line">  ...</span><br><span class="line">) ENGINE <span class="operator">=</span> Hive(<span class="string">&#x27;thrift://172.18.250.93:9083&#x27;</span>, <span class="string">&#x27;database&#x27;</span>, <span class="string">&#x27;table&#x27;</span>);</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr</span><br></pre></td></tr></table></figure>

<h5 id="参数说明-2"><a href="#参数说明-2" class="headerlink" title="参数说明"></a>参数说明</h5><p><code>thrift://host:port</code><br>Hive Metastore 地址</p>
<p><code>database</code><br>远程数据库名.</p>
<p><code>table</code><br>远程数据表名.</p>
<p>使用HDFS文件系统的本地缓存,配置(/etc/clickhouse-server/config.xml)如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">local_cache_for_remote_fs</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">enable</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enable</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root_dir</span>&gt;</span>local_cache<span class="tag">&lt;/<span class="name">root_dir</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">limit_size</span>&gt;</span>559096952<span class="tag">&lt;/<span class="name">limit_size</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bytes_read_before_flush</span>&gt;</span>1048576<span class="tag">&lt;/<span class="name">bytes_read_before_flush</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">local_cache_for_remote_fs</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>enable</code>: 开启后,ClickHouse将为HDFS (远程文件系统)维护本地缓存.<br><code>root_dir</code>: 必需的,用于存储远程文件系统的本地缓存文件的根目录.<br><code>limit_size</code>: 必需的,本地缓存文件的最大大小(单位为字节).<br><code>bytes_read_before_flush</code>: 从远程文件系统下载文件时,刷新到本地文件系统前的控制字节数.缺省值为1MB.</p>
<p>当ClickHouse为远程文件系统启用了本地缓存时,用户仍然可以选择不使用缓存,并在查询中设置<br>use_local_cache_for_remote_fs = 0,<br>use_local_cache_for_remote_fs 默认为 false.</p>
<h5 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h5><p>在 Hive 中建表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test`.`test_orc`(</span><br><span class="line">  `f_tinyint` tinyint, </span><br><span class="line">  `f_smallint` <span class="type">smallint</span>, </span><br><span class="line">  `f_int` <span class="type">int</span>, </span><br><span class="line">  `f_integer` <span class="type">int</span>, </span><br><span class="line">  `f_bigint` <span class="type">bigint</span>, </span><br><span class="line">  `f_float` <span class="type">float</span>, </span><br><span class="line">  `f_double` <span class="keyword">double</span>, </span><br><span class="line">  `f_decimal` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">0</span>), </span><br><span class="line">  `f_timestamp` <span class="type">timestamp</span>, </span><br><span class="line">  `f_date` <span class="type">date</span>, </span><br><span class="line">  `f_string` string, </span><br><span class="line">  `f_varchar` <span class="type">varchar</span>(<span class="number">100</span>), </span><br><span class="line">  `f_bool` <span class="type">boolean</span>, </span><br><span class="line">  `f_binary` <span class="type">binary</span>, </span><br><span class="line">  `f_array_int` <span class="keyword">array</span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span>, </span><br><span class="line">  `f_array_string` <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span>, </span><br><span class="line">  `f_array_float` <span class="keyword">array</span><span class="operator">&lt;</span><span class="type">float</span><span class="operator">&gt;</span>, </span><br><span class="line">  `f_array_array_int` <span class="keyword">array</span><span class="operator">&lt;</span><span class="keyword">array</span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;&gt;</span>, </span><br><span class="line">  `f_array_array_string` <span class="keyword">array</span><span class="operator">&lt;</span><span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;&gt;</span>, </span><br><span class="line">  `f_array_array_float` <span class="keyword">array</span><span class="operator">&lt;</span><span class="keyword">array</span><span class="operator">&lt;</span><span class="type">float</span><span class="operator">&gt;&gt;</span>)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`<span class="keyword">day</span>` string)</span><br><span class="line"><span class="type">ROW</span> FORMAT SERDE </span><br><span class="line">  <span class="string">&#x27;org.apache.hadoop.hive.ql.io.orc.OrcSerde&#x27;</span> </span><br><span class="line">STORED <span class="keyword">AS</span> INPUTFORMAT </span><br><span class="line">  <span class="string">&#x27;org.apache.hadoop.hive.ql.io.orc.OrcInputFormat&#x27;</span> </span><br><span class="line">OUTPUTFORMAT </span><br><span class="line">  <span class="string">&#x27;org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat&#x27;</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test.test_orc <span class="keyword">partition</span>(<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;2021-09-18&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6.11</span>, <span class="number">7.22</span>, <span class="number">8.333</span>, <span class="built_in">current_timestamp</span>(), <span class="built_in">current_date</span>(), <span class="string">&#x27;hello world&#x27;</span>, <span class="string">&#x27;hello world&#x27;</span>, <span class="literal">true</span>, <span class="string">&#x27;hello world&#x27;</span>, <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), <span class="keyword">array</span>(<span class="string">&#x27;hello world&#x27;</span>, <span class="string">&#x27;hello world&#x27;</span>), <span class="keyword">array</span>(<span class="type">float</span>(<span class="number">1.1</span>), <span class="type">float</span>(<span class="number">1.2</span>)), <span class="keyword">array</span>(<span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>), <span class="keyword">array</span>(<span class="number">3</span>, <span class="number">4</span>)), <span class="keyword">array</span>(<span class="keyword">array</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>)), <span class="keyword">array</span>(<span class="keyword">array</span>(<span class="type">float</span>(<span class="number">1.11</span>), <span class="type">float</span>(<span class="number">2.22</span>)), <span class="keyword">array</span>(<span class="type">float</span>(<span class="number">3.33</span>), <span class="type">float</span>(<span class="number">4.44</span>)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.test_orc;</span><br></pre></td></tr></table></figure>

<p>在 ClickHouse 中建表,ClickHouse中的表,从上面创建的Hive表中获取数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test.test_orc</span><br><span class="line">(</span><br><span class="line">    `f_tinyint` Int8,</span><br><span class="line">    `f_smallint` Int16,</span><br><span class="line">    `f_int` Int32,</span><br><span class="line">    `f_integer` Int32,</span><br><span class="line">    `f_bigint` Int64,</span><br><span class="line">    `f_float` Float32,</span><br><span class="line">    `f_double` Float64,</span><br><span class="line">    `f_decimal` Float64,</span><br><span class="line">    `f_timestamp` DateTime,</span><br><span class="line">    `f_date` <span class="type">Date</span>,</span><br><span class="line">    `f_string` String,</span><br><span class="line">    `f_varchar` String,</span><br><span class="line">    `f_bool` Bool,</span><br><span class="line">    `f_binary` String,</span><br><span class="line">    `f_array_int` <span class="keyword">Array</span>(Int32),</span><br><span class="line">    `f_array_string` <span class="keyword">Array</span>(String),</span><br><span class="line">    `f_array_float` <span class="keyword">Array</span>(Float32),</span><br><span class="line">    `f_array_array_int` <span class="keyword">Array</span>(<span class="keyword">Array</span>(Int32)),</span><br><span class="line">    `f_array_array_string` <span class="keyword">Array</span>(<span class="keyword">Array</span>(String)),</span><br><span class="line">    `f_array_array_float` <span class="keyword">Array</span>(<span class="keyword">Array</span>(Float32)),</span><br><span class="line">    `<span class="keyword">day</span>` String</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> Hive(<span class="string">&#x27;thrift://172.18.250.93:9083&#x27;</span>, <span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;test_orc&#x27;</span>)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">day</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查询</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test.test_orc settings input_format_orc_allow_missing_columns <span class="operator">=</span> <span class="number">1</span>\G;</span><br></pre></td></tr></table></figure>

<h4 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">  name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1] [TTL expr1],</span><br><span class="line">  name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2] [TTL expr2],</span><br><span class="line">  ...</span><br><span class="line">) ENGINE <span class="operator">=</span> MySQL(<span class="string">&#x27;host:port&#x27;</span>, <span class="string">&#x27;database&#x27;</span>, <span class="string">&#x27;table&#x27;</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;password&#x27;</span>[, replace_query, <span class="string">&#x27;on_duplicate_clause&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h5 id="参数说明-3"><a href="#参数说明-3" class="headerlink" title="参数说明"></a>参数说明</h5><p><code>host:port</code><br>MySQL 服务器地址.</p>
<p><code>database</code><br>数据库的名称.</p>
<p><code>table</code><br>表名称.</p>
<p><code>user</code><br>数据库用户.</p>
<p><code>password</code><br>用户密码.</p>
<p><code>replace_query</code><br>将 INSERT INTO 查询是否替换为 REPLACE INTO 的标志.<br>如果 replace_query=1,则替换查询.</p>
<p><code>on_duplicate_clause</code><br>将 ON DUPLICATE KEY UPDATE - &#39;on_duplicate_clause&#39; 表达式添加到 INSERT 查询语句中.<br>例如:impression = VALUES(impression) + impression.<br>如果需要指定 &#39;on_duplicate_clause&#39;,则需要设置 replace_query=0.<br>如果同时设置 replace_query = 1 和 &#39;on_duplicate_clause&#39;,则会抛出异常.</p>
<h5 id="注意点-6"><a href="#注意点-6" class="headerlink" title="注意点"></a>注意点</h5><p>对于MySQL表引擎,不支持UPDATE和DELETE操作,比如执行下面命令时,会报错:<br>DB::Exception: Mutations are not supported by storage MySQL.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 执行更新</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> mysql_engine_table UPDATE name <span class="operator">=</span> <span class="string">&#x27;hanmeimei&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 执行删除</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> mysql_engine_table <span class="keyword">DELETE</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h5 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h5><p>MySQL操作<br>mysql -uroot -p -h oceanbase004</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 创建数据库</span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> ck_test003;</span><br><span class="line">USE ck_test003;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ck_test003`.`<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `account_no` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `phone` <span class="type">varchar</span>(<span class="number">128</span>) COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">255</span>) COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_bin;</span><br><span class="line"></span><br><span class="line"># 添加数据</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `ck_test003`.`<span class="keyword">user</span>`(`id`, `account_no`, `phone`, `username`, `create_time`) </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">35</span>, <span class="string">&#x27;00719526&#x27;</span>, <span class="string">&#x27;zhangsan&#x27;</span>, <span class="string">&#x27;2022-07-24 16:02:15&#x27;</span>);</span><br><span class="line"># 查看数据</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `ck_test003`.`<span class="keyword">user</span>`;</span><br></pre></td></tr></table></figure>

<p>在clickhouse中创建user表,设置引擎为mysql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> ck_mysql_test003;</span><br><span class="line"></span><br><span class="line"># 创建表,字段得跟mysql表一一对应</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ck_mysql_test003`.`<span class="keyword">user</span>`(</span><br><span class="line">  id UInt32 ,</span><br><span class="line">  account_no UInt32 ,</span><br><span class="line">  username String ,</span><br><span class="line">  phone String ,</span><br><span class="line">  create_time Datetime</span><br><span class="line">) </span><br><span class="line">ENGINE <span class="operator">=</span> MySQL(</span><br><span class="line"><span class="string">&#x27;oceanbase004:3306&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ck_test003&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;user&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;root&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"></span><br><span class="line"># 在clickhouse查询mysql数据</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `ck_mysql_test003`.`<span class="keyword">user</span>`;</span><br><span class="line"></span><br><span class="line"># 在clickhouse中添加数据</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `ck_mysql_test003`.`<span class="keyword">user</span>`(`id`, `account_no`, `phone`, `username`, `create_time`) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">39</span>, <span class="string">&#x27;007996&#x27;</span>, <span class="string">&#x27;lisi&#x27;</span>, <span class="string">&#x27;2022-07-25 17:02:15&#x27;</span>);</span><br><span class="line"></span><br><span class="line"># 查询</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `ck_mysql_test003`.`<span class="keyword">user</span>`;</span><br></pre></td></tr></table></figure>

<p>在mysql中查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `ck_test003`.`<span class="keyword">user</span>`;</span><br></pre></td></tr></table></figure>

<h4 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h4><p>JDBC表引擎不仅可以对接MySQL数据库,还能够与PostgreSQL等数据库.<br>为了实现JDBC连接,ClickHouse使用了<code>clickhouse-jdbc-bridge</code>的查询代理服务.</p>
<p>首先我们需要下载clickhouse-jdbc-bridge,然后按照ClickHouse的github中的步骤进行编译,编译完成之后会有一个<code>clickhouse-jdbc-bridge-1.0.jar</code>的jar文件.<br>除了需要该文件之外,还需要JDBC的驱动文件,本文使用的是MySQL,所以还需要下载MySQL驱动包.<br>将MySQL的驱动包和clickhouse-jdbc-bridge-1.0.jar文件放在了/opt/xxx路径下,执行如下命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar clickhouse-jdbc-bridge-1.0.jar --driver-path . --listen-host localhost</span><br></pre></td></tr></table></figure>
<p>其中<code>--driver-path</code>是MySQL驱动的jar所在的路径.<br><code>listen-host</code>是代理服务绑定的主机,默认情况下,绑定的端口是:9019.</p>
<p>然后我们再配置/etc/clickhouse-server/config.xml,在文件中添加如下配置,然后重启服务.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jdbc_bridge</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">host</span>&gt;</span>cdh04<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span>&gt;</span>9019<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jdbc_bridge</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">  name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">  name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">  ...</span><br><span class="line">) ENGINE <span class="operator">=</span> Kafka()</span><br><span class="line">SETTINGS</span><br><span class="line">  kafka_broker_list <span class="operator">=</span> <span class="string">&#x27;host:port&#x27;</span>,</span><br><span class="line">  kafka_topic_list <span class="operator">=</span> <span class="string">&#x27;topic1,topic2,...&#x27;</span>,</span><br><span class="line">  kafka_group_name <span class="operator">=</span> <span class="string">&#x27;group_name&#x27;</span>,</span><br><span class="line">  kafka_format <span class="operator">=</span> <span class="string">&#x27;data_format&#x27;</span>[,]</span><br><span class="line">  [kafka_row_delimiter <span class="operator">=</span> <span class="string">&#x27;delimiter_symbol&#x27;</span>,]</span><br><span class="line">  [kafka_schema <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>,]</span><br><span class="line">  [kafka_num_consumers <span class="operator">=</span> N,]</span><br><span class="line">  [kafka_max_block_size <span class="operator">=</span> <span class="number">0</span>,]</span><br><span class="line">  [kafka_skip_broken_messages <span class="operator">=</span> N,]</span><br><span class="line">  [kafka_commit_every_batch <span class="operator">=</span> <span class="number">0</span>,]</span><br><span class="line">  [kafka_thread_per_consumer <span class="operator">=</span> <span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<h5 id="参数说明-4"><a href="#参数说明-4" class="headerlink" title="参数说明"></a>参数说明</h5><p><code>kafka_broker_list</code><br>逗号分隔的brokers地址 (localhost:9092).</p>
<p><code>kafka_topic_list</code><br>Kafka 主题列表,多个主题用逗号分隔.</p>
<p><code>kafka_group_name</code><br>消费者组.<br>如果不希望消息在集群中重复,请在每个分片中使用相同的组名.</p>
<p><code>kafka_format</code><br>消息体格式.<br>使用与 SQL 部分的 FORMAT 函数相同表示方法,比如JSONEachRow/JSON/CSV等等</p>
<p><code>kafka_row_delimiter</code><br>每个消息体(记录)之间的分隔符.</p>
<p><code>kafka_schema</code><br>如果解析格式需要一个 schema 时,此参数必填.</p>
<p><code>kafka_num_consumers</code><br>单个表的消费者数量.<br>默认值1,如果一个消费者的吞吐量不足,则指定更多的消费者.<br>消费者的总数不应该超过 topic 中分区的数量,因为每个分区只能分配一个消费者.</p>
<h5 id="注意点-7"><a href="#注意点-7" class="headerlink" title="注意点"></a>注意点</h5><p>当我们一旦查询完毕之后,ClickHouse会删除表内的数据,其实Kafka表引擎只是一个数据管道,我们可以通过物化视图的方式访问Kafka中的数据.</p>
<ol>
<li>首先创建一张Kafka表引擎的表,用于从Kafka中读取数据</li>
<li>然后再创建一张普通表引擎的表,比如MergeTree,面向终端用户使用</li>
<li>最后创建物化视图,用于将Kafka引擎表实时同步到终端用户所使用的表中</li>
</ol>
<h5 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h5><p>在kafka中添加数据.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除topic</span></span><br><span class="line">kafka-topics.sh --delete --topic clickhouse --zookeeper oceanbase004:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建topic</span></span><br><span class="line">kafka-topics.sh --create --topic clickhouse --zookeeper oceanbase004:2181 --partitions 1 --replication-factor 1 --config retention.ms=259200000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加数据(生产者),添加的数据字段要跟CH的字段对应</span></span><br><span class="line">kafka-console-producer.sh --broker-list oceanbase004:9092 --topic clickhouse</span><br><span class="line">&#123;&quot;id&quot;:1,&quot;createDate&quot;:&quot;2022-08-01&quot;,&quot;message&quot;:&quot;cliclhouse test1&quot;&#125;</span><br><span class="line">&#123;&quot;id&quot;:2,&quot;createDate&quot;:&quot;2022-08-02&quot;,&quot;message&quot;:&quot;cliclhouse test2&quot;&#125;</span><br><span class="line">&#123;&quot;id&quot;:3,&quot;createDate&quot;:&quot;2022-08-03&quot;,&quot;message&quot;:&quot;cliclhouse test3&quot;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">消费</span></span><br><span class="line">kafka-console-consumer.sh --bootstrap-server oceanbase004:9092 --topic clickhouse --from-beginning</span><br></pre></td></tr></table></figure>

<p>在ClickHouse中添加表.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 登录,需要加上--stream_like_engine_allow_direct_select 1</span></span><br><span class="line">clickhouse-client -h c100 -d default -m -u default --password --stream_like_engine_allow_direct_select 1</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> queue (</span><br><span class="line">  id Int16,</span><br><span class="line">  createDate <span class="type">Date</span>,</span><br><span class="line">  message String</span><br><span class="line">) ENGINE <span class="operator">=</span> Kafka(<span class="string">&#x27;oceanbase004:9092&#x27;</span>, <span class="string">&#x27;clickhouse&#x27;</span>, <span class="string">&#x27;group1&#x27;</span>, <span class="string">&#x27;JSONEachRow&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> queue LIMIT <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>成功读取到了数据,并且是从earlast读取,而不是lartest.<br>再执行一次查询,发现数据消失了.<br>这是因为Kafka引擎只能读取消费的数据,读取完了以后就会删除数据,那么用这个引擎就没有意义了,数据只能查询一次.<br>其实Kafka引擎是需要结合物化视图一起使用的,物化视图不断将从kafka接收的消息数据写入到其他表引擎.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> kafkaMergeTree</span><br><span class="line">(</span><br><span class="line">    id Int16,</span><br><span class="line">    createDate <span class="type">Date</span>,</span><br><span class="line">    message String</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> kafkaview <span class="keyword">TO</span> kafkaMergeTree <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> queue ;</span><br></pre></td></tr></table></figure>

<p>创建好后,继续向kafka生产数据几条数据,之后查询<br>select * from kafkaMergeTree;</p>
<img src="/images/flgl116.png" style="margin-left: 0px; padding-bottom: 10px;">

<h5 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h5><p>查询Kafka引擎隐藏列.</p>
<p>生产数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 新建topic</span></span><br><span class="line">kafka-topics.sh --create --topic clickhouse2 --zookeeper oceanbase004:2181  --partitions 1 --replication-factor 1 --config retention.ms=259200000</span><br><span class="line"></span><br><span class="line">kafka-console-producer.sh --broker-list oceanbase004:9092 --topic clickhouse2</span><br><span class="line"></span><br><span class="line">&#123;&quot;id&quot;:1,&quot;createDate&quot;:&quot;2022-08-01&quot;,&quot;message&quot;:&quot;cliclhouse test1&quot;&#125;</span><br><span class="line">&#123;&quot;id&quot;:2,&quot;createDate&quot;:&quot;2022-08-02&quot;,&quot;message&quot;:&quot;cliclhouse test2&quot;&#125;</span><br><span class="line">&#123;&quot;id&quot;:3,&quot;createDate&quot;:&quot;2022-08-03&quot;,&quot;message&quot;:&quot;cliclhouse test3&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>clickhoouser操作.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> queue2 (</span><br><span class="line">  id Int16,</span><br><span class="line">  createDate <span class="type">Date</span>,</span><br><span class="line">  message String</span><br><span class="line">) ENGINE <span class="operator">=</span> Kafka(<span class="string">&#x27;oceanbase004:9092&#x27;</span>, <span class="string">&#x27;clickhouse2&#x27;</span>, <span class="string">&#x27;group1&#x27;</span>, <span class="string">&#x27;JSONEachRow&#x27;</span>);</span><br><span class="line"></span><br><span class="line">#查询</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,_topic,_key,_offset,_timestamp,_partition <span class="keyword">from</span> queue2;</span><br></pre></td></tr></table></figure>

<p>上方以_开头的是隐藏列,不包含在*之中</p>
<p><code>_topic</code> -- kafka主题.<br><code>_key</code> -- 消息的key.<br><code>_offset</code> -- 消息的偏移量.<br><code>_timestamp</code> -- 消息的时间戳.<br><code>_partition</code> -- 分区.</p>
<img src="/images/flgl115.png" style="margin-left: 0px; padding-bottom: 10px;">

<h3 id="其他特殊的表引擎"><a href="#其他特殊的表引擎" class="headerlink" title="其他特殊的表引擎"></a>其他特殊的表引擎</h3><h4 id="Memory表引擎"><a href="#Memory表引擎" class="headerlink" title="Memory表引擎"></a>Memory表引擎</h4><p>Memory表引擎直接将数据保存在内存中,数据既不会被压缩也不会被格式转换.<br>当ClickHouse服务重启的时候,Memory表内的数据会全部丢失.<br>一般在测试时使用.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_memory (</span><br><span class="line">  id UInt64,</span><br><span class="line">  name String</span><br><span class="line">) ENGINE <span class="operator">=</span> Memory();</span><br></pre></td></tr></table></figure>

<h4 id="Distributed表引擎"><a href="#Distributed表引擎" class="headerlink" title="Distributed表引擎"></a>Distributed表引擎</h4><p>Distributed表引擎是分布式表的代名词,它自身不存储任何数据,数据都分散存储在某一个分片上,能够自动路由数据至集群中的各个节点,所以Distributed表引擎需要和其他数据表引擎一起协同工作.<br>一张分布式表底层会对应多个本地分片数据表,由具体的分片表存储数据,分布式表与分片表是一对多的关系</p>
<p>Distributed表引擎的定义形式如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Distributed(cluster_name, database_name, table_name[, sharding_key])</span><br></pre></td></tr></table></figure>

<p>各个参数的含义分别如下:</p>
<ol>
<li>cluster_name:集群名称,与集群配置中的自定义名称相对应.</li>
<li>database_name:数据库名称</li>
<li>table_name:表名称</li>
<li>sharding_key:可选的,用于分片的key值,在数据写入的过程中,分布式表会依据分片key的规则,将数据分布到各个节点的本地表.</li>
</ol>
<p>创建分布式表是读时检查的机制,也就是说对创建分布式表和本地表的顺序并没有强制要求.<br>在上面的语句中使用了ON CLUSTER分布式DDL,这意味着在集群的每个分片节点上,都会创建一张Distributed表,这样便可以从其中任意一端发起对所有分片的读/写请求.</p>
<h2 id="ClickHouse常见问题"><a href="#ClickHouse常见问题" class="headerlink" title="ClickHouse常见问题"></a>ClickHouse常见问题</h2><h3 id="重启-ClickHouse-服务的时间会比较长"><a href="#重启-ClickHouse-服务的时间会比较长" class="headerlink" title="重启 ClickHouse 服务的时间会比较长"></a>重启 ClickHouse 服务的时间会比较长</h3><p>主要是由于该节点数据分片过多导致加载缓慢,耐心等待即可.</p>
<h3 id="数据插入报错-too-many-parts-exception"><a href="#数据插入报错-too-many-parts-exception" class="headerlink" title="数据插入报错 too many parts exception"></a>数据插入报错 <code>too many parts exception</code></h3><p>主要是由于数据插入过于频繁,导致数据分片在后台 merge 缓慢,ClickHouse 启动自我保护机制,拒绝数据继续插入.<br>此时可尝试增大插入数据的 batch_size (10 万) 并降低数据插入的频率(每秒 1 次)以缓解该问题.</p>
<h3 id="复制表变为只读"><a href="#复制表变为只读" class="headerlink" title="复制表变为只读"></a>复制表变为只读</h3><p>主要是由于 ClickHouse 无法连接 ZooKeeper 集群或 ZooKeeper 上该复制表的元数据丢失导致的,此时新数据无法插入该表.<br>若要解决该问题,首先要检查 ZooKeeper 的连接状况.<br>如果连接失败,则需进一步检查网络状态以及 ZooKeeper 的状态,连接恢复后,复制表就可以继续插入数据了.<br>如果连接正常而元数据丢失,此时可以将复制表转为非复制表然后再进行数据插入操作.</p>
<h3 id="执行-JOIN-操作时内存超限"><a href="#执行-JOIN-操作时内存超限" class="headerlink" title="执行 JOIN 操作时内存超限"></a>执行 JOIN 操作时内存超限</h3><p>可能是由于 JOIN 前后的两个子查询中没有添加明确的过滤条件导致的,也有可能是由于 JOIN 的数据本身就很大,无法全部加载到内存.<br>此时可以尝试增加过滤条件以减小数据量,或者适当修改配置文件中的内存限制,以装载更多的数据.</p>
<h2 id="ClickHouse问题排查方法"><a href="#ClickHouse问题排查方法" class="headerlink" title="ClickHouse问题排查方法"></a>ClickHouse问题排查方法</h2><ol>
<li>检查 ClickHouse 运行状态,确保服务正常运行.</li>
<li>检查 ClickHouse 错误日志文件,寻找问题根源.</li>
<li>检查系统日志文件 (/var/log/messages) 中与 ClickHouse 相关的记录,查看是否是系统操作导致 ClickHouse 异常.</li>
<li>对于未知问题或 BUG,可以到官方 GitHub 仓库的 issue 下寻求帮助,需提供完整的问题描述和错误日志信息.</li>
</ol>
<h2 id="直接写入的风险"><a href="#直接写入的风险" class="headerlink" title="直接写入的风险"></a>直接写入的风险</h2><p>用户写入 ClickHouse 一般有两种选择:分布式表(i.e. Distributed),MergeTree 表.</p>
<h3 id="写入分布式表"><a href="#写入分布式表" class="headerlink" title="写入分布式表"></a>写入分布式表</h3><p>数据写入分布式表时,它会将数据先放入本地磁盘的缓冲区,再异步分发给所有节点上的 MergeTree 表.<br>如果数据在同步给 MergeTree 里面之前这个节点宕机了,数据就可能会丢失.<br>此时如果在失败后再重试,数据就可能会写重.<br>因而,直接将数据写入用分布式表时,不太好保证数据准确性的和一致性.</p>
<p>当然这个分布式表还有其他问题,一般来说一个 ClickHouse 集群会配置多个 shard,每个 shard 都会建立 MergeTree 表和对应的分布式表.<br>如果直接把数据写入分布式表,数据就可能会分发给每个 shard.<br>假设有 N 个节点,每个节点每秒收到一个 INSERT Query,分发 N 次之后,一共就是每秒生成 NxN 个 part 目录.<br>集群 shard 数越多,分发产生的小文件也会越多,最后会导致你写入到 MergeTree 的 Part 的数会特别多,最后会拖垮整个文件的系统.</p>
<h3 id="写入-MergeTree-表"><a href="#写入-MergeTree-表" class="headerlink" title="写入 MergeTree 表"></a>写入 MergeTree 表</h3><p>直接写入 MergeTree 表可以解决数据分发的问题,但是依然抗不住高频写入.<br>如果业务方写入频次控制不好,仍然有可能导致 ClickHouse 后台合并的速度跟不上写入的速度,最后会使得文件系统压力过大.</p>
<p>所以一段时间内,我们禁止用户用 INSERT Query 把数据直接写入到 ClickHouse.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/clickhouse/" rel="tag"># clickhouse</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/09/08/clickhouse%E4%BB%8B%E7%BB%8D/" rel="prev" title="clickhouse介绍">
                  <i class="fa fa-chevron-left"></i> clickhouse介绍
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/09/13/flink%20connectors/" rel="next" title="flink connectors">
                  flink connectors <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">maoeryu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  





</body>
</html>
